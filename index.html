<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilha de Finanças Pessoais com IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script async defer src="https://apis.google.com/js/api.js" onload="window.gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="window.gisLoaded()"></script>
    <style>
        /* Estilos Gerais (incluindo Temas) */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; transition: background-color 0.3s, color 0.3s; }
        .card { background-color: white; border-radius: 0.75rem; border: 1px solid #e5e7eb; padding: 1.5rem; transition: background-color 0.3s, border-color 0.3s; }
        h1, .text-gray-800, .text-gray-900 { color: #111827 !important; }
        h2, h3, .text-gray-700 { color: #1f2937 !important; }
        p, label, .text-gray-600, .text-gray-500 { color: #4b5563 !important; }
        #auth-status { color: #6b7280 !important; }
        input, select { background-color: #f9fafb !important; border-color: #d1d5db !important; color: #111827 !important; color-scheme: light; }
        input::placeholder { color: #9ca3af; }
        .table-header { background-color: #f9fafb; }
        .responsive-table tbody, .responsive-table, .divide-y { border-color: #e5e7eb !important; }
        #google-auth-button { background-color: #ffffff; border-color: #d1d5db; color: #374151; }
        #google-auth-button:hover { background-color: #f9fafb; }
        #monthly-incomes-list .bg-gray-50 { background-color: #f9fafb !important; }
        .tab { color: #6b7280; cursor: pointer; padding: 0.5rem 0.25rem; border-bottom: 2px solid transparent; }
        .tab.active { border-bottom-color: #4f46e5; color: #4f46e5; font-weight: 600; }
        .mb-8.border-b { border-color: #e5e7eb; }
        body.dark { background-color: #111827; color: #d1d5db; }
        body.dark .card { background-color: #1f2937; border: 1px solid #374151; }
        body.dark h1, body.dark .text-gray-800, body.dark .text-gray-900 { color: #f9fafb !important; }
        body.dark h2, body.dark h3, body.dark .text-gray-700 { color: #e5e7eb !important; }
        body.dark p, body.dark label, body.dark .text-gray-600, body.dark .text-gray-500 { color: #d1d5db !important; }
        body.dark #auth-status { color: #9ca3af !important; }
        body.dark input, body.dark select { background-color: #374151 !important; border-color: #4b5563 !important; color: #f9fafb !important; color-scheme: dark; }
        body.dark input::placeholder { color: #9ca3af; }
        body.dark .table-header { background-color: #374151; }
        body.dark .responsive-table tbody, body.dark .responsive-table, body.dark .divide-y { border-color: #374151 !important; }
        body.dark #google-auth-button { background-color: #374151; border-color: #4b5563; color: #f9fafb; }
        body.dark #google-auth-button:hover { background-color: #4b5563; }
        body.dark #monthly-incomes-list .bg-gray-50 { background-color: #374151 !important; }
        #gemini-button:disabled, #save-data-button:disabled { cursor: not-allowed; opacity: 0.7; }

        /* Estilos do Modal de Edição */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all .3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { max-height: 90vh; overflow-y: auto; width: 90%; max-width: 600px; transform: translateY(-20px); transition: all .3s; }
        .modal-overlay.visible .modal-content { transform: translateY(0); }

        /* Estilos das Mini Dicas */
        .mini-tip { display: none; position: relative; background-color: #eef2ff; border-left: 4px solid #4f46e5; padding: 1rem; border-radius: 0.25rem; margin-top: 1.5rem; }
        body.dark .mini-tip { background-color: #312e81; border-color: #818cf8; }
        .mini-tip-close { position: absolute; top: 0.5rem; right: 0.5rem; background: none; border: none; font-size: 1.2rem; cursor: pointer; }
        
        /* Estilos Responsivos */
        @media (max-width: 767px) {
            .responsive-table thead { display: none; }
            .responsive-table tbody tr { display: block; border-radius: 0.5rem; margin-bottom: 1rem; padding: 1rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
            body.light .responsive-table tbody tr { border: 1px solid #e5e7eb; background-color: white;}
            body.dark .responsive-table tbody tr { border-color: #374151; background-color: #1f2937;}
            .responsive-table td { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0.25rem; text-align: right; }
            body.light .responsive-table td { border-bottom: 1px solid #f3f4f6; } body.dark .responsive-table td { border-bottom: 1px solid #374151; }
            .responsive-table td:last-child { border-bottom: none; }
            .responsive-table td::before { content: attr(data-label); font-weight: 600; margin-right: 1rem; text-align: left; }
            .responsive-table td .actions-cell { display: flex; gap: 1rem; justify-content: flex-end; align-items: center; width: 100%; height: 100%; }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-4 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Minhas Finanças</h1>
                <p class="text-gray-500 mt-1">Sua planilha e dashboard financeiro com salvamento no Google Drive.</p>
            </div>
            <div class="flex items-center gap-4 w-full sm:w-auto">
                 <div id="auth-status" class="text-sm text-gray-600 flex-grow"></div>
                 <button id="theme-toggle-button" class="p-2 rounded-md">
                     <svg id="theme-icon-sun" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                     <svg id="theme-icon-moon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                 </button>
                 <button id="google-auth-button" class="py-2 px-4 border rounded-md shadow-sm text-sm font-medium">Login</button>
                 <button id="save-data-button" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">Salvar</button>
            </div>
        </header>

        <div class="mb-8 border-b">
            <nav class="-mb-px flex space-x-2 sm:space-x-4" aria-label="Tabs">
                <a id="tab-despesas" class="tab active">Despesas</a>
                <a id="tab-reservas" class="tab">Reservas</a>
            </nav>
        </div>

        <div id="despesas-view">
            <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <div class="lg:col-span-3 space-y-6">
                    <div class="card">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Adicionar Nova Despesa</h2>
                        <form id="expense-form" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                            <div><label for="date" class="block text-sm font-medium">Data</label><input type="date" id="date" class="mt-1 block w-full rounded-md shadow-sm" required></div>
                            <div><label for="cost-type" class="block text-sm font-medium">Tipo</label><select id="cost-type" class="mt-1 block w-full rounded-md shadow-sm" required><option>Variável</option><option>Fixo</option></select></div>
                            <div><label for="category" class="block text-sm font-medium">Categoria</label><select id="category" class="mt-1 block w-full rounded-md shadow-sm" required><option>Moradia</option><option>Alimentação</option><option>Transporte</option><option>Lazer</option><option>Saúde</option><option>Vestuário</option><option>Educação</option><option>Outros</option></select></div>
                            <div><label for="payment-type" class="block text-sm font-medium">Pagamento</label><select id="payment-type" class="mt-1 block w-full rounded-md shadow-sm" required><option>Crédito</option><option>Débito</option><option>PIX</option></select></div>
                            <div class="sm:col-span-2 md:col-span-2"><label for="description" class="block text-sm font-medium">Onde foi (Descrição)</label><input type="text" id="description" class="mt-1 block w-full rounded-md shadow-sm" placeholder="Ex: Supermercado" required></div>
                            <div><label for="bank" class="block text-sm font-medium">Banco</label><select id="bank" class="mt-1 block w-full rounded-md shadow-sm" required><option>Nubank</option><option>Itaú</option><option>Bradesco</option><option>Santander</option><option>Banco do Brasil</option><option>Caixa</option><option>Inter</option><option>Outro</option></select></div>
                            <div><label for="amount" class="block text-sm font-medium">Valor (R$)</label><input type="number" step="0.01" id="amount" class="mt-1 block w-full rounded-md shadow-sm" placeholder="150,50" required></div>
                            <div class="sm:col-span-2 md:col-span-4 space-y-3 mt-2"><div class="flex items-center space-x-2"><input type="checkbox" id="is-recurring" class="h-4 w-4 text-indigo-600 border-gray-300 rounded"><label for="is-recurring" class="text-sm font-medium">Despesa Recorrente?</label></div><div id="recurring-options" class="hidden"><label for="recurrence-end-date" class="block text-sm font-medium">Repetir mensalmente até:</label><input type="date" id="recurrence-end-date" class="mt-1 block w-full rounded-md shadow-sm"></div></div>
                            <div class="sm:col-span-2 md:col-span-4"><button type="submit" class="w-full sm:w-auto mt-4 justify-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Adicionar Despesa</button></div>
                        </form>
                        <div id="tip-recurring" class="mini-tip">💡 <b>Dica:</b> Marque "Despesa Recorrente" para contas como aluguel ou assinaturas e defina uma data final. O app adicionará os gastos futuros automaticamente!<button onclick="dismissTip('tip-recurring')" class="mini-tip-close">&times;</button></div>
                    </div>
                    
                    <div class="card">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Histórico de Gastos</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                            <div><label for="filter-month" class="block text-sm font-medium">Filtrar por Mês</label><select id="filter-month" class="mt-1 block w-full rounded-md shadow-sm"></select></div>
                            <div><label for="filter-category" class="block text-sm font-medium">Filtrar por Categoria</label><select id="filter-category" class="mt-1 block w-full rounded-md shadow-sm"><option value="all">Todas</option><option>Moradia</option><option>Alimentação</option><option>Transporte</option><option>Lazer</option><option>Saúde</option><option>Vestuário</option><option>Educação</option><option>Outros</option></select></div>
                            <div><label for="filter-payment" class="block text-sm font-medium">Filtrar por Pagamento</label><select id="filter-payment" class="mt-1 block w-full rounded-md shadow-sm"><option value="all">Todos</option><option>Crédito</option><option>Débito</option><option>PIX</option></select></div>
                        </div>
                        <div class="overflow-x-auto"><table class="min-w-full responsive-table"><thead class="table-header"><tr><th class="px-6 py-3 text-left text-xs font-medium uppercase">Data</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Descrição</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Categoria</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Tipo</th><th class="px-6 py-3 text-right text-xs font-medium uppercase">Valor</th><th class="px-6 py-3 text-right text-xs font-medium uppercase">Ações</th></tr></thead><tbody id="expense-table-body"></tbody></table></div>
                    </div>
                </div>
    
                <div class="lg:col-span-2 space-y-6">
                    <div class="card"><h3 class="text-lg font-semibold text-gray-700 mb-4">Gerenciar Rendas Mensais</h3><form id="income-form" class="flex items-end gap-2 mb-4"><div class="flex-grow"><label for="income-month" class="block text-sm font-medium">Mês/Ano</label><input type="month" id="income-month" class="mt-1 block w-full rounded-md shadow-sm" required></div><div><label for="income-amount" class="block text-sm font-medium">Renda (R$)</label><input type="number" step="0.01" id="income-amount" class="mt-1 block w-full rounded-md shadow-sm" required placeholder="6000,00"></div><button type="submit" class="py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Salvar</button></form><div id="monthly-incomes-list" class="text-sm space-y-1"></div></div>
                    <div class="card"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold text-gray-700">Visão Geral</h3><select id="dashboard-month-filter" class="block w-48 rounded-md shadow-sm"></select></div><div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center"><div><h3 class="text-sm font-medium text-gray-500">Gasto Total</h3><p id="total-expenses" class="mt-1 text-2xl font-semibold text-red-500">R$ 0,00</p></div><div><h3 class="text-sm font-medium text-gray-500">Renda Comprometida</h3><p id="income-percentage" class="mt-1 text-2xl font-semibold text-yellow-500">0%</p></div><div><h3 class="text-sm font-medium text-gray-500">Saldo Restante</h3><p id="remaining-balance" class="mt-1 text-2xl font-semibold text-green-500">R$ 0,00</p></div></div></div>
                    <div class="card"><h3 class="text-lg font-semibold text-gray-700">Fixos vs. Variáveis</h3><canvas id="cost-type-chart" class="mt-4"></canvas></div>
                    <div class="card"><h3 class="text-lg font-semibold text-gray-700 mb-4">Gastos por Categoria</h3><select id="month-select" class="block w-full rounded-md shadow-sm mb-4"></select><canvas id="monthly-category-chart" class="mt-4"></canvas><div id="monthly-analysis-details" class="mt-4 text-sm space-y-1"></div></div>
                    <div class="card"><h3 class="text-lg font-semibold text-gray-700 mb-4">Análise com IA</h3><button id="gemini-button" class="w-full flex items-center justify-center py-2 px-3 border rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700">✨ Gerar Dicas com IA</button><div id="analysis-text" class="text-sm space-y-2 mt-4"><p>Faça login e salve seus dados para usar a IA.</p></div><div id="tip-ia" class="mini-tip">💡 <b>Dica:</b> Após adicionar alguns gastos, clique aqui para receber uma análise financeira personalizada e dicas para economizar!<button onclick="dismissTip('tip-ia')" class="mini-tip-close">&times;</button></div></div>
                </div>
            </main>
        </div>

        <div id="reservas-view" class="hidden">
            <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <div class="lg:col-span-3 space-y-6">
                    <div class="card"><h2 class="text-xl font-semibold text-gray-700 mb-4">Adicionar Nova Reserva</h2><form id="saving-form" class="grid grid-cols-1 sm:grid-cols-3 gap-4"><div><label for="saving-month" class="block text-sm font-medium">Mês/Ano</label><input type="month" id="saving-month" class="mt-1 block w-full rounded-md shadow-sm" required></div><div><label for="saving-type" class="block text-sm font-medium">Tipo</label><select id="saving-type" class="mt-1 block w-full rounded-md shadow-sm" required><option>Reserva de Emergência</option><option>Investimentos</option><option>Objetivos (Viagem, etc.)</option><option>Outros</option></select></div><div><label for="saving-amount" class="block text-sm font-medium">Valor (R$)</label><input type="number" step="0.01" id="saving-amount" class="mt-1 block w-full rounded-md shadow-sm" required placeholder="500,00"></div><div class="sm:col-span-3"><button type="submit" class="w-full sm:w-auto mt-4 justify-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Adicionar Reserva</button></div></form></div>
                    <div class="card">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Histórico de Reservas</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="filter-saving-month" class="block text-sm font-medium text-gray-600">Filtrar por Mês</label>
                                <select id="filter-saving-month" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm"></select>
                            </div>
                            <div>
                                <label for="filter-saving-type" class="block text-sm font-medium text-gray-600">Filtrar por Tipo</label>
                                <select id="filter-saving-type" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                    <option value="all">Todos os Tipos</option>
                                    <option>Reserva de Emergência</option>
                                    <option>Investimentos</option>
                                    <option>Objetivos (Viagem, etc.)</option>
                                    <option>Outros</option>
                                </select>
                            </div>
                        </div>
                        <div class="overflow-x-auto"><table class="min-w-full responsive-table"><thead class="table-header"><tr><th class="px-6 py-3 text-left text-xs font-medium uppercase">Mês</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Tipo</th><th class="px-6 py-3 text-right text-xs font-medium uppercase">Valor (R$)</th><th class="px-6 py-3"><span class="sr-only">Ações</span></th></tr></thead><tbody id="savings-table-body"></tbody></table></div>
                    </div>
                </div>
                <div class="lg:col-span-2 space-y-6">
                    <div class="card text-center"><h3 class="text-lg font-medium text-gray-500">Total Guardado</h3><p id="total-savings" class="mt-1 text-3xl sm:text-4xl font-bold text-green-500">R$ 0,00</p></div>
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-700">Total por Tipo de Reserva</h3>
                        <canvas id="savings-by-type-chart" class="mt-4"></canvas>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="edit-modal" class="modal-overlay">
        <div class="card modal-content">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Editar Despesa</h2>
            <form id="edit-expense-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <input type="hidden" id="edit-expense-id">
                <div><label for="edit-date" class="block text-sm font-medium">Data</label><input type="date" id="edit-date" class="mt-1 block w-full rounded-md shadow-sm" required></div>
                <div><label for="edit-cost-type" class="block text-sm font-medium">Tipo</label><select id="edit-cost-type" class="mt-1 block w-full rounded-md shadow-sm" required><option>Variável</option><option>Fixo</option></select></div>
                <div><label for="edit-category" class="block text-sm font-medium">Categoria</label><select id="edit-category" class="mt-1 block w-full rounded-md shadow-sm" required><option>Moradia</option><option>Alimentação</option><option>Transporte</option><option>Lazer</option><option>Saúde</option><option>Vestuário</option><option>Educação</option><option>Outros</option></select></div>
                <div><label for="edit-payment-type" class="block text-sm font-medium">Pagamento</label><select id="edit-payment-type" class="mt-1 block w-full rounded-md shadow-sm" required><option>Crédito</option><option>Débito</option><option>PIX</option></select></div>
                <div class="sm:col-span-2"><label for="edit-description" class="block text-sm font-medium">Descrição</label><input type="text" id="edit-description" class="mt-1 block w-full rounded-md shadow-sm" required></div>
                <div><label for="edit-bank" class="block text-sm font-medium">Banco</label><select id="edit-bank" class="mt-1 block w-full rounded-md shadow-sm" required><option>Nubank</option><option>Itaú</option><option>Bradesco</option><option>Santander</option><option>Banco do Brasil</option><option>Caixa</option><option>Inter</option><option>Outro</option></select></div>
                <div><label for="edit-amount" class="block text-sm font-medium">Valor (R$)</label><input type="number" step="0.01" id="edit-amount" class="mt-1 block w-full rounded-md shadow-sm" required></div>
                <div id="edit-recurring-options" class="sm:col-span-2 hidden">
                    <label for="edit-recurrence-scope" class="block text-sm font-medium">Aplicar alteração a:</label>
                    <select id="edit-recurrence-scope" class="mt-1 block w-full rounded-md shadow-sm">
                        <option value="single">Apenas esta despesa</option>
                        <option value="future">Esta e as futuras</option>
                        <option value="all">Todas as despesas da série</option>
                    </select>
                </div>
                <div class="sm:col-span-2 flex justify-end gap-4 mt-4">
                    <button type="button" id="cancel-edit-button" class="py-2 px-4 border rounded-md shadow-sm text-sm font-medium">Cancelar</button>
                    <button type="submit" class="py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- DADOS GLOBAIS ---
        let expenses = [];
        let monthlyIncomes = {};
        let savings = [];
        
        // --- GRÁFICOS (instâncias) ---
        let monthlyCategoryChart, costTypeChart, savingsByTypeChart;
        
        // --- CONFIGURAÇÃO GOOGLE API ---
        const CLIENT_ID = '164577357008-o68h1qr3h69ik5ot1531f1fvvrl40umr.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyALVa2RTydoXDNsJP6NmtTV6b7zYhFixY0'; // Lembre-se de usar sua própria chave
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const FILENAME = 'minhas_financas_dados.json';
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let driveFileId = null;

        // --- FUNÇÕES DE FORMATAÇÃO ---
        const formatCurrency = (value) => `R$ ${typeof value === 'number' ? value.toFixed(2).replace('.', ',') : '0,00'}`;
        const formatDate = (dateString) => { const [y, m, d] = dateString.split('-'); return `${d}/${m}/${y}`; };
        const formatMonthYear = (monthString) => {
            if (!monthString || !monthString.includes('-')) return '';
            const [year, month] = monthString.split('-');
            const date = new Date(year, parseInt(month) - 1);
            const formatted = date.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
            return formatted.charAt(0).toUpperCase() + formatted.slice(1);
        };
        
        // --- FUNÇÕES DE DADOS (CARREGAR/SALVAR) ---
        function loadDefaultData() {
            expenses = [{ id: Date.now(), recurrenceId: null, date: '2025-09-07', costType: 'Variável', type: 'Débito', description: 'Supermercado (Exemplo)', amount: 350.45, category: 'Alimentação', bank: 'Nubank' }];
            monthlyIncomes = { '2025-09': 6000 };
            savings = [ { id: Date.now() + 1, month: '2025-09', type: 'Reserva de Emergência', amount: 500 } ];
        }

        async function saveDataToDrive() {
            const saveDataButton = document.getElementById('save-data-button');
            saveDataButton.disabled = true;
            saveDataButton.textContent = 'Salvando...';
            const allData = { expenses, monthlyIncomes, savings, lastUpdated: new Date().toISOString() };
            const dataBlob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
            try {
                const formData = new FormData();
                let method, path;
                if (driveFileId) {
                    path = `/upload/drive/v3/files/${driveFileId}?uploadType=multipart`;
                    method = 'PATCH';
                    formData.append('metadata', new Blob([JSON.stringify({})], { type: 'application/json' }));
                } else {
                    path = '/upload/drive/v3/files?uploadType=multipart';
                    method = 'POST';
                    const metadata = { name: FILENAME, mimeType: 'application/json' };
                    formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                }
                formData.append('file', dataBlob);
                const response = await fetch(`https://www.googleapis.com${path}`, {
                    method: method,
                    headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}` },
                    body: formData
                });
                if (!response.ok) throw await response.json();
                const result = await response.json();
                driveFileId = result.id; 
                saveDataButton.textContent = 'Salvo!';
            } catch (err) {
                console.error("Erro ao salvar no Drive", err);
                saveDataButton.textContent = 'Erro ao Salvar';
            } finally {
                setTimeout(() => {
                    saveDataButton.disabled = false;
                    saveDataButton.textContent = 'Salvar';
                }, 3000);
            }
        }
        
        async function loadDataFromDrive() {
            const authStatus = document.getElementById('auth-status');
            try {
                authStatus.textContent = 'Buscando dados...';
                const response = await gapi.client.drive.files.list({ q: `name='${FILENAME}' and trashed=false`, spaces: 'drive', fields: 'files(id, name)' });
                if (response.result.files && response.result.files.length > 0) {
                    driveFileId = response.result.files[0].id;
                    const fileResponse = await gapi.client.drive.files.get({ fileId: driveFileId, alt: 'media' });
                    const data = JSON.parse(fileResponse.body);
                    expenses = data.expenses || [];
                    monthlyIncomes = data.monthlyIncomes || {};
                    savings = data.savings || [];
                    authStatus.textContent = 'Dados carregados!';
                } else {
                    driveFileId = null; 
                    loadDefaultData();
                    authStatus.textContent = 'Nenhum arquivo encontrado.';
                }
            } catch (err) {
                authStatus.textContent = 'Erro ao carregar dados.';
                loadDefaultData();
            } finally {
                updateAllUI();
                setTimeout(() => { if (gapi.client.getToken()) authStatus.textContent = 'Conectado'; }, 3000);
            }
        }

        // --- LÓGICA DE LOGIN (PERSISTENTE E AUTH) ---
        function checkPersistentLogin() {
            const sessionData = localStorage.getItem('googleSession');
            if (!sessionData) return;
            const session = JSON.parse(sessionData);
            const now = new Date().getTime();
            const fifteenDaysInMillis = 15 * 24 * 60 * 60 * 1000;
            if (now - session.lastSeen > fifteenDaysInMillis) {
                localStorage.removeItem('googleSession');
                return;
            }
            session.lastSeen = now;
            localStorage.setItem('googleSession', JSON.stringify(session));
            gapi.client.setToken({ access_token: session.token });
            updateSigninStatus(true);
        }

        function updateSigninStatus(isSignedIn) {
            const authStatus = document.getElementById('auth-status');
            const authButton = document.getElementById('google-auth-button');
            const saveDataButton = document.getElementById('save-data-button');
            const geminiButton = document.getElementById('gemini-button');
            const shouldLoadData = isSignedIn && expenses.length === 0;
            if (isSignedIn) {
                authStatus.textContent = 'Conectado';
                authButton.textContent = 'Sair';
                saveDataButton.disabled = false;
                geminiButton.disabled = false;
                if (shouldLoadData) {
                    loadDataFromDrive();
                }
            } else {
                authStatus.textContent = 'Desconectado';
                authButton.textContent = 'Fazer Login';
                saveDataButton.disabled = true;
                geminiButton.disabled = true;
                driveFileId = null;
                loadDefaultData();
                updateAllUI();
            }
        }

        window.gapiLoaded = () => { gapi.load('client', initializeGapiClient); };
        window.gisLoaded = () => {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPES, callback: (tokenResponse) => {
                    if (tokenResponse.error) { return; }
                    const session = { token: tokenResponse.access_token, lastSeen: new Date().getTime() };
                    localStorage.setItem('googleSession', JSON.stringify(session));
                    gapi.client.setToken(tokenResponse);
                    updateSigninStatus(true);
                },
            });
            gisInited = true; 
            maybeEnableButtons();
        };
        async function initializeGapiClient() { 
            await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS }); 
            gapiInited = true; 
            maybeEnableButtons(); 
        }
        function maybeEnableButtons() { 
            const authButton = document.getElementById('google-auth-button');
            if (gapiInited && gisInited) { 
                authButton.disabled = false; 
                checkPersistentLogin();
            } 
        }

        // --- LÓGICA MODAL DE EDIÇÃO ---
        window.openEditModal = (id) => {
            const expense = expenses.find(e => e.id === id);
            if (!expense) return;
            document.getElementById('edit-expense-id').value = expense.id;
            document.getElementById('edit-date').value = expense.date;
            document.getElementById('edit-cost-type').value = expense.costType;
            document.getElementById('edit-category').value = expense.category;
            document.getElementById('edit-payment-type').value = expense.type;
            document.getElementById('edit-description').value = expense.description;
            document.getElementById('edit-bank').value = expense.bank;
            document.getElementById('edit-amount').value = expense.amount;
            const recurringOptions = document.getElementById('edit-recurring-options');
            if (expense.recurrenceId) {
                recurringOptions.classList.remove('hidden');
            } else {
                recurringOptions.classList.add('hidden');
            }
            document.getElementById('edit-modal').classList.add('visible');
        }

        // --- LÓGICA DE ATUALIZAÇÃO DA INTERFACE (UI) ---
        function updateAllUI() {
            renderMonthlyIncomes();
            applyFiltersAndRenderExpenses();
            updateExpensesDashboard();
            updateSavingsDashboard();
            updateChartTheme();
            applySavingsFiltersAndRender();
        }

        function renderMonthlyIncomes() {
             const listEl = document.getElementById('monthly-incomes-list');
            listEl.innerHTML = '';
            Object.keys(monthlyIncomes).sort().reverse().forEach(month => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-gray-50 p-2 rounded';
                div.innerHTML = `<span>${formatMonthYear(month)}: <strong>${formatCurrency(monthlyIncomes[month])}</strong></span> <button onclick="deleteIncome('${month}')" class="text-red-500 hover:text-red-700 text-xs font-semibold">Excluir</button>`;
                listEl.appendChild(div);
            });
        }
        
        function updateExpensesDashboard() {
            const uniqueMonths = [...new Set(expenses.map(e => e.date.substring(0, 7)))].sort().reverse();
            const monthSelects = [document.getElementById('month-select'), document.getElementById('dashboard-month-filter'), document.getElementById('filter-month')];
            monthSelects.forEach(select => {
                const currentVal = select.value;
                select.innerHTML = '<option value="all">Todos os Meses</option>';
                uniqueMonths.forEach(m => select.add(new Option(formatMonthYear(m), m)));
                select.value = uniqueMonths.includes(currentVal) ? currentVal : (select.id === 'filter-month' ? 'all' : uniqueMonths[0] || 'all');
            });
            const monthAnalysisSelect = document.getElementById('month-select');
            if (monthAnalysisSelect.options.length > 0 && monthAnalysisSelect.options[0]?.value === 'all') {
                 monthAnalysisSelect.remove(0);
            }
            if (!uniqueMonths.includes(monthAnalysisSelect.value)) {
                monthAnalysisSelect.value = uniqueMonths[0] || '';
            }
            updateSummaryCards();
            updateMonthlyAnalysis();
            updateCostTypeAnalysis();
        }

        function updateSummaryCards() {
            const filter = document.getElementById('dashboard-month-filter').value;
            const relevantExpenses = filter === 'all' ? expenses : expenses.filter(e => e.date.startsWith(filter));
            const relevantIncome = filter === 'all' ? Object.values(monthlyIncomes).reduce((s, i) => s + i, 0) : monthlyIncomes[filter] || 0;
            const total = relevantExpenses.reduce((s, e) => s + e.amount, 0);
            document.getElementById('total-expenses').textContent = formatCurrency(total);
            document.getElementById('income-percentage').textContent = `${(relevantIncome > 0 ? (total / relevantIncome) * 100 : 0).toFixed(1)}%`;
            document.getElementById('remaining-balance').textContent = formatCurrency(relevantIncome - total);
        }

        function updateMonthlyAnalysis() {
            const select = document.getElementById('month-select');
            if (!select.value) {
                if(monthlyCategoryChart) monthlyCategoryChart.destroy();
                document.getElementById('monthly-analysis-details').innerHTML = '';
                return;
            }
            const monthly = expenses.filter(e => e.date.startsWith(select.value));
            const categoryData = monthly.reduce((acc, {category, amount}) => ({...acc, [category]: (acc[category] || 0) + amount}), {});
            let detailsHtml = `<strong>Resumo de ${formatMonthYear(select.value)}:</strong><ul class="list-disc ml-4 mt-2">`;
            Object.entries(categoryData).sort(([,a],[,b]) => b-a).forEach(([cat, amt]) => detailsHtml += `<li>${cat}: <strong>${formatCurrency(amt)}</strong></li>`);
            document.getElementById('monthly-analysis-details').innerHTML = detailsHtml + '</ul>';
            if (monthlyCategoryChart) monthlyCategoryChart.destroy();
            monthlyCategoryChart = new Chart(document.getElementById('monthly-category-chart'), {
                type: 'pie', data: { labels: Object.keys(categoryData), datasets: [{ data: Object.values(categoryData), backgroundColor: ['#4f46e5', '#ec4899', '#f59e0b', '#10b981', '#ef4444', '#3b82f6', '#8b5cf6'] }] },
                options: { responsive: true, plugins: { legend: { position: 'top' } } }
            });
        }
        
        function updateCostTypeAnalysis() {
            const filter = document.getElementById('dashboard-month-filter').value;
            const relevantExpenses = filter === 'all' ? expenses : expenses.filter(e => e.date.startsWith(filter));
            const costData = relevantExpenses.reduce((acc, {costType, amount}) => {
                acc[costType] = (acc[costType] || 0) + amount;
                return acc;
            }, { 'Fixo': 0, 'Variável': 0 });
            if (costTypeChart) costTypeChart.destroy();
            costTypeChart = new Chart(document.getElementById('cost-type-chart'), {
                type: 'pie',
                data: { labels: Object.keys(costData), datasets: [{ data: Object.values(costData), backgroundColor: ['#3b82f6', '#f59e0b'] }] },
                options: { responsive: true, plugins: { legend: { position: 'top' } } }
            });
        }
        
        function applySavingsFiltersAndRender() {
            const monthFilter = document.getElementById('filter-saving-month').value;
            const typeFilter = document.getElementById('filter-saving-type').value;
            if (monthFilter === 'all' && typeFilter === 'all') {
                renderSavingsTable([]);
                return;
            }
            let filteredSavings = [...savings];
            if (monthFilter !== 'all') {
                filteredSavings = filteredSavings.filter(s => s.month === monthFilter);
            }
            if (typeFilter !== 'all') {
                filteredSavings = filteredSavings.filter(s => s.type === typeFilter);
            }
            renderSavingsTable(filteredSavings);
        }

        function renderSavingsTable(savingsToRender) {
            const savingsTableBody = document.getElementById('savings-table-body');
            savingsTableBody.innerHTML = '';
            if (savingsToRender.length === 0) {
                const message = "Use os filtros acima para ver o histórico de reservas.";
                savingsTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-10 text-gray-500">${message}</td></tr>`;
                return;
            }
            savingsToRender.sort((a, b) => b.month.localeCompare(a.month)).forEach(saving => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Mês" class="px-6 py-4 whitespace-nowrap text-sm font-medium">${formatMonthYear(saving.month)}</td>
                    <td data-label="Tipo" class="px-6 py-4 whitespace-nowrap text-sm">${saving.type}</td>
                    <td data-label="Valor" class="px-6 py-4 whitespace-nowrap text-sm text-green-500 text-right font-semibold">${formatCurrency(saving.amount)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium actions-cell">
                        <button onclick="deleteSaving(${saving.id})" class="text-red-600 hover:text-red-900">Excluir</button>
                    </td>
                `;
                savingsTableBody.appendChild(row);
            });
        }

        function updateSavingsDashboard() {
            const total = savings.reduce((sum, s) => sum + s.amount, 0);
            document.getElementById('total-savings').textContent = formatCurrency(total);
            const uniqueMonths = [...new Set(savings.map(s => s.month))].sort().reverse();
            const monthFilterEl = document.getElementById('filter-saving-month');
            const currentMonthVal = monthFilterEl.value;
            monthFilterEl.innerHTML = '<option value="all">Todos os Meses</option>';
            uniqueMonths.forEach(m => monthFilterEl.add(new Option(formatMonthYear(m), m)));
            monthFilterEl.value = currentMonthVal;
            const byTypeData = savings.reduce((acc, {type, amount}) => ({...acc, [type]: (acc[type] || 0) + amount}), {});
            if (savingsByTypeChart) savingsByTypeChart.destroy();
            savingsByTypeChart = new Chart(document.getElementById('savings-by-type-chart'), {
                type: 'bar',
                data: { 
                    labels: Object.keys(byTypeData), 
                    datasets: [{ 
                        label: 'Total Guardado',
                        data: Object.values(byTypeData), 
                        backgroundColor: ['#10b981', '#f59e0b', '#3b82f6', '#8b5cf6']
                    }] 
                },
                options: { 
                    responsive: true,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        function renderExpenseTable(expensesToRender) {
             const expenseTableBody = document.getElementById('expense-table-body');
            expenseTableBody.innerHTML = '';
            if (expensesToRender.length === 0) {
                 const isFiltered = document.getElementById('filter-month').value !== 'all' || document.getElementById('filter-category').value !== 'all' || document.getElementById('filter-payment').value !== 'all';
                 const message = isFiltered ? "Nenhum resultado para os filtros." : "Use os filtros para ver o histórico.";
                 expenseTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-gray-500">${message}</td></tr>`;
                 return;
             }
            expensesToRender.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(expense => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Data">${formatDate(expense.date)}</td>
                    <td data-label="Descrição">${expense.description}</td>
                    <td data-label="Categoria">${expense.category}</td>
                    <td data-label="Tipo">${expense.costType}</td>
                    <td data-label="Valor" class="text-red-500 font-medium">${formatCurrency(expense.amount)}</td>
                    <td data-label="Ações" class="actions-cell">
                        <button onclick="openEditModal(${expense.id})" class="text-blue-600 hover:text-blue-900">Editar</button>
                        <button onclick="deleteExpense(${expense.id})" class="text-red-600 hover:text-red-900">Excluir</button>
                    </td>
                `;
                expenseTableBody.appendChild(row);
            });
        }
        
        function applyFiltersAndRenderExpenses() {
            const filterMonthEl = document.getElementById('filter-month');
            const filterCategoryEl = document.getElementById('filter-category');
            const filterPaymentEl = document.getElementById('filter-payment');
            const selectedMonth = filterMonthEl.value;
            const selectedCategory = filterCategoryEl.value;
            const selectedPayment = filterPaymentEl.value;
            if (selectedMonth === 'all' && selectedCategory === 'all' && selectedPayment === 'all') {
                renderExpenseTable([]);
                return;
            }
            let filtered = [...expenses];
            if (selectedMonth !== 'all') filtered = filtered.filter(e => e.date.startsWith(selectedMonth));
            if (selectedCategory !== 'all') filtered = filtered.filter(e => e.category === selectedCategory);
            if (selectedPayment !== 'all') filtered = filtered.filter(e => e.type === selectedPayment);
            renderExpenseTable(filtered);
        }

        // --- TEMA E DICAS ---
        function applyTheme(theme) {
            const sunIcon = document.getElementById('theme-icon-sun');
            const moonIcon = document.getElementById('theme-icon-moon');
            if (theme === 'dark') {
                document.body.classList.add('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                document.body.classList.remove('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
            updateChartTheme();
        }
        function toggleTheme() {
            const newTheme = document.body.classList.contains('dark') ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        }
        function updateChartTheme() {
            const isDark = document.body.classList.contains('dark');
            const textColor = isDark ? '#d1d5db' : '#374151';
            Chart.defaults.color = textColor;
            if(expenses.length > 0) updateExpensesDashboard();
            if(savings.length > 0) updateSavingsDashboard();
        }
        function initializeTips() {
            const dismissedTips = JSON.parse(localStorage.getItem('dismissedTips')) || [];
            document.querySelectorAll('.mini-tip').forEach(tip => {
                if (!dismissedTips.includes(tip.id)) {
                    tip.style.display = 'block';
                } else {
                    tip.style.display = 'none';
                }
            });
        }
        window.dismissTip = (tipId) => {
            const dismissedTips = JSON.parse(localStorage.getItem('dismissedTips')) || [];
            if (!dismissedTips.includes(tipId)) {
                dismissedTips.push(tipId);
                localStorage.setItem('dismissedTips', JSON.stringify(dismissedTips));
            }
            document.getElementById(tipId).style.display = 'none';
        }

        // --- FUNÇÃO GEMINI API ---
        async function callGeminiAPI() {
            const geminiButton = document.getElementById('gemini-button');
            if (expenses.length === 0 && Object.keys(monthlyIncomes).length === 0 && savings.length === 0) {
                document.getElementById('analysis-text').innerHTML = '<p>Por favor, adicione alguns dados antes de pedir uma análise.</p>';
                return;
            }
            geminiButton.disabled = true;
            geminiButton.innerHTML = `<svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Gerando...`;
            document.getElementById('analysis-text').innerHTML = '<p>Analisando seus dados financeiros... Isso pode levar um momento.</p>';
            const incomesText = Object.entries(monthlyIncomes).map(([month, income]) => `- ${formatMonthYear(month)}: ${formatCurrency(income)}`).join('\n');
            const expensesText = expenses.map(e => `- Data: ${e.date}, Descrição: ${e.description}, Categoria: ${e.category}, Valor: ${formatCurrency(e.amount)}`).join('\n');
            const savingsText = savings.map(s => `- Mês: ${formatMonthYear(s.month)}, Tipo: ${s.type}, Valor: ${formatCurrency(s.amount)}`).join('\n');
            const systemPrompt = "Você é um consultor financeiro amigável e prestativo. Sua tarefa é analisar os dados de despesas, rendas e reservas de um usuário e fornecer dicas personalizadas, práticas e acionáveis para economizar dinheiro. Responda em português do Brasil. Formate sua resposta usando markdown simples (cabeçalhos com ##, negrito com **, e listas com *).";
            const userQuery = `Analise meus dados financeiros e me dê dicas para melhorar minha saúde financeira.\n\n**Minhas Rendas Mensais:**\n${incomesText || 'Nenhuma renda registrada.'}\n\n**Minhas Despesas:**\n${expensesText || 'Nenhuma despesa registrada.'}\n\n**Minhas Reservas:**\n${savingsText || 'Nenhuma reserva registrada.'}`;
            const geminiApiKey = "AIzaSyC9eCGpgJuypWE98f19Z2XZ3QFeHHjU4_4";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`;
            try {
                const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const errorBody = await response.json(); throw new Error(`HTTP error! status: ${response.status}, message: ${errorBody.error.message}`); }
                const result = await response.json();
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    document.getElementById('analysis-text').innerHTML = candidate.content.parts[0].text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/^\* (.*$)/gm, '<li class="ml-4 list-disc">$1</li>').replace(/\n/g, '<br>');
                } else { throw new Error("Resposta da API inválida ou vazia."); }
            } catch (error) {
                console.error("Erro ao chamar a API Gemini:", error);
                document.getElementById('analysis-text').innerHTML = `<p class="text-red-500"><strong>Erro!</strong> Não foi possível gerar as dicas. Por favor, tente novamente mais tarde.</p>`;
            } finally {
                geminiButton.disabled = false;
                geminiButton.innerHTML = '✨ Gerar Dicas com IA';
            }
        }
        
        // --- FUNÇÕES DE AÇÃO (DELETE) ---
        window.deleteExpense = (id) => { 
            const expenseToDelete = expenses.find(e => e.id === id);
            if (!expenseToDelete) return;
            if (expenseToDelete.recurrenceId) {
                if (confirm("Esta despesa é recorrente. Deseja apagar também as futuras?")) {
                    expenses = expenses.filter(e => !(e.recurrenceId === expenseToDelete.recurrenceId && new Date(e.date) >= new Date(expenseToDelete.date)));
                } else {
                    expenses = expenses.filter(e => e.id !== id);
                }
            } else {
                expenses = expenses.filter(e => e.id !== id);
            }
            updateAllUI(); 
        };
        window.deleteIncome = (month) => { delete monthlyIncomes[month]; updateAllUI(); };
        window.deleteSaving = (id) => { savings = savings.filter(s => s.id !== id); updateAllUI(); };
        
        // --- INICIALIZAÇÃO E LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            const expenseForm = document.getElementById('expense-form');
            const incomeForm = document.getElementById('income-form');
            const savingForm = document.getElementById('saving-form');
            const editForm = document.getElementById('edit-expense-form');
            const cancelEditButton = document.getElementById('cancel-edit-button');
            const themeToggleButton = document.getElementById('theme-toggle-button');
            const geminiButton = document.getElementById('gemini-button');
            const authButton = document.getElementById('google-auth-button');
            const saveDataButton = document.getElementById('save-data-button');
            const tabDespesas = document.getElementById('tab-despesas');
            const tabReservas = document.getElementById('tab-reservas');
            const filters = [document.getElementById('filter-month'), document.getElementById('filter-category'), document.getElementById('filter-payment')];
            const dashboardFilters = [document.getElementById('dashboard-month-filter'), document.getElementById('month-select')];
            const savingFilters = [document.getElementById('filter-saving-month'), document.getElementById('filter-saving-type')];

            const savedTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(savedTheme);
            updateSigninStatus(false);
            document.getElementById('date').valueAsDate = new Date();
            initializeTips();
            applySavingsFiltersAndRender();
            
            authButton.addEventListener('click', () => {
                 if (gapi.client.getToken() === null) {
                     tokenClient.requestAccessToken({prompt: 'consent'});
                } else {
                    const token = gapi.client.getToken();
                    if (token) {
                        google.accounts.oauth2.revoke(token.access_token, () => {
                            gapi.client.setToken(null);
                            localStorage.removeItem('googleSession');
                            updateSigninStatus(false);
                        });
                    }
                }
            });

            tabDespesas.addEventListener('click', () => { 
                tabDespesas.classList.add('active'); 
                tabReservas.classList.remove('active'); 
                document.getElementById('despesas-view').classList.remove('hidden'); 
                document.getElementById('reservas-view').classList.add('hidden'); 
            });
            tabReservas.addEventListener('click', () => { 
                tabReservas.classList.add('active'); 
                tabDespesas.classList.remove('active'); 
                document.getElementById('reservas-view').classList.remove('hidden'); 
                document.getElementById('despesas-view').classList.add('hidden'); 
            });

            expenseForm.addEventListener('submit', e => {
                e.preventDefault();
                const isRecurring = document.getElementById('is-recurring').checked;
                const recurrenceId = isRecurring ? Date.now() : null;
                const baseExpense = {
                    costType: document.getElementById('cost-type').value, type: document.getElementById('payment-type').value,
                    description: document.getElementById('description').value, amount: parseFloat(document.getElementById('amount').value),
                    category: document.getElementById('category').value, bank: document.getElementById('bank').value, recurrenceId: recurrenceId
                };
                if (isRecurring) {
                    const startDate = new Date(document.getElementById('date').value + 'T00:00:00');
                    const endDate = new Date(document.getElementById('recurrence-end-date').value + 'T00:00:00');
                    if (!document.getElementById('recurrence-end-date').value || startDate > endDate) return;
                    let currentDate = new Date(startDate.getTime());
                    while (currentDate <= endDate) {
                        expenses.push({ ...baseExpense, id: Date.now() + currentDate.getTime(), date: currentDate.toISOString().split('T')[0] });
                        currentDate.setMonth(currentDate.getMonth() + 1);
                    }
                } else {
                    expenses.push({ ...baseExpense, id: Date.now(), date: document.getElementById('date').value });
                }
                updateAllUI();
                expenseForm.reset();
                document.getElementById('date').valueAsDate = new Date();
                document.getElementById('is-recurring').checked = false;
                document.getElementById('recurring-options').classList.add('hidden');
            });

            incomeForm.addEventListener('submit', e => { 
                e.preventDefault(); 
                const m = document.getElementById('income-month').value; 
                const a = parseFloat(document.getElementById('income-amount').value); 
                if(m && a >= 0) { monthlyIncomes[m] = a; updateAllUI(); incomeForm.reset(); } 
            });
            
            savingForm.addEventListener('submit', e => {
                e.preventDefault();
                savings.push({ id: Date.now(), month: document.getElementById('saving-month').value, type: document.getElementById('saving-type').value, amount: parseFloat(document.getElementById('saving-amount').value) });
                updateAllUI();
                savingForm.reset();
                applySavingsFiltersAndRender();
            });
            
            editForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = parseInt(document.getElementById('edit-expense-id').value);
                const scope = document.getElementById('edit-recurrence-scope').value;
                const updatedData = {
                    date: document.getElementById('edit-date').value, costType: document.getElementById('edit-cost-type').value,
                    category: document.getElementById('edit-category').value, type: document.getElementById('edit-payment-type').value,
                    description: document.getElementById('edit-description').value, bank: document.getElementById('edit-bank').value,
                    amount: parseFloat(document.getElementById('edit-amount').value)
                };
                const originalExpense = expenses.find(e => e.id === id);
                if (scope === 'single' || !originalExpense.recurrenceId) {
                    const index = expenses.findIndex(e => e.id === id);
                    expenses[index] = { ...expenses[index], ...updatedData };
                } else {
                    expenses.forEach((expense, index) => {
                        let shouldUpdate = false;
                        if (expense.recurrenceId === originalExpense.recurrenceId) {
                            if (scope === 'all') shouldUpdate = true;
                            if (scope === 'future' && new Date(expense.date) >= new Date(originalExpense.date)) shouldUpdate = true;
                        }
                        if (shouldUpdate) {
                            expenses[index] = { ...expense, ...updatedData, date: expense.date, id: expense.id, recurrenceId: expense.recurrenceId };
                        }
                    });
                }
                document.getElementById('edit-modal').classList.remove('visible');
                updateAllUI();
            });

            cancelEditButton.addEventListener('click', () => document.getElementById('edit-modal').classList.remove('visible'));
            themeToggleButton.addEventListener('click', toggleTheme);
            geminiButton.addEventListener('click', callGeminiAPI);
            saveDataButton.addEventListener('click', saveDataToDrive);
            filters.forEach(el => el.addEventListener('change', applyFiltersAndRenderExpenses));
            dashboardFilters.forEach(el => el.addEventListener('change', updateExpensesDashboard));
            savingFilters.forEach(el => el.addEventListener('change', applySavingsFiltersAndRender));

            document.getElementById('is-recurring').addEventListener('change', (e) => { 
                document.getElementById('recurring-options').classList.toggle('hidden', !e.target.checked);
                document.getElementById('recurrence-end-date').required = e.target.checked;
            });
        });
    </script>
</body>
</html>
