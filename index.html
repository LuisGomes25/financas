<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilha de Finan√ßas Pessoais com IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script async defer src="https://apis.google.com/js/api.js" onload="window.gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="window.gisLoaded()"></script>
    <style>
        /* Estilos Gerais (incluindo Temas) */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; transition: background-color 0.3s, color 0.3s; }
        .card { background-color: white; border-radius: 0.75rem; border: 1px solid #e5e7eb; padding: 1.5rem; transition: background-color 0.3s, border-color 0.3s; }
        h1, .text-gray-800, .text-gray-900 { color: #111827 !important; }
        h2, h3, .text-gray-700 { color: #1f2937 !important; }
        p, label, .text-gray-600, .text-gray-500 { color: #4b5563 !important; }
        #auth-status, #last-save-status { color: #6b7280 !important; }
        input, select { background-color: #f9fafb !important; border-color: #d1d5db !important; color: #111827 !important; color-scheme: light; }
        input::placeholder { color: #9ca3af; }
        .table-header { background-color: #f9fafb; }
        .responsive-table tbody, .responsive-table, .divide-y { border-color: #e5e7eb !important; }
        #google-auth-button, .export-button { background-color: #ffffff; border-color: #d1d5db; color: #374151; }
        #google-auth-button:hover, .export-button:hover { background-color: #f9fafb; }
        #monthly-incomes-list .bg-gray-50 { background-color: #f9fafb !important; }
        .tab { color: #6b7280; cursor: pointer; padding: 0.5rem 0.25rem; border-bottom: 2px solid transparent; }
        .tab.active { border-bottom-color: #4f46e5; color: #4f46e5; font-weight: 600; }
        .mb-8.border-b { border-color: #e5e7eb; }
        body.dark { background-color: #111827; color: #d1d5db; }
        body.dark .card { background-color: #1f2937; border: 1px solid #374151; }
        body.dark h1, body.dark .text-gray-800, body.dark .text-gray-900 { color: #f9fafb !important; }
        body.dark h2, body.dark h3, body.dark .text-gray-700 { color: #e5e7eb !important; }
        body.dark p, body.dark label, body.dark .text-gray-600, body.dark .text-gray-500 { color: #d1d5db !important; }
        body.dark #auth-status, body.dark #last-save-status { color: #9ca3af !important; }
        body.dark input, body.dark select { background-color: #374151 !important; border-color: #4b5563 !important; color: #f9fafb !important; color-scheme: dark; }
        body.dark input::placeholder { color: #9ca3af; }
        body.dark .table-header { background-color: #374151; }
        body.dark .responsive-table tbody, body.dark .responsive-table, body.dark .divide-y { border-color: #374151 !important; }
        body.dark #google-auth-button, body.dark .export-button { background-color: #374151; border-color: #4b5563; color: #f9fafb; }
        body.dark #google-auth-button:hover, body.dark .export-button:hover { background-color: #4b5563; }
        #gemini-button:disabled, #save-data-button:disabled { cursor: not-allowed; opacity: 0.7; }

        /* Estilos do Modal de Edi√ß√£o */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all .3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { max-height: 90vh; overflow-y: auto; width: 90%; max-width: 600px; transform: translateY(-20px); transition: all .3s; }
        .modal-overlay.visible .modal-content { transform: translateY(0); }

        /* Estilos das Mini Dicas */
        .mini-tip { display: none; position: relative; background-color: #eef2ff; border-left: 4px solid #4f46e5; padding: 1rem; border-radius: 0.25rem; margin-top: 1.5rem; }
        body.dark .mini-tip { background-color: #312e81; border-color: #818cf8; }
        .mini-tip-close { position: absolute; top: 0.5rem; right: 0.5rem; background: none; border: none; font-size: 1.2rem; cursor: pointer; }
        
        /* Estilos da Barra de Progresso */
        .progress-bg { background-color: #e5e7eb; border-radius: 9999px; height: 0.75rem; overflow: hidden; }
        body.dark .progress-bg { background-color: #374151; }
        .progress-fill { height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out; }
        .progress-fill.budget { background-color: #4f46e5; }
        .progress-fill.budget.yellow { background-color: #f59e0b; }
        .progress-fill.budget.red { background-color: #ef4444; }
        .progress-fill.goal { background-color: #10b981; }


        /* Estilos Responsivos */
        @media (max-width: 767px) {
            .responsive-table thead { display: none; }
            .responsive-table tbody tr { display: block; border-radius: 0.5rem; margin-bottom: 1rem; padding: 1rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
            body.light .responsive-table tbody tr { border: 1px solid #e5e7eb; background-color: white;}
            body.dark .responsive-table tbody tr { border-color: #374151; background-color: #1f2937;}
            .responsive-table td { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0.25rem; text-align: right; }
            body.light .responsive-table td { border-bottom: 1px solid #f3f4f6; } body.dark .responsive-table td { border-bottom: 1px solid #374151; }
            .responsive-table td:last-child { border-bottom: none; }
            .responsive-table td::before { content: attr(data-label); font-weight: 600; margin-right: 1rem; text-align: left; }
            .responsive-table td .actions-cell { display: flex; gap: 1rem; justify-content: flex-end; align-items: center; width: 100%; height: 100%; }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-4 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Minhas Finan√ßas</h1>
                <p class="text-gray-500 mt-1">Sua planilha e dashboard financeiro com salvamento no Google Drive.</p>
            </div>
            <div class="flex items-center gap-4 w-full sm:w-auto">
                 <div id="auth-status" class="text-sm text-gray-600 flex-grow"></div>
                 <div id="last-save-status" class="text-sm text-gray-500 text-right"></div>
                 <button id="theme-toggle-button" class="p-2 rounded-md">
                     <svg id="theme-icon-sun" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                     <svg id="theme-icon-moon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                 </button>
                 <button id="google-auth-button" class="py-2 px-4 border rounded-md shadow-sm text-sm font-medium">Login</button>
                 <button id="save-data-button" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">Salvar</button>
            </div>
        </header>

        <div class="mb-8 border-b">
            <nav class="-mb-px flex space-x-2 sm:space-x-4" aria-label="Tabs">
                <a id="tab-despesas" class="tab active">Despesas</a>
                <a id="tab-contas" class="tab">Contas a Pagar</a>
                <a id="tab-renda" class="tab">Renda</a>
                <a id="tab-reservas" class="tab">Reservas</a>
                <a id="tab-orcamentos" class="tab">Or√ßamentos</a>
                <a id="tab-metas" class="tab">Metas</a>
            </nav>
        </div>

        <div id="despesas-view">
            <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <div class="lg:col-span-3 space-y-6">
                    <div class="card">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Adicionar Lan√ßamento</h2>
                        <form id="expense-form" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                            <div><label for="date" class="block text-sm font-medium">Data</label><input type="date" id="date" class="mt-1 block w-full rounded-md shadow-sm" required></div>
                            <div><label for="cost-type" class="block text-sm font-medium">Tipo</label><select id="cost-type" class="mt-1 block w-full rounded-md shadow-sm" required><option>Fixo</option><option>Vari√°vel</option></select></div>
                            <div>
                                <label for="category" class="block text-sm font-medium">Categoria</label>
                                <select id="category" class="mt-1 block w-full rounded-md shadow-sm" required>
                                    <option>Alimenta√ß√£o</option>
                                    <option>Assinaturas</option>
                                    <option>Educa√ß√£o</option>
                                    <option>Empr√©stimos</option>
                                    <option>Lazer</option>
                                    <option>Moradia</option>
                                    <option>Outros</option>
                                    <option>Sa√∫de</option>
                                    <option>Transporte</option>
                                    <option>Vestu√°rio</option>
                                </select>
                            </div>
                            <div>
                                <label for="payment-type" class="block text-sm font-medium">Pagamento</label>
                                <select id="payment-type" class="mt-1 block w-full rounded-md shadow-sm" required>
                                    <option>Boleto</option>
                                    <option>Cr√©dito</option>
                                    <option>D√©bito</option>
                                    <option>PIX</option>
                                </select>
                            </div>
                            <div class="sm:col-span-2 md:col-span-2"><label for="description" class="block text-sm font-medium">Onde foi (Descri√ß√£o)</label><input type="text" id="description" class="mt-1 block w-full rounded-md shadow-sm" placeholder="Ex: Supermercado" required></div>
                            <div>
                                <label for="bank" class="block text-sm font-medium">Banco</label>
                                <select id="bank" class="mt-1 block w-full rounded-md shadow-sm" required>
                                    <option>Banco do Brasil</option>
                                    <option>Bradesco</option>
                                    <option>Caixa</option>
                                    <option>Inter</option>
                                    <option>Ita√∫</option>
                                    <option>Mercado Pago</option>
                                    <option>Nubank</option>
                                    <option>Santander</option>
                                    <option>Outro</option>
                                </select>
                            </div>
                            <div><label for="amount" class="block text-sm font-medium">Valor (R$)</label><input type="number" step="0.01" id="amount" class="mt-1 block w-full rounded-md shadow-sm" placeholder="150,50" required></div>
                            
                            <div id="bill-month-container" class="hidden">
                                <label for="bill-month" class="block text-sm font-medium">M√™s da Fatura</label>
                                <input type="month" id="bill-month" class="mt-1 block w-full rounded-md shadow-sm">
                            </div>
                            
                            <div class="sm:col-span-2 md:col-span-4 space-y-3 mt-2">
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="is-future-entry" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                                    <label for="is-future-entry" class="text-sm font-medium">√â uma conta a pagar (lan√ßamento futuro)?</label>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="is-recurring" class="h-4 w-4 text-indigo-600 border-gray-300 rounded"><label for="is-recurring" class="text-sm font-medium">Despesa Recorrente?</label>
                                </div>
                                <div id="recurring-options" class="hidden">
                                    <label for="recurrence-end-date" class="block text-sm font-medium">Repetir mensalmente at√©:</label>
                                    <input type="date" id="recurrence-end-date" class="mt-1 block w-full rounded-md shadow-sm">
                                </div>
                            </div>

                            <div class="sm:col-span-2 md:col-span-4"><button type="submit" class="w-full sm:w-auto mt-4 justify-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Adicionar Lan√ßamento</button></div>
                        </form>
                        <div id="tip-recurring" class="mini-tip">üí° <b>Dica:</b> Marque "Lan√ßamento Futuro" para contas que ainda n√£o venceram. Elas aparecer√£o na aba "Contas a Pagar".<button onclick="dismissTip('tip-recurring')" class="mini-tip-close">&times;</button></div>
                    </div>
                    
                    <div class="card">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-gray-700">Hist√≥rico de Gastos (J√° Pagos)</h2>
                            <button onclick="exportToCsv('expenses')" class="py-1 px-3 border rounded-md shadow-sm text-sm font-medium export-button">Exportar CSV</button>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                            <div><label for="filter-month" class="block text-sm font-medium">Filtrar por M√™s (Or√ßament√°rio)</label><select id="filter-month" class="mt-1 block w-full rounded-md shadow-sm"></select></div>
                            <div>
                                <label for="filter-category" class="block text-sm font-medium">Filtrar por Categoria</label>
                                <select id="filter-category" class="mt-1 block w-full rounded-md shadow-sm">
                                    <option value="all">Todas as Categorias</option>
                                    <option>Alimenta√ß√£o</option>
                                    <option>Assinaturas</option>
                                    <option>Educa√ß√£o</option>
                                    <option>Empr√©stimos</option>
                                    <option>Lazer</option>
                                    <option>Moradia</option>
                                    <option>Outros</option>
                                    <option>Sa√∫de</option>
                                    <option>Transporte</option>
                                    <option>Vestu√°rio</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-payment" class="block text-sm font-medium">Filtrar por Pagamento</label>
                                <select id="filter-payment" class="mt-1 block w-full rounded-md shadow-sm">
                                    <option value="all">Todos os Tipos</option>
                                    <option>Boleto</option>
                                    <option>Cr√©dito</option>
                                    <option>D√©bito</option>
                                    <option>PIX</option>
                                </select>
                            </div>
                        </div>
                        <div class="overflow-x-auto"><table class="min-w-full responsive-table"><thead class="table-header"><tr><th class="px-6 py-3 text-left text-xs font-medium uppercase">Data</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Descri√ß√£o</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Categoria</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Pagamento</th><th class="px-6 py-3 text-right text-xs font-medium uppercase">Valor</th><th class="px-6 py-3 text-right text-xs font-medium uppercase">A√ß√µes</th></tr></thead><tbody id="expense-table-body"></tbody></table></div>
                    </div>
                </div>
    
                <div class="lg:col-span-2 space-y-6">
                    <div class="card">
                        <label for="dashboard-month-filter" class="block text-sm font-medium mb-2">Filtro Mestre do Dashboard</label>
                        <select id="dashboard-month-filter" class="block w-full rounded-md shadow-sm sm:text-sm"></select>
                    </div>

                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Pr√≥ximos Vencimentos</h3>
                        <div id="upcoming-bills-container" class="space-y-2">
                            <p class="text-sm text-gray-500">Nenhuma conta a pagar registada para breve.</p>
                        </div>
                    </div>
                    <div class="card"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold text-gray-700">Vis√£o Geral</h3></div><div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center"><div><h3 class="text-sm font-medium text-gray-500">Gasto Total</h3><p id="total-expenses" class="mt-1 text-2xl font-semibold text-red-500">R$ 0,00</p></div><div><h3 class="text-sm font-medium text-gray-500">Renda Comprometida</h3><p id="income-percentage" class="mt-1 text-2xl font-semibold text-yellow-500">0%</p></div><div><h3 class="text-sm font-medium text-gray-500">Saldo Restante</h3><p id="remaining-balance" class="mt-1 text-2xl font-semibold text-green-500">R$ 0,00</p></div></div></div>
                    <div class="card"><h3 class="text-lg font-semibold text-gray-700">Fixos vs. Vari√°veis</h3><canvas id="cost-type-chart" class="mt-4"></canvas></div>
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-700">Renda Comprometida por Pagamento</h3>
                        <canvas id="payment-commitment-chart" class="mt-4"></canvas>
                    </div>
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Progresso do Or√ßamento</h3>
                        <div id="budget-progress-container" class="space-y-4"></div>
                    </div>
                     <div class="card">
                         <h3 class="text-lg font-semibold text-gray-700">Faturas de Cr√©dito por Banco</h3>
                        <canvas id="bill-by-bank-chart" class="mt-4"></canvas>
                    </div>
                    <div class="card"><h3 class="text-lg font-semibold text-gray-700 mb-4">Gastos por Categoria</h3><canvas id="monthly-category-chart" class="mt-4"></canvas><div id="monthly-analysis-details" class="mt-4 text-sm space-y-1"></div></div>
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-700">Compara√ß√£o de Gastos Mensais (Geral)</h3>
                        <canvas id="monthly-comparison-chart" class="mt-4"></canvas>
                    </div>
                    <div class="card"><h3 class="text-lg font-semibold text-gray-700 mb-4">An√°lise com IA</h3><button id="gemini-button" class="w-full flex items-center justify-center py-2 px-3 border rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700">‚ú® Gerar Dicas com IA</button><div id="analysis-text" class="text-sm space-y-2 mt-4"><p>Fa√ßa login e salve seus dados para usar a IA.</p></div><div id="tip-ia" class="mini-tip">üí° <b>Dica:</b> Ap√≥s adicionar alguns gastos, clique aqui para receber uma an√°lise financeira personalizada e dicas para economizar!<button onclick="dismissTip('tip-ia')" class="mini-tip-close">&times;</button></div></div>
                </div>
            </main>
        </div>
        
        <div id="contas-a-pagar-view" class="hidden">
            <div class="card max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Contas a Pagar (Lan√ßamentos Futuros)</h2>
                <p class="text-gray-500 mb-6">Aqui est√£o todas as suas contas que ainda n√£o foram pagas. Clique em "Pagar" para mov√™-las para o seu hist√≥rico de despesas.</p>
                <div class="overflow-x-auto">
                    <table class="min-w-full responsive-table">
                        <thead class="table-header">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase">Vencimento</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase">Descri√ß√£o</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase">Categoria</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase">Pagamento</th>
                                <th class="px-6 py-3 text-right text-xs font-medium uppercase">Valor</th>
                                <th class="px-6 py-3 text-right text-xs font-medium uppercase">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="future-entries-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="renda-view" class="hidden">
            <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <div class="lg:col-span-3 space-y-6">
                    <div class="card">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Adicionar Nova Renda</h2>
                        <form id="income-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="income-month" class="block text-sm font-medium">M√™s/Ano</label>
                                <input type="month" id="income-month" class="mt-1 block w-full rounded-md shadow-sm" required>
                            </div>
                            <div>
                                <label for="income-amount" class="block text-sm font-medium">Valor (R$)</label>
                                <input type="number" step="0.01" id="income-amount" class="mt-1 block w-full rounded-md shadow-sm" required placeholder="6000,00">
                            </div>
                            <div class="sm:col-span-2">
                                <label for="income-description" class="block text-sm font-medium">Descri√ß√£o</label>
                                <input type="text" id="income-description" class="mt-1 block w-full rounded-md shadow-sm" required placeholder="Ex: Sal√°rio Empresa X">
                            </div>
                            <div class="sm:col-span-2">
                                <button type="submit" class="w-full sm:w-auto mt-4 justify-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Adicionar Renda</button>
                            </div>
                        </form>
                    </div>
                    <div class="card">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Hist√≥rico de Rendas</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full responsive-table">
                                <thead class="table-header">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase">M√™s</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase">Descri√ß√£o</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium uppercase">Valor (R$)</th>
                                        <th class="px-6 py-3"><span class="sr-only">A√ß√µes</span></th>
                                    </tr>
                                </thead>
                                <tbody id="incomes-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-2 space-y-6">
                    <div class="card text-center">
                        <h3 class="text-lg font-medium text-gray-500">Renda Total (Todos os Meses)</h3>
                        <p id="total-income" class="mt-1 text-3xl sm:text-4xl font-bold text-green-500">R$ 0,00</p>
                    </div>
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-700">Rendas por M√™s</h3>
                        <canvas id="monthly-income-chart" class="mt-4"></canvas>
                    </div>
                </div>
            </main>
        </div>

        <div id="reservas-view" class="hidden">
            <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <div class="lg:col-span-3 space-y-6">
                    <div class="card"><h2 class="text-xl font-semibold text-gray-700 mb-4">Adicionar Nova Reserva</h2>
                        <form id="saving-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div><label for="saving-month" class="block text-sm font-medium">M√™s/Ano</label><input type="month" id="saving-month" class="mt-1 block w-full rounded-md shadow-sm" required></div>
                            <div><label for="saving-type" class="block text-sm font-medium">Tipo</label><select id="saving-type" class="mt-1 block w-full rounded-md shadow-sm" required><option>Reserva de Emerg√™ncia</option><option>Investimentos</option><option>Outros</option></select></div>
                            <div class="sm:col-span-2"><label for="saving-goal-link" class="block text-sm font-medium">Associar a uma Meta (Opcional)</label><select id="saving-goal-link" class="mt-1 block w-full rounded-md shadow-sm"><option value="none">Nenhuma</option></select></div>
                            <div class="sm:col-span-2"><label for="saving-amount" class="block text-sm font-medium">Valor (R$)</label><input type="number" step="0.01" id="saving-amount" class="mt-1 block w-full rounded-md shadow-sm" required placeholder="500,00"></div>
                            <div class="sm:col-span-2"><button type="submit" class="w-full sm:w-auto mt-4 justify-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Adicionar Reserva</button></div>
                        </form>
                    </div>
                    <div class="card">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-gray-700">Hist√≥rico de Reservas</h2>
                            <button onclick="exportToCsv('savings')" class="py-1 px-3 border rounded-md shadow-sm text-sm font-medium export-button">Exportar CSV</button>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="filter-saving-month" class="block text-sm font-medium text-gray-600">Filtrar por M√™s</label>
                                <select id="filter-saving-month" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm"></select>
                            </div>
                            <div>
                                <label for="filter-saving-type" class="block text-sm font-medium text-gray-600">Filtrar por Tipo</label>
                                <select id="filter-saving-type" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                    <option value="all">Todos os Tipos</option>
                                    <option>Reserva de Emerg√™ncia</option>
                                    <option>Investimentos</option>
                                    <option>Outros</option>
                                </select>
                            </div>
                        </div>
                        <div class="overflow-x-auto"><table class="min-w-full responsive-table"><thead class="table-header"><tr><th class="px-6 py-3 text-left text-xs font-medium uppercase">M√™s</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Tipo</th><th class="px-6 py-3 text-right text-xs font-medium uppercase">Valor (R$)</th><th class="px-6 py-3"><span class="sr-only">A√ß√µes</span></th></tr></thead><tbody id="savings-table-body"></tbody></table></div>
                    </div>
                </div>
                <div class="lg:col-span-2 space-y-6">
                    <div class="card text-center"><h3 class="text-lg font-medium text-gray-500">Total Guardado</h3><p id="total-savings" class="mt-1 text-3xl sm:text-4xl font-bold text-green-500">R$ 0,00</p></div>
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-700">Progresso das Metas</h3>
                        <div id="goal-progress-container" class="space-y-4"></div>
                    </div>
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-700">Total por Tipo de Reserva</h3>
                        <canvas id="savings-by-type-chart" class="mt-4"></canvas>
                    </div>
                </div>
            </main>
        </div>
        
        <div id="orcamentos-view" class="hidden">
            <div class="card max-w-2xl mx-auto">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Gerir Or√ßamentos Mensais</h2>
                <p class="text-gray-500 mb-6">Defina o seu limite de gastos para cada categoria.</p>
                
                <fieldset class="mb-4">
                    <legend class="block text-sm font-medium mb-2">Modo de Edi√ß√£o</legend>
                    <div class="flex flex-wrap gap-4">
                        <div class="flex items-center">
                            <input id="budget-mode-default" name="budget-edit-mode" type="radio" value="default" class="h-4 w-4" checked>
                            <label for="budget-mode-default" class="ml-2 block text-sm">Or√ßamento Padr√£o (para todos os meses)</label>
                        </div>
                        <div class="flex items-center">
                            <input id="budget-mode-single" name="budget-edit-mode" type="radio" value="single" class="h-4 w-4">
                            <label for="budget-mode-single" class="ml-2 block text-sm">M√™s Espec√≠fico</label>
                        </div>
                        <div class="flex items-center">
                            <input id="budget-mode-range" name="budget-edit-mode" type="radio" value="range" class="h-4 w-4">
                            <label for="budget-mode-range" class="ml-2 block text-sm">Aplicar em Intervalo</label>
                        </div>
                    </div>
                </fieldset>

                <div id="budget-date-pickers" class="hidden space-y-4 sm:space-y-0 sm:flex sm:gap-4 mb-6">
                    <div id="budget-single-month-container" class="hidden">
                        <label for="budget-month" class="block text-sm font-medium mb-1">Selecione o M√™s</label>
                        <input type="month" id="budget-month" class="block w-full rounded-md shadow-sm">
                    </div>
                    <div id="budget-range-container" class="hidden flex-grow sm:flex sm:gap-4">
                        <div>
                            <label for="budget-start-month" class="block text-sm font-medium mb-1">M√™s Inicial</label>
                            <input type="month" id="budget-start-month" class="block w-full rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="budget-end-month" class="block text-sm font-medium mb-1">M√™s Final</label>
                            <input type="month" id="budget-end-month" class="block w-full rounded-md shadow-sm">
                        </div>
                    </div>
                </div>

                <div id="budget-inputs-container" class="space-y-3 mt-6"></div>
                <button id="save-budget-button" class="w-full sm:w-auto mt-6 justify-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Salvar Or√ßamento</e>
            </div>
        </div>

        <div id="metas-view" class="hidden">
             <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Criar Nova Meta de Poupan√ßa</h2>
                    <p class="text-gray-500 mb-6">D√™ um nome e um valor alvo para o seu objetivo.</p>
                    <form id="goal-form" class="space-y-4">
                        <div>
                             <label for="goal-name" class="block text-sm font-medium">Nome da Meta</label>
                             <input type="text" id="goal-name" class="mt-1 block w-full rounded-md shadow-sm" placeholder="Ex: F√©rias no Jap√£o" required>
                        </div>
                        <div>
                             <label for="goal-target" class="block text-sm font-medium">Valor Alvo (R$)</label>
                             <input type="number" step="0.01" id="goal-target" class="mt-1 block w-full rounded-md shadow-sm" placeholder="15000,00" required>
                        </div>
                        <button type="submit" class="w-full sm:w-auto justify-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Criar Meta</button>
                    </form>
                </div>
                 <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Minhas Metas</h2>
                    <div id="goals-list-container" class="space-y-4"></div>
                 </div>
             </main>
        </div>
    </div>

    <div id="edit-modal" class="modal-overlay">
        <div class="card modal-content">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Editar Lan√ßamento</h2>
            <form id="edit-expense-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <input type="hidden" id="edit-expense-id">
                <input type="hidden" id="edit-is-future">
                <div><label for="edit-date" class="block text-sm font-medium">Data</label><input type="date" id="edit-date" class="mt-1 block w-full rounded-md shadow-sm" required></div>
                <div><label for="edit-cost-type" class="block text-sm font-medium">Tipo</label><select id="edit-cost-type" class="mt-1 block w-full rounded-md shadow-sm" required><option>Fixo</option><option>Vari√°vel</option></select></div>
                <div>
                    <label for="edit-category" class="block text-sm font-medium">Categoria</label>
                    <select id="edit-category" class="mt-1 block w-full rounded-md shadow-sm" required>
                        <option>Alimenta√ß√£o</option>
                        <option>Assinaturas</option>
                        <option>Educa√ß√£o</option>
                        <option>Empr√©stimos</option>
                        <option>Lazer</option>
                        <option>Moradia</option>
                        <option>Outros</option>
                        <option>Sa√∫de</option>
                        <option>Transporte</option>
                        <option>Vestu√°rio</option>
                    </select>
                </div>
                <div>
                    <label for="edit-payment-type" class="block text-sm font-medium">Pagamento</label>
                    <select id="edit-payment-type" class="mt-1 block w-full rounded-md shadow-sm" required>
                        <option>Boleto</option>
                        <option>Cr√©dito</option>
                        <option>D√©bito</option>
                        <option>PIX</option>
                    </select>
                </div>
                <div class="sm:col-span-2"><label for="edit-description" class="block text-sm font-medium">Descri√ß√£o</label><input type="text" id="edit-description" class="mt-1 block w-full rounded-md shadow-sm" required></div>
                <div>
                    <label for="edit-bank" class="block text-sm font-medium">Banco</label>
                    <select id="edit-bank" class="mt-1 block w-full rounded-md shadow-sm" required>
                        <option>Banco do Brasil</option>
                        <option>Bradesco</option>
                        <option>Caixa</option>
                        <option>Inter</option>
                        <option>Ita√∫</option>
                        <option>Mercado Pago</option>
                        <option>Nubank</option>
                        <option>Santander</option>
                        <option>Outro</option>
                    </select>
                </div>
                <div><label for="edit-amount" class="block text-sm font-medium">Valor (R$)</label><input type="number" step="0.01" id="edit-amount" class="mt-1 block w-full rounded-md shadow-sm" required></div>
                
                <div id="edit-bill-month-container" class="hidden">
                    <label for="edit-bill-month" class="block text-sm font-medium">M√™s da Fatura</label>
                    <input type="month" id="edit-bill-month" class="mt-1 block w-full rounded-md shadow-sm">
                </div>

                <div id="edit-recurring-options" class="sm:col-span-2 hidden">
                    <label for="edit-recurrence-scope" class="block text-sm font-medium">Aplicar altera√ß√£o a:</label>
                    <select id="edit-recurrence-scope" class="mt-1 block w-full rounded-md shadow-sm">
                        <option value="single">Apenas este lan√ßamento</option>
                        <option value="future">Este e os futuros</option>
                        <option value="all">Todos os lan√ßamentos da s√©rie</option>
                    </select>
                </div>
                <div class="sm:col-span-2 flex justify-end gap-4 mt-4">
                    <button type="button" id="cancel-edit-button" class="py-2 px-4 border rounded-md shadow-sm text-sm font-medium">Cancelar</button>
                    <button type="submit" class="py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- DADOS GLOBAIS ---
        let expenses = [];
        let futureEntries = [];
        let incomes = []; // NOVO: Substitui monthlyIncomes
        let savings = [];
        let budgets = { "default": {} };
        let savingsGoals = [];
        let lastSaveTime = null;
        
        // --- GR√ÅFICOS (inst√¢ncias) ---
        let monthlyCategoryChart, costTypeChart, savingsByTypeChart, monthlyComparisonChart, paymentCommitmentChart, billByBankChart, monthlyIncomeChart;
        
        // --- CONFIGURA√á√ÉO GOOGLE API ---
        const CLIENT_ID = '164577357008-o68h1qr3h69ik5ot1531f1fvvrl40umr.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyALVa2RTydoXDNsJP6NmtTV6b7zYhFixY0';
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const FILENAME = 'minhas_financas_dados.json';
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let driveFileId = null;

        // --- MAPA DE CORES DOS BANCOS ---
        const BANK_COLORS = {
            'Nubank': '#8A05BE',
            'Ita√∫': '#EC7000',
            'Banco do Brasil': '#0033A0',
            'Bradesco': '#CC092F',
            'Caixa': '#0073B0',
            'Santander': '#EC0000',
            'Inter': '#FF8700',
            'Mercado Pago': '#00B1EA',
            'Outro': '#6B7280'
        };

        // --- FUN√á√ïES DE FORMATA√á√ÉO ---
        const formatCurrency = (value) => `R$ ${typeof value === 'number' ? value.toFixed(2).replace('.', ',') : '0,00'}`;
        const formatDate = (dateString) => { const [y, m, d] = dateString.split('-'); return `${d}/${m}/${y}`; };
        const formatMonthYear = (monthString) => {
            if (!monthString || !monthString.includes('-')) return '';
            const [year, month] = monthString.split('-');
            const date = new Date(year, parseInt(month) - 1);
            const formatted = date.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
            return formatted.charAt(0).toUpperCase() + formatted.slice(1);
        };
        const formatTimestamp = (isoString) => {
            if (!isoString) return 'Nunca salvo.';
            const date = new Date(isoString);
            return date.toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
        };
        
        // --- FUN√á√ïES DE DADOS (CARREGAR/SALVAR) ---
        function loadDefaultData() {
            expenses = []; futureEntries = []; incomes = []; savings = []; budgets = { "default": {} }; savingsGoals = [];
            document.getElementById('last-save-status').textContent = 'Nunca salvo.';
        }

        async function saveDataToDrive() {
            const saveDataButton = document.getElementById('save-data-button');
            saveDataButton.disabled = true;
            saveDataButton.textContent = 'Salvando...';
            const saveTime = new Date().toISOString();
            const allData = { expenses, futureEntries, incomes, savings, budgets, savingsGoals, lastUpdated: saveTime };
            const dataBlob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
            try {
                const formData = new FormData();
                let method, path;
                if (driveFileId) {
                    path = `/upload/drive/v3/files/${driveFileId}?uploadType=multipart`;
                    method = 'PATCH';
                    formData.append('metadata', new Blob([JSON.stringify({})], { type: 'application/json' }));
                } else {
                    path = '/upload/drive/v3/files?uploadType=multipart';
                    method = 'POST';
                    const metadata = { name: FILENAME, mimeType: 'application/json' };
                    formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                }
                formData.append('file', dataBlob);
                const response = await fetch(`https://www.googleapis.com${path}`, {
                    method: method,
                    headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}` },
                    body: formData
                });
                if (!response.ok) throw await response.json();
                const result = await response.json();
                driveFileId = result.id; 
                saveDataButton.textContent = 'Salvo!';
                lastSaveTime = saveTime;
                document.getElementById('last-save-status').textContent = `Salvo: ${formatTimestamp(lastSaveTime)}`;
            } catch (err) {
                console.error("Erro ao salvar no Drive", err);
                saveDataButton.textContent = 'Erro ao Salvar';
            } finally {
                setTimeout(() => {
                    const currentSaveButton = document.getElementById('save-data-button');
                    if(currentSaveButton){
                       currentSaveButton.disabled = false;
                       currentSaveButton.textContent = 'Salvar';
                    }
                }, 2000);
            }
        }
        
        async function loadDataFromDrive() {
            const authStatus = document.getElementById('auth-status');
            try {
                authStatus.textContent = 'Buscando dados...';
                const response = await gapi.client.drive.files.list({ q: `name='${FILENAME}' and trashed=false`, spaces: 'drive', fields: 'files(id, name)' });
                if (response.result.files && response.result.files.length > 0) {
                    driveFileId = response.result.files[0].id;
                    const fileResponse = await gapi.client.drive.files.get({ fileId: driveFileId, alt: 'media' });
                    const data = JSON.parse(fileResponse.body);
                    expenses = data.expenses || [];
                    futureEntries = data.futureEntries || [];
                    
                    if (data.incomes) {
                        incomes = data.incomes;
                    } else if (data.monthlyIncomes) { // Migra√ß√£o de dados de Renda
                        incomes = Object.entries(data.monthlyIncomes).map(([month, amount], index) => ({
                            id: Date.now() + index,
                            month: month,
                            description: "Renda (importado)",
                            amount: amount
                        }));
                    } else {
                        incomes = [];
                    }

                    savings = data.savings || [];
                    budgets = data.budgets || { "default": {} };
                    savingsGoals = data.savingsGoals || [];
                    lastSaveTime = data.lastUpdated || null;
                    authStatus.textContent = 'Dados carregados!';
                    document.getElementById('last-save-status').textContent = `Salvo: ${formatTimestamp(lastSaveTime)}`;
                } else {
                    driveFileId = null; 
                    loadDefaultData();
                    authStatus.textContent = 'Nenhum arquivo encontrado.';
                }
            } catch (err) {
                authStatus.textContent = 'Erro ao carregar dados.';
                loadDefaultData();
            } finally {
                updateAllUI();
                setTimeout(() => { if (gapi.client.getToken()) authStatus.textContent = 'Conectado'; }, 3000);
            }
        }

        // --- L√ìGICA DE LOGIN (PERSISTENTE E AUTH) ---
        function checkPersistentLogin() {
            const sessionData = localStorage.getItem('googleSession');
            if (!sessionData) return;
            const session = JSON.parse(sessionData);
            const now = new Date().getTime();
            const fifteenDaysInMillis = 15 * 24 * 60 * 60 * 1000;
            if (now - session.lastSeen > fifteenDaysInMillis) {
                localStorage.removeItem('googleSession');
                return;
            }
            session.lastSeen = now;
            localStorage.setItem('googleSession', JSON.stringify(session));
            gapi.client.setToken({ access_token: session.token });
            updateSigninStatus(true);
        }

        function updateSigninStatus(isSignedIn) {
            const authStatus = document.getElementById('auth-status');
            const authButton = document.getElementById('google-auth-button');
            const saveDataButton = document.getElementById('save-data-button');
            const geminiButton = document.getElementById('gemini-button');
            const shouldLoadData = isSignedIn && expenses.length === 0 && savings.length === 0;
            if (isSignedIn) {
                authStatus.textContent = 'Conectado';
                authButton.textContent = 'Sair';
                saveDataButton.disabled = false;
                geminiButton.disabled = false;
                if (shouldLoadData) {
                    loadDataFromDrive();
                }
            } else {
                authStatus.textContent = 'Desconectado';
                authButton.textContent = 'Fazer Login';
                saveDataButton.disabled = true;
                geminiButton.disabled = true;
                driveFileId = null;
                loadDefaultData();
                updateAllUI();
            }
        }

        window.gapiLoaded = () => { gapi.load('client', initializeGapiClient); };
        window.gisLoaded = () => {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPES, callback: (tokenResponse) => {
                    if (tokenResponse.error) { return; }
                    const session = { token: tokenResponse.access_token, lastSeen: new Date().getTime() };
                    localStorage.setItem('googleSession', JSON.stringify(session));
                    gapi.client.setToken(tokenResponse);
                    updateSigninStatus(true);
                },
            });
            gisInited = true; 
            maybeEnableButtons();
        };
        async function initializeGapiClient() { 
            await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS }); 
            gapiInited = true; 
            maybeEnableButtons(); 
        }
        function maybeEnableButtons() { 
            const authButton = document.getElementById('google-auth-button');
            if (gapiInited && gisInited) { 
                authButton.disabled = false; 
                checkPersistentLogin();
            } 
        }

        // --- L√ìGICA MODAL DE EDI√á√ÉO ---
        window.openEditModal = (id, isFuture = false) => {
            const sourceArray = isFuture ? futureEntries : expenses;
            const entry = sourceArray.find(e => e.id === id);
            if (!entry) return;

            document.getElementById('edit-expense-id').value = entry.id;
            document.getElementById('edit-is-future').value = isFuture; 
            document.getElementById('edit-date').value = entry.date;
            document.getElementById('edit-cost-type').value = entry.costType;
            document.getElementById('edit-category').value = entry.category;
            document.getElementById('edit-payment-type').value = entry.type;
            document.getElementById('edit-description').value = entry.description;
            document.getElementById('edit-bank').value = entry.bank;
            document.getElementById('edit-amount').value = entry.amount;

            const billMonthContainer = document.getElementById('edit-bill-month-container');
            const billMonthInput = document.getElementById('edit-bill-month');
            if (entry.type === 'Cr√©dito') {
                billMonthInput.value = entry.billMonth || '';
                billMonthContainer.classList.remove('hidden');
            } else {
                billMonthInput.value = '';
                billMonthContainer.classList.add('hidden');
            }

            const recurringOptions = document.getElementById('edit-recurring-options');
            if (entry.recurrenceId) {
                recurringOptions.classList.remove('hidden');
            } else {
                recurringOptions.classList.add('hidden');
            }
            document.getElementById('edit-modal').classList.add('visible');
        }

        // --- L√ìGICA DE OR√áAMENTOS ---
        function renderBudgetInputs(monthKey) {
            const container = document.getElementById('budget-inputs-container');
            if (!container) return;
            container.innerHTML = '';
            
            const isRangeMode = (monthKey === 'range');
            const budgetKeyToShow = isRangeMode ? 'default' : monthKey;
            
            const categories = ["Alimenta√ß√£o", "Assinaturas", "Educa√ß√£o", "Empr√©stimos", "Lazer", "Moradia", "Outros", "Sa√∫de", "Transporte", "Vestu√°rio"];
            const monthBudgets = budgets[budgetKeyToShow] || budgets["default"] || {};
            const defaultBudgets = budgets["default"] || {};

            categories.forEach(category => {
                const value = isRangeMode ? '' : (monthBudgets[category] || '');
                const placeholder = (defaultBudgets[category] || '0,00');

                const inputGroup = document.createElement('div');
                inputGroup.className = 'grid grid-cols-3 gap-4 items-center';
                inputGroup.innerHTML = `
                    <label for="budget-${category}" class="col-span-1 text-sm font-medium">${category}</label>
                    <div class="col-span-2 relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500 sm:text-sm">R$</span>
                        <input type="number" step="0.01" id="budget-${category}" data-category="${category}" value="${value}" class="pl-10 block w-full rounded-md shadow-sm" placeholder="${placeholder}">
                    </div>
                `;
                container.appendChild(inputGroup);
            });
        }

        function saveBudgets() {
            const editMode = document.querySelector('input[name="budget-edit-mode"]:checked').value;
            
            const budgetValues = {};
            let hasValues = false;
            document.querySelectorAll('#budget-inputs-container input').forEach(input => {
                const category = input.dataset.category;
                const amount = parseFloat(input.value);
                if (amount > 0) {
                    budgetValues[category] = amount;
                    hasValues = true;
                } else if (input.value) { 
                    budgetValues[category] = 0; 
                }
            });

            if (!hasValues && editMode !== 'range') {
                if (!confirm("Nenhum valor preenchido. Deseja limpar este or√ßamento?")) return;
            }

            if (editMode === 'default') {
                budgets["default"] = budgetValues;
                alert("Or√ßamento Padr√£o salvo com sucesso!");
            } 
            else if (editMode === 'single') {
                const month = document.getElementById('budget-month').value;
                if (!month) {
                    alert("Por favor, selecione um m√™s.");
                    return;
                }
                budgets[month] = budgetValues;
                alert(`Or√ßamento para ${formatMonthYear(month)} salvo com sucesso!`);
            } 
            else if (editMode === 'range') {
                const start = document.getElementById('budget-start-month').value;
                const end = document.getElementById('budget-end-month').value;
                if (!start || !end) {
                    alert("Por favor, selecione um m√™s inicial e final.");
                    return;
                }
                let currentDate = new Date(start + '-02'); // Adiciona dia para evitar problemas de fuso hor√°rio
                const endDate = new Date(end + '-02');

                while (currentDate <= endDate) {
                    const monthKey = currentDate.toISOString().substring(0, 7);
                    budgets[monthKey] = { ...(budgets[monthKey] || budgets['default']), ...budgetValues };
                    currentDate.setMonth(currentDate.getMonth() + 1);
                }
                alert(`Or√ßamento aplicado de ${formatMonthYear(start)} at√© ${formatMonthYear(end)}!`);
            }
            
            updateAllUI();
        }
        
        // --- L√ìGICA DE METAS DE POUPAN√áA ---
        function renderGoalsList() {
            const container = document.getElementById('goals-list-container');
            if (!container) return;
            container.innerHTML = '';
            if (savingsGoals.length === 0) {
                container.innerHTML = `<p class="text-sm text-gray-500">Nenhuma meta criada ainda. Crie a sua primeira ao lado!</p>`;
                return;
            }
            savingsGoals.forEach(goal => {
                const savedAmount = savings.filter(s => s.goalId === goal.id).reduce((sum, s) => sum + s.amount, 0);
                const percentage = goal.targetAmount > 0 ? Math.min((savedAmount / goal.targetAmount) * 100, 100) : 0;
                const goalElement = document.createElement('div');
                goalElement.className = 'p-3 border rounded-md';
                goalElement.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold">${goal.name}</span>
                        <button onclick="deleteGoal(${goal.id})" class="text-red-600 hover:text-red-700 text-xs font-semibold">Excluir</button>
                    </div>
                    <div class="flex justify-between text-sm mb-1">
                        <span>Alcan√ßado: ${formatCurrency(savedAmount)}</span>
                        <span>Meta: ${formatCurrency(goal.targetAmount)}</span>
                    </div>
                    <div class="progress-bg">
                        <div class="progress-fill goal" style="width: ${percentage}%;"></div>
                    </div>
                `;
                container.appendChild(goalElement);
            });
        }

        function populateGoalsDropdown() {
            const select = document.getElementById('saving-goal-link');
            if (!select) return;
            const currentValue = select.value;
            select.innerHTML = '<option value="none">Nenhuma</option>';
            savingsGoals.forEach(goal => {
                const option = new Option(`${goal.name} (${formatCurrency(goal.targetAmount)})`, goal.id);
                select.add(option);
            });
            select.value = currentValue;
        }
        
        // --- FUN√á√ïES DE ATUALIZA√á√ÉO E RENDERIZA√á√ÉO ---
        
        // Esta √© a nova fun√ß√£o principal que calcula os dados filtrados
        function getExpensesForBudgetMonth(month, category, payment) {
            let data = [];
            const allEntries = [...expenses, ...futureEntries]; // Combina pagos e futuros
            
            // 1. Define a base de dados (M√™s)
            if (month === 'all') {
                data = [...allEntries];
            } else {
                // Pega gastos normais (D√©bito, PIX, Boleto) PELA DATA DA COMPRA
                const nonCredit = allEntries.filter(e => e.type !== 'Cr√©dito' && e.date.startsWith(month));
                // Pega gastos de Cr√©dito PELO M√äS DA FATURA
                const credit = allEntries.filter(e => e.type === 'Cr√©dito' && e.billMonth === month);
                data = [...nonCredit, ...credit];
            }

            // 2. Filtra por Categoria
            if (category !== 'all') {
                data = data.filter(e => e.category === category);
            }
            
            // 3. Filtra por Pagamento
            if (payment !== 'all') {
                data = data.filter(e => e.type === payment);
            }
            
            return data;
        }
        
        // Fun√ß√£o Central de Atualiza√ß√£o
        function updateAllUI() {
            populateAllMonthFilters(); // Popula todos os seletores de m√™s
            
            // Atualiza Dashboards da Aba Despesas
            syncDespesasView(); // Atualiza a tabela de despesas
            updateDashboardCharts(); // Atualiza todos os gr√°ficos
            
            // Atualiza a aba "Contas a Pagar"
            renderFutureEntriesTable();
            updateUpcomingBills();

            // Atualiza a aba de Renda e Reservas
            renderIncomesTable();
            updateIncomeDashboard();
            updateSavingsDashboard();
            applySavingsFiltersAndRender();
            updateGoalProgress();

            // Atualiza a aba de Metas
            populateGoalsDropdown();
            renderGoalsList();

            // Atualiza o gr√°fico de compara√ß√£o geral
            updateMonthlyComparisonChart();
        }

        // Sincroniza apenas a tabela, com base nos filtros principais
        function syncDespesasView() {
            const month = document.getElementById('filter-month').value;
            const category = document.getElementById('filter-category').value;
            const payment = document.getElementById('filter-payment').value;
            
            // A tabela de hist√≥rico S√ì MOSTRA o que j√° foi pago (expenses)
            let filteredData = (month === 'all')
                ? [...expenses]
                : getExpensesForBudgetMonth(month, 'all', 'all').filter(e => expenses.includes(e));

            if (category !== 'all') {
                filteredData = filteredData.filter(e => e.category === category);
            }
            if (payment !== 'all') {
                filteredData = filteredData.filter(e => e.type === payment);
            }

            const tableShouldBeEmpty = month === 'all' && category === 'all' && payment === 'all';
            renderExpenseTable(tableShouldBeEmpty ? [] : filteredData);
        }

        // Atualiza TODOS os cards do dashboard com base no filtro mestre
        function updateDashboardCharts() {
            const month = document.getElementById('dashboard-month-filter').value;
            const filteredData = getExpensesForBudgetMonth(month, 'all', 'all');

            updateSummaryCards(filteredData, month); 
            updateCostTypeAnalysis(filteredData);
            updateMonthlyAnalysis(filteredData);
            updateBudgetProgress(filteredData, month);
            updatePaymentTypeCommitmentChart(filteredData, month);
            updateBillByBankChart(filteredData);
        }


        // Popula TODOS os filtros de m√™s
        function populateAllMonthFilters() {
            const allExpenseMonths = expenses.map(e => e.type === 'Cr√©dito' ? e.billMonth : e.date.substring(0, 7));
            const allFutureMonths = futureEntries.map(e => e.type === 'Cr√©dito' ? e.billMonth : e.date.substring(0, 7));
            const allMonths = [...allExpenseMonths, ...allFutureMonths].filter(m => m); // Remove nulos
            
            const uniqueMonths = [...new Set(allMonths)].sort(); // Ordem Crescente
            
            const monthFilters = [
                'filter-month',
                'dashboard-month-filter'
            ];

            const now = new Date();
            const currentMonthKey = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;

            monthFilters.forEach(filterId => {
                const select = document.getElementById(filterId);
                if (!select) return;
                
                const currentVal = select.value;
                select.innerHTML = '<option value="all">Todos os Meses</option>';
                uniqueMonths.forEach(m => select.add(new Option(formatMonthYear(m), m)));
                
                if (uniqueMonths.includes(currentVal)) {
                    select.value = currentVal;
                } else if (filterId === 'filter-month') {
                    select.value = 'all';
                } else {
                    select.value = uniqueMonths.includes(currentMonthKey) ? currentMonthKey : (uniqueMonths[uniqueMonths.length - 1] || 'all');
                }
            });
        }

        function renderMonthlyIncomes() {
             // Esta fun√ß√£o foi substitu√≠da por renderIncomesTable e updateIncomeDashboard
        }
        
        function renderIncomesTable() {
            const tableBody = document.getElementById('incomes-table-body');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            if (incomes.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-10 text-gray-500">Nenhuma renda adicionada.</td></tr>`;
                return;
            }
            incomes.sort((a,b) => b.month.localeCompare(a.month)).forEach(income => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="M√™s" class="px-6 py-4 whitespace-nowrap text-sm font-medium">${formatMonthYear(income.month)}</td>
                    <td data-label="Descri√ß√£o" class="px-6 py-4 whitespace-nowrap text-sm">${income.description}</td>
                    <td data-label="Valor" class="px-6 py-4 whitespace-nowrap text-sm text-green-500 text-right font-semibold">${formatCurrency(income.amount)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium actions-cell">
                        <button onclick="deleteIncome(${income.id})" class="text-red-600 hover:text-red-900">Excluir</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function updateIncomeDashboard() {
            const total = incomes.reduce((sum, i) => sum + i.amount, 0);
            const totalEl = document.getElementById('total-income');
            if (totalEl) {
                totalEl.textContent = formatCurrency(total);
            }

            if (monthlyIncomeChart) monthlyIncomeChart.destroy();
            
            const monthlyData = incomes.reduce((acc, income) => {
                const month = income.month;
                acc[month] = (acc[month] || 0) + income.amount;
                return acc;
            }, {});
            const sortedMonths = Object.keys(monthlyData).sort();

            const incomeChartEl = document.getElementById('monthly-income-chart');
            if (incomeChartEl) {
                monthlyIncomeChart = new Chart(incomeChartEl, {
                    type: 'bar',
                    data: { 
                        labels: sortedMonths.map(formatMonthYear), 
                        datasets: [{ 
                            label: 'Renda Recebida', 
                            data: sortedMonths.map(m => monthlyData[m]), 
                            backgroundColor: '#10b981' 
                        }] 
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
                });
            }
        }

        function updateSummaryCards(filteredData, month) {
            // Calcula a renda relevante para o m√™s (ou todos)
            const relevantIncome = (month === 'all')
                ? incomes.reduce((sum, income) => sum + income.amount, 0)
                : incomes.filter(i => i.month === month).reduce((sum, i) => sum + i.amount, 0);
            
            const total = filteredData.reduce((s, e) => s + e.amount, 0);
            
            document.getElementById('total-expenses').textContent = formatCurrency(total);
            document.getElementById('income-percentage').textContent = `${(relevantIncome > 0 ? (total / relevantIncome) * 100 : 0).toFixed(1)}%`;
            document.getElementById('remaining-balance').textContent = formatCurrency(relevantIncome - total);
        }

        function updateMonthlyAnalysis(filteredData) {
            const chartCanvas = document.getElementById('monthly-category-chart');
            const detailsContainer = document.getElementById('monthly-analysis-details');
            if (monthlyCategoryChart) monthlyCategoryChart.destroy();
            
            if (filteredData.length === 0) {
                detailsContainer.innerHTML = '';
                chartCanvas.style.display = 'none';
                return;
            }
            chartCanvas.style.display = 'block';
            const categoryData = filteredData.reduce((acc, {category, amount}) => ({...acc, [category]: (acc[category] || 0) + amount}), {});
            
            const month = document.getElementById('dashboard-month-filter').value;
            let detailsHtml = `<strong>Resumo de ${month === 'all' ? 'Todos os Meses' : formatMonthYear(month)}:</strong><ul class="list-disc ml-4 mt-2">`;
            Object.entries(categoryData).sort(([,a],[,b]) => b-a).forEach(([cat, amt]) => detailsHtml += `<li>${cat}: <strong>${formatCurrency(amt)}</strong></li>`);
            detailsContainer.innerHTML = detailsHtml + '</ul>';
            
            monthlyCategoryChart = new Chart(chartCanvas, {
                type: 'pie', data: { labels: Object.keys(categoryData), datasets: [{ data: Object.values(categoryData), backgroundColor: ['#4f46e5', '#ec4899', '#f59e0b', '#10b981', '#ef4444', '#3b82f6', '#8b5cf6', '#64748b', '#06b6d4', '#f97316'] }] },
                options: { responsive: true, plugins: { legend: { position: 'top' } } }
            });
        }
        
        function updateCostTypeAnalysis(filteredData) {
            if (costTypeChart) costTypeChart.destroy();
            const costData = filteredData.reduce((acc, {costType, amount}) => {
                acc[costType] = (acc[costType] || 0) + amount;
                return acc;
            }, { 'Fixo': 0, 'Vari√°vel': 0 });
            costTypeChart = new Chart(document.getElementById('cost-type-chart'), {
                type: 'pie',
                data: { labels: Object.keys(costData), datasets: [{ data: Object.values(costData), backgroundColor: ['#3b82f6', '#f59e0b'] }] },
                options: { responsive: true, plugins: { legend: { position: 'top' } } }
            });
        }

        function updateBudgetProgress(filteredData, month) {
            const container = document.getElementById('budget-progress-container');
            if (!container) return;
            
            const monthKey = month === 'all' ? 'default' : month;
            const budgetToDisplay = budgets[monthKey] || budgets["default"];

            if (!budgetToDisplay || Object.keys(budgetToDisplay).length === 0) {
                container.innerHTML = `<p class="text-sm text-gray-500">Crie um or√ßamento na aba 'Or√ßamentos' para ver o progresso.</p>`;
                return;
            }

            container.innerHTML = '';
            let contentRendered = false;
            Object.keys(budgetToDisplay).sort().forEach(category => {
                contentRendered = true;
                const budgetAmount = budgetToDisplay[category];
                const spentAmount = filteredData.filter(e => e.category === category).reduce((sum, e) => sum + e.amount, 0);
                const percentage = budgetAmount > 0 ? Math.min((spentAmount / budgetAmount) * 100, 100) : 0;
                let colorClass = 'budget';
                if (percentage > 75) colorClass += ' yellow';
                if (percentage >= 100) colorClass += ' red';
                const progressElement = document.createElement('div');
                progressElement.innerHTML = `
                    <div class="flex justify-between text-sm mb-1">
                        <span class="font-medium">${category}</span>
                        <span>${formatCurrency(spentAmount)} / ${formatCurrency(budgetAmount)}</span>
                    </div>
                    <div class="progress-bg">
                        <div class="progress-fill ${colorClass}" style="width: ${percentage}%;"></div>
                    </div>
                `;
                container.appendChild(progressElement);
            });
            if (!contentRendered) {
                 container.innerHTML = `<p class="text-sm text-gray-500">Nenhum or√ßamento definido para ${month === 'all' ? 'o modo Padr√£o' : formatMonthYear(month)}.</p>`;
            }
        }
        
        function applySavingsFiltersAndRender() {
            const monthFilter = document.getElementById('filter-saving-month').value;
            const typeFilter = document.getElementById('filter-saving-type').value;
            if (monthFilter === 'all' && typeFilter === 'all') {
                renderSavingsTable([]);
                return;
            }
            let filteredSavings = [...savings];
            if (monthFilter !== 'all') {
                filteredSavings = filteredSavings.filter(s => s.month === monthFilter);
            }
            if (typeFilter !== 'all') {
                filteredSavings = filteredSavings.filter(s => s.type === typeFilter);
            }
            renderSavingsTable(filteredSavings);
        }

        function renderSavingsTable(savingsToRender) {
            const savingsTableBody = document.getElementById('savings-table-body');
            savingsTableBody.innerHTML = '';
            if (savingsToRender.length === 0) {
                const message = "Use os filtros acima para ver o hist√≥rico de reservas.";
                savingsTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-10 text-gray-500">${message}</td></tr>`;
                return;
            }
            savingsToRender.sort((a, b) => b.month.localeCompare(a.month)).forEach(saving => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="M√™s" class="px-6 py-4 whitespace-nowrap text-sm font-medium">${formatMonthYear(saving.month)}</td>
                    <td data-label="Tipo" class="px-6 py-4 whitespace-nowrap text-sm">${saving.type}</td>
                    <td data-label="Valor" class="px-6 py-4 whitespace-nowrap text-sm text-green-500 text-right font-semibold">${formatCurrency(saving.amount)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium actions-cell">
                        <button onclick="deleteSaving(${saving.id})" class="text-red-600 hover:text-red-900">Excluir</button>
                    </td>
                `;
                savingsTableBody.appendChild(row);
            });
        }

        function updateSavingsDashboard() {
            const total = savings.reduce((sum, s) => sum + s.amount, 0);
            document.getElementById('total-savings').textContent = formatCurrency(total);
            const uniqueMonths = [...new Set(savings.map(s => s.month))].sort(); // Ordem Crescente
            const monthFilterEl = document.getElementById('filter-saving-month');
            const currentMonthVal = monthFilterEl.value;
            monthFilterEl.innerHTML = '<option value="all">Todos os Meses</option>';
            uniqueMonths.forEach(m => monthFilterEl.add(new Option(formatMonthYear(m), m)));
            monthFilterEl.value = currentMonthVal;
            const byTypeData = savings.reduce((acc, {type, amount}) => {
                const key = type;
                acc[key] = (acc[key] || 0) + amount;
                return acc;
            }, {});
            if (savingsByTypeChart) savingsByTypeChart.destroy();
            savingsByTypeChart = new Chart(document.getElementById('savings-by-type-chart'), {
                type: 'bar',
                data: { 
                    labels: Object.keys(byTypeData), 
                    datasets: [{ 
                        label: 'Total Guardado',
                        data: Object.values(byTypeData), 
                        backgroundColor: ['#10b981', '#f59e0b', '#3b82f6', '#8b5cf6']
                    }] 
                },
                options: { 
                    responsive: true,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        function renderExpenseTable(expensesToRender) {
             const expenseTableBody = document.getElementById('expense-table-body');
            expenseTableBody.innerHTML = '';
            if (expensesToRender.length === 0) {
                 const isFiltered = document.getElementById('filter-month').value !== 'all' || document.getElementById('filter-category').value !== 'all' || document.getElementById('filter-payment').value !== 'all';
                 const message = isFiltered ? "Nenhum resultado para os filtros." : "Use os filtros para ver o hist√≥rico.";
                 expenseTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-gray-500">${message}</td></tr>`;
                 return;
             }
            expensesToRender.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(expense => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Data">${formatDate(expense.date)}</td>
                    <td data-label="Descri√ß√£o">${expense.description}</td>
                    <td data-label="Categoria">${expense.category}</td>
                    <td data-label="Pagamento">${expense.type}</td>
                    <td data-label="Valor" class="text-red-500 font-medium">${formatCurrency(expense.amount)}</td>
                    <td data-label="A√ß√µes" class="actions-cell">
                        <button onclick="openEditModal(${expense.id}, false)" class="text-blue-600 hover:text-blue-900">Editar</button>
                        <button onclick="deleteEntry(${expense.id}, false)" class="text-red-600 hover:text-red-900">Excluir</button>
                    </td>
                `;
                expenseTableBody.appendChild(row);
            });
        }

        function renderFutureEntriesTable() {
            const tableBody = document.getElementById('future-entries-table-body');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            if (futureEntries.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-gray-500">Nenhuma conta a pagar registada.</td></tr>`;
                return;
            }
            futureEntries.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(entry => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Vencimento">${formatDate(entry.date)}</td>
                    <td data-label="Descri√ß√£o">${entry.description}</td>
                    <td data-label="Categoria">${entry.category}</td>
                    <td data-label="Pagamento">${entry.type}</td>
                    <td data-label="Valor" class="text-yellow-500 font-medium">${formatCurrency(entry.amount)}</td>
                    <td data-label="A√ß√µes" class="actions-cell">
                        <button onclick="payEntry(${entry.id})" class="text-green-600 hover:text-green-900">Pagar</button>
                        <button onclick="openEditModal(${entry.id}, true)" class="text-blue-600 hover:text-blue-900">Editar</button>
                        <button onclick="deleteEntry(${entry.id}, true)" class="text-red-600 hover:text-red-900">Excluir</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function updateUpcomingBills() {
            const container = document.getElementById('upcoming-bills-container');
            if (!container) return;
            const upcoming = futureEntries.sort((a,b) => new Date(a.date) - new Date(b.date)).slice(0, 3);
            if (upcoming.length === 0) {
                container.innerHTML = `<p class="text-sm text-gray-500">Nenhuma conta a pagar registada para breve.</p>`;
                return;
            }
            container.innerHTML = '';
            upcoming.forEach(entry => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center text-sm';
                div.innerHTML = `
                    <div>
                        <span class="font-medium">${entry.description}</span>
                        <span class="block text-xs">${formatDate(entry.date)}</span>
                    </div>
                    <span class="font-semibold text-yellow-500">${formatCurrency(entry.amount)}</span>
                `;
                container.appendChild(div);
            });
        }
        
        function updateGoalProgress() {
            const container = document.getElementById('goal-progress-container');
            if (!container) return;
            container.innerHTML = '';
            if (savingsGoals.length === 0) {
                 container.innerHTML = `<p class="text-sm text-gray-500">Crie uma meta na aba 'Metas' para ver o progresso aqui.</p>`;
                 return;
            }
            savingsGoals.forEach(goal => {
                 const savedAmount = savings.filter(s => s.goalId === goal.id).reduce((sum, s) => sum + s.amount, 0);
                 const percentage = goal.targetAmount > 0 ? Math.min((savedAmount / goal.targetAmount) * 100, 100) : 0;
                 const progressElement = document.createElement('div');
                 progressElement.innerHTML = `
                    <div class="flex justify-between text-sm mb-1">
                        <span class="font-medium">${goal.name}</span>
                        <span>${percentage.toFixed(1)}%</span>
                    </div>
                    <div class="progress-bg">
                        <div class="progress-fill goal" style="width: ${percentage}%;"></div>
                    </div>
                 `;
                 container.appendChild(progressElement);
            });
        }
        
        // --- TEMA E DICAS (VERS√ÉO CORRIGIDA) ---
        function applyTheme(theme) {
            const sunIcon = document.getElementById('theme-icon-sun');
            const moonIcon = document.getElementById('theme-icon-moon');
            if (theme === 'dark') {
                document.body.classList.add('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                document.body.classList.remove('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
            updateChartTheme(); // 1. Define as novas cores
            updateAllUI();      // 2. Redesenha toda a UI UMA VEZ com as novas cores
        }
        function toggleTheme() {
            const newTheme = document.body.classList.contains('dark') ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        }
        function updateChartTheme() {
            const isDark = document.body.classList.contains('dark');
            const textColor = isDark ? '#d1d5db' : '#374151';
            Chart.defaults.color = textColor;
            // CORRE√á√ÉO: A chamada para updateAllUI() foi REMOVIDA daqui.
        }
        function initializeTips() {
            const dismissedTips = JSON.parse(localStorage.getItem('dismissedTips')) || [];
            document.querySelectorAll('.mini-tip').forEach(tip => {
                if (!dismissedTips.includes(tip.id)) {
                    tip.style.display = 'block';
                } else {
                    tip.style.display = 'none';
                }
            });
        }
        window.dismissTip = (tipId) => {
            const dismissedTips = JSON.parse(localStorage.getItem('dismissedTips')) || [];
            if (!dismissedTips.includes(tipId)) {
                dismissedTips.push(tipId);
                localStorage.setItem('dismissedTips', JSON.stringify(dismissedTips));
            }
            document.getElementById(tipId).style.display = 'none';
        }

        // --- FUN√á√ïES DE EXPORTA√á√ÉO E GR√ÅFICOS ---
        function exportToCsv(dataType) {
            let data;
            if(dataType === 'expenses') data = expenses;
            else if (dataType === 'savings') data = savings;
            else data = futureEntries;

            if (data.length === 0) {
                alert(`N√£o h√° dados para exportar.`);
                return;
            }
            const headers = Object.keys(data[0]);
            const csvRows = [headers.join(',')];
            data.forEach(item => {
                const values = headers.map(header => {
                    let value = item[header];
                    if (typeof value === 'string' && value.includes(',')) {
                        value = `"${value}"`;
                    }
                    return value;
                });
                csvRows.push(values.join(','));
            });
            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `${dataType}_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function updateMonthlyComparisonChart() {
            if (monthlyComparisonChart) {
                monthlyComparisonChart.destroy();
            }
            const allEntries = [...expenses, ...futureEntries];
            const monthlyData = allEntries.reduce((acc, exp) => {
                const month = exp.type === 'Cr√©dito' ? exp.billMonth : exp.date.substring(0, 7);
                if (month) {
                    acc[month] = (acc[month] || 0) + exp.amount;
                }
                return acc;
            }, {});
            const sortedMonths = Object.keys(monthlyData).sort(); // Ordem Crescente
            monthlyComparisonChart = new Chart(document.getElementById('monthly-comparison-chart'), {
                type: 'line',
                data: {
                    labels: sortedMonths.map(formatMonthYear),
                    datasets: [{
                        label: 'Total de Gastos',
                        data: sortedMonths.map(month => monthlyData[month]),
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updatePaymentTypeCommitmentChart(filteredData, month) {
            if (paymentCommitmentChart) paymentCommitmentChart.destroy();
            const container = document.getElementById('payment-commitment-chart');
            if(!container) return;
            
            const relevantIncome = (month === 'all')
                ? incomes.reduce((sum, income) => sum + income.amount, 0)
                : incomes.filter(i => i.month === month).reduce((sum, i) => sum + i.amount, 0);

            if (relevantIncome === 0 || filteredData.length === 0) {
                container.style.display = 'none';
                return;
            }
            container.style.display = 'block';

            const paymentData = filteredData.reduce((acc, {type, amount}) => {
                acc[type] = (acc[type] || 0) + amount;
                return acc;
            }, {});

            const labels = Object.keys(paymentData);
            const dataValues = labels.map(label => ((paymentData[label] / relevantIncome) * 100).toFixed(2) );
            paymentCommitmentChart = new Chart(container.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ data: dataValues, backgroundColor: ['#3b82f6', '#ec4899', '#f59e0b', '#8b5cf6'] }]
                },
                options: {
                    indexAxis: 'y', responsive: true, scales: { x: { beginAtZero: true, ticks: { callback: (value) => value + '%' } } },
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: (context) => ` ${context.raw}% da renda` } } }
                }
            });
        }
        
        function updateBillByBankChart(filteredData) {
            if (billByBankChart) billByBankChart.destroy();
            
            const creditExpenses = filteredData.filter(e => e.type === 'Cr√©dito');
            const container = document.getElementById('bill-by-bank-chart');
            if (!container) return;

            if (creditExpenses.length === 0) {
                container.style.display = 'none';
                return;
            }
            container.style.display = 'block';

            const bankData = creditExpenses.reduce((acc, {bank, amount}) => {
                acc[bank] = (acc[bank] || 0) + amount;
                return acc;
            }, {});
            
            const labels = Object.keys(bankData);
            const colors = labels.map(bank => BANK_COLORS[bank] || BANK_COLORS['Outro']);

            billByBankChart = new Chart(container.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ 
                        label: 'Valor da Fatura', 
                        data: Object.values(bankData),
                        backgroundColor: colors
                    }]
                },
                options: {
                    indexAxis: 'y', responsive: true, scales: { x: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- FUN√á√ÉO GEMINI API ---
        async function callGeminiAPI() {
            const geminiButton = document.getElementById('gemini-button');
            if (expenses.length === 0 && futureEntries.length === 0 && incomes.length === 0 && savings.length === 0) {
                document.getElementById('analysis-text').innerHTML = '<p>Por favor, adicione alguns dados antes de pedir uma an√°lise.</p>';
                return;
            }
            geminiButton.disabled = true;
            geminiButton.innerHTML = `<svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Gerando...`;
            document.getElementById('analysis-text').innerHTML = '<p>Analisando seus dados financeiros... Isso pode levar um momento.</p>';
            
            const incomesText = incomes.map(i => `- M√™s: ${formatMonthYear(i.month)}, Descri√ß√£o: ${i.description}, Valor: ${formatCurrency(i.amount)}`).join('\n');
            const expensesText = expenses.map(e => `- Data: ${e.date}, Descri√ß√£o: ${e.description}, Categoria: ${e.category}, Valor: ${formatCurrency(e.amount)}`).join('\n');
            const futureText = futureEntries.map(e => `- Vencimento: ${e.date}, Descri√ß√£o: ${e.description}, Categoria: ${e.category}, Valor: ${formatCurrency(e.amount)}`).join('\n');
            const savingsText = savings.map(s => `- M√™s: ${formatMonthYear(s.month)}, Tipo: ${s.type}, Valor: ${formatCurrency(s.amount)}`).join('\n');
            
            const systemPrompt = "Voc√™ √© um consultor financeiro amig√°vel e prestativo. Sua tarefa √© analisar os dados de despesas, rendas e reservas de um usu√°rio e fornecer dicas personalizadas, pr√°ticas e acion√°veis para economizar dinheiro. Responda em portugu√™s do Brasil. Formate sua resposta usando markdown simples (cabe√ßalhos com ##, negrito com **, e listas com *).";
            const userQuery = `Analise meus dados financeiros e me d√™ dicas para melhorar minha sa√∫de financeira.\n\n**Minhas Rendas:**\n${incomesText || 'Nenhuma renda registrada.'}\n\n**Minhas Despesas Pagas:**\n${expensesText || 'Nenhuma despesa registrada.'}\n\n**Minhas Contas a Pagar:**\n${futureText || 'Nenhuma conta a pagar registrada.'}\n\n**Minhas Reservas:**\n${savingsText || 'Nenhuma reserva registrada.'}`;
            
            const geminiApiKey = "AIzaSyC9eCGpgJuypWE98f19Z2XZ3QFeHHjU4_4";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`;
            try {
                const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const errorBody = await response.json(); throw new Error(`HTTP error! status: ${response.status}, message: ${errorBody.error.message}`); }
                const result = await response.json();
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    document.getElementById('analysis-text').innerHTML = candidate.content.parts[0].text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/^\* (.*$)/gm, '<li class="ml-4 list-disc">$1</li>').replace(/\n/g, '<br>');
                } else { throw new Error("Resposta da API inv√°lida ou vazia."); }
            } catch (error) {
                console.error("Erro ao chamar a API Gemini:", error);
                document.getElementById('analysis-text').innerHTML = `<p class="text-red-500"><strong>Erro!</strong> N√£o foi poss√≠vel gerar as dicas. Por favor, tente novamente mais tarde.</p>`;
            } finally {
                geminiButton.disabled = false;
                geminiButton.innerHTML = '‚ú® Gerar Dicas com IA';
            }
        }
        
        // --- FUN√á√ïES DE A√á√ÉO (DELETE, PAY) ---
        window.deleteEntry = (id, isFuture) => { 
            const sourceArray = isFuture ? futureEntries : expenses;
            const index = sourceArray.findIndex(e => e.id === id);
            if (index === -1) return;

            const entry = sourceArray[index];
            if (entry.recurrenceId) {
                if (confirm("Este √© um lan√ßamento recorrente. Deseja apagar tamb√©m os futuros?")) {
                    if(isFuture) {
                        futureEntries = futureEntries.filter(e => !(e.recurrenceId === entry.recurrenceId && new Date(e.date) >= new Date(entry.date)));
                    } else {
                        expenses = expenses.filter(e => !(e.recurrenceId === entry.recurrenceId && new Date(e.date) >= new Date(entry.date)));
                    }
                } else {
                    sourceArray.splice(index, 1);
                }
            } else {
                sourceArray.splice(index, 1);
            }
            updateAllUI(); 
        };

        window.payEntry = (id) => {
            const index = futureEntries.findIndex(e => e.id === id);
            if (index === -1) return;
            const [entry] = futureEntries.splice(index, 1);
            entry.date = new Date().toISOString().split('T')[0]; // Atualiza a data para o dia do pagamento
            expenses.push(entry); 
            updateAllUI();
        };

        window.deleteIncome = (id) => { 
            incomes = incomes.filter(i => i.id !== id); 
            updateAllUI(); 
        };
        window.deleteSaving = (id) => { savings = savings.filter(s => s.id !== id); updateAllUI(); };
        window.deleteGoal = (id) => {
            if (confirm("Tem certeza que deseja apagar esta meta? As poupan√ßas associadas n√£o ser√£o apagadas, mas ficar√£o sem meta.")) {
                savingsGoals = savingsGoals.filter(g => g.id !== id);
                savings.forEach(s => {
                    if (s.goalId === id) { s.goalId = null; }
                });
                updateAllUI();
            }
        };

        // --- L√ìGICA DE VISIBILIDADE DE CAMPOS ---
        function toggleBillMonthField(formType) {
            const prefix = formType === 'edit' ? 'edit-' : '';
            const paymentType = document.getElementById(`${prefix}payment-type`).value;
            const container = document.getElementById(`${prefix}bill-month-container`);
            const input = document.getElementById(`${prefix}bill-month`);
            
            if (paymentType === 'Cr√©dito') {
                container.classList.remove('hidden');
                input.required = true;
                if(!input.value) { // Sugere o pr√≥ximo m√™s
                    const now = new Date();
                    now.setMonth(now.getMonth() + 1);
                    input.value = now.toISOString().substring(0, 7);
                }
            } else {
                container.classList.add('hidden');
                input.required = false;
                input.value = '';
            }
        }
        
        // --- INICIALIZA√á√ÉO E LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            const expenseForm = document.getElementById('expense-form');
            const incomeForm = document.getElementById('income-form');
            const savingForm = document.getElementById('saving-form');
            const goalForm = document.getElementById('goal-form');
            const editForm = document.getElementById('edit-expense-form');
            const cancelEditButton = document.getElementById('cancel-edit-button');
            const themeToggleButton = document.getElementById('theme-toggle-button');
            const geminiButton = document.getElementById('gemini-button');
            const authButton = document.getElementById('google-auth-button');
            const saveDataButton = document.getElementById('save-data-button');
            
            const tabDespesas = document.getElementById('tab-despesas');
            const tabContas = document.getElementById('tab-contas');
            const tabRenda = document.getElementById('tab-renda');
            const tabReservas = document.getElementById('tab-reservas');
            const tabOrcamentos = document.getElementById('tab-orcamentos');
            const tabMetas = document.getElementById('tab-metas');
            
            const budgetMonthInput = document.getElementById('budget-month');
            const saveBudgetButton = document.getElementById('save-budget-button');
            const budgetModeRadios = document.querySelectorAll('input[name="budget-edit-mode"]');
            
            // Listeners dos Filtros Principais (s√≥ para a tabela)
            const filters = [document.getElementById('filter-month'), document.getElementById('filter-category'), document.getElementById('filter-payment')];
            filters.forEach(el => el.addEventListener('change', syncDespesasView));

            // Listener do Filtro Mestre do Dashboard
            document.getElementById('dashboard-month-filter').addEventListener('change', updateDashboardCharts);
            
            const savingFilters = [document.getElementById('filter-saving-month'), document.getElementById('filter-saving-type')];
            savingFilters.forEach(el => el.addEventListener('change', applySavingsFiltersAndRender));

            // Setup Inicial
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.getElementById('date').valueAsDate = new Date();
            applyTheme(savedTheme); // Isso vai chamar updateChartTheme() e updateAllUI()
            updateSigninStatus(false);
            
            authButton.addEventListener('click', () => {
                 if (gapi.client.getToken() === null) {
                     tokenClient.requestAccessToken({prompt: 'consent'});
                } else {
                    const token = gapi.client.getToken();
                    if (token) {
                        google.accounts.oauth2.revoke(token.access_token, () => {
                            gapi.client.setToken(null);
                            localStorage.removeItem('googleSession');
                            updateSigninStatus(false);
                        });
                    } else {
                        localStorage.removeItem('googleSession');
                        updateSigninStatus(false);
                    }
                }
            });

            const tabs = [
                { button: tabDespesas, view: document.getElementById('despesas-view') },
                { button: tabContas, view: document.getElementById('contas-a-pagar-view') },
                { button: tabRenda, view: document.getElementById('renda-view') },
                { button: tabReservas, view: document.getElementById('reservas-view') },
                { button: tabOrcamentos, view: document.getElementById('orcamentos-view') },
                { button: tabMetas, view: document.getElementById('metas-view') }
            ];
            tabs.forEach(tab => {
                tab.button.addEventListener('click', () => {
                    tabs.forEach(t => {
                        t.button.classList.remove('active');
                        t.view.classList.add('hidden');
                    });
                    tab.button.classList.add('active');
                    tab.view.classList.remove('hidden');
                    
                    // L√≥gica espec√≠fica ao abrir cada aba
                    if (tab.button.id === 'tab-renda') { updateAllUI(); }
                    if (tab.button.id === 'tab-reservas') { populateGoalsDropdown(); }
                    if (tab.button.id === 'tab-orcamentos') {
                        document.getElementById('budget-mode-default').checked = true;
                        document.getElementById('budget-date-pickers').classList.add('hidden');
                        document.getElementById('budget-single-month-container').classList.add('hidden');
                        document.getElementById('budget-range-container').classList.add('hidden');
                        renderBudgetInputs('default');
                    }
                    if (tab.button.id === 'tab-metas') { renderGoalsList(); }
                    if (tab.button.id === 'tab-contas') { renderFutureEntriesTable(); }
                });
            });

            // Listeners da p√°gina de Or√ßamentos
            budgetModeRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const mode = e.target.value;
                    const datePickers = document.getElementById('budget-date-pickers');
                    const singleMonth = document.getElementById('budget-single-month-container');
                    const rangeMonth = document.getElementById('budget-range-container');
                    
                    datePickers.classList.remove('hidden');
                    if (mode === 'default') {
                        datePickers.classList.add('hidden');
                        singleMonth.classList.add('hidden');
                        rangeMonth.classList.add('hidden');
                        renderBudgetInputs('default');
                    } else if (mode === 'single') {
                        singleMonth.classList.remove('hidden');
                        rangeMonth.classList.add('hidden');
                        const monthInput = document.getElementById('budget-month');
                        if (!monthInput.value) {
                            const now = new Date();
                            const year = now.getFullYear();
                            const month = (now.getMonth() + 1).toString().padStart(2, '0');
                            monthInput.value = `${year}-${month}`;
                        }
                        renderBudgetInputs(monthInput.value);
                    } else if (mode === 'range') {
                        singleMonth.classList.add('hidden');
                        rangeMonth.classList.remove('hidden');
                        renderBudgetInputs('range'); // 'range' vai limpar os campos
                    }
                });
            });
            budgetMonthInput.addEventListener('change', () => { renderBudgetInputs(budgetMonthInput.value); });
            saveBudgetButton.addEventListener('click', saveBudgets);

            goalForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('goal-name').value;
                const target = parseFloat(document.getElementById('goal-target').value);
                if (name && target > 0) {
                    savingsGoals.push({ id: Date.now(), name: name, targetAmount: target });
                    updateAllUI();
                    goalForm.reset();
                }
            });

            expenseForm.addEventListener('submit', e => {
                e.preventDefault();
                const isRecurring = document.getElementById('is-recurring').checked;
                const isFuture = document.getElementById('is-future-entry').checked;
                const paymentType = document.getElementById('payment-type').value;
                const billMonth = document.getElementById('bill-month').value;
                
                if (paymentType === 'Cr√©dito' && !billMonth) {
                    alert('Por favor, selecione o m√™s da fatura para gastos com Cart√£o de Cr√©dito.');
                    return;
                }

                const recurrenceId = isRecurring ? Date.now() : null;
                const baseExpense = {
                    costType: document.getElementById('cost-type').value, 
                    type: paymentType,
                    description: document.getElementById('description').value, 
                    amount: parseFloat(document.getElementById('amount').value),
                    category: document.getElementById('category').value, 
                    bank: document.getElementById('bank').value, 
                    recurrenceId: recurrenceId,
                    billMonth: paymentType === 'Cr√©dito' ? billMonth : null
                };
                
                const destinationArray = isFuture ? futureEntries : expenses;

                if (isRecurring) {
                    const startDate = new Date(document.getElementById('date').value + 'T00:00:00');
                    const endDate = new Date(document.getElementById('recurrence-end-date').value + 'T00:00:00');
                    if (!document.getElementById('recurrence-end-date').value || startDate > endDate) return;
                    let currentDate = new Date(startDate.getTime());
                    while (currentDate <= endDate) {
                        destinationArray.push({ ...baseExpense, id: Date.now() + currentDate.getTime(), date: currentDate.toISOString().split('T')[0] });
                        currentDate.setMonth(currentDate.getMonth() + 1);
                    }
                } else {
                    destinationArray.push({ ...baseExpense, id: Date.now(), date: document.getElementById('date').value });
                }
                updateAllUI();
                expenseForm.reset();
                document.getElementById('date').valueAsDate = new Date();
                document.getElementById('is-recurring').checked = false;
                document.getElementById('is-future-entry').checked = false;
                document.getElementById('recurring-options').classList.add('hidden');
                toggleBillMonthField('form');
            });

            // CORRE√á√ÉO: Listener do formul√°rio de Renda
            incomeForm.addEventListener('submit', e => { 
                e.preventDefault(); 
                const month = document.getElementById('income-month').value;
                const description = document.getElementById('income-description').value;
                const amount = parseFloat(document.getElementById('income-amount').value); 

                if(month && description && amount > 0) { 
                    incomes.push({ 
                        id: Date.now(), 
                        month: month, 
                        description: description, 
                        amount: amount 
                    });
                    updateAllUI(); 
                    incomeForm.reset(); 
                } else {
                    alert("Por favor, preencha todos os campos da renda.");
                }
            });
            
            savingForm.addEventListener('submit', e => {
                e.preventDefault();
                const goalId = document.getElementById('saving-goal-link').value;
                savings.push({ 
                    id: Date.now(), 
                    month: document.getElementById('saving-month').value, 
                    type: document.getElementById('saving-type').value, 
                    amount: parseFloat(document.getElementById('saving-amount').value),
                    goalId: goalId !== 'none' ? parseInt(goalId) : null
                });
                updateAllUI();
                savingForm.reset();
            });
            
            editForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = parseInt(document.getElementById('edit-expense-id').value);
                const isFuture = document.getElementById('edit-is-future').value === 'true';
                const sourceArray = isFuture ? futureEntries : expenses;
                const scope = document.getElementById('edit-recurrence-scope').value;
                const paymentType = document.getElementById('edit-payment-type').value;
                const billMonth = document.getElementById('edit-bill-month').value;

                if (paymentType === 'Cr√©dito' && !billMonth) {
                    alert('Por favor, selecione o m√™s da fatura para gastos com Cart√£o de Cr√©dito.');
                    return;
                }

                const updatedData = {
                    date: document.getElementById('edit-date').value, costType: document.getElementById('edit-cost-type').value,
                    category: document.getElementById('edit-category').value, type: paymentType,
                    description: document.getElementById('edit-description').value, bank: document.getElementById('edit-bank').value,
                    amount: parseFloat(document.getElementById('edit-amount').value),
                    billMonth: paymentType === 'Cr√©dito' ? billMonth : null
                };
                const originalEntry = sourceArray.find(e => e.id === id);
                if (scope === 'single' || !originalEntry.recurrenceId) {
                    const index = sourceArray.findIndex(e => e.id === id);
                    sourceArray[index] = { ...sourceArray[index], ...updatedData };
                } else {
                    const sourceId = originalEntry.recurrenceId;
                    const sourceDate = new Date(originalEntry.date);
                    
                    const updateLogic = (entry) => {
                        let shouldUpdate = false;
                        if (entry.recurrenceId === sourceId) {
                            if (scope === 'all') shouldUpdate = true;
                            if (scope === 'future' && new Date(entry.date) >= sourceDate) shouldUpdate = true;
                        }
                        return shouldUpdate;
                    };

                    expenses.forEach((expense, index) => {
                        if (updateLogic(expense)) {
                            expenses[index] = { ...expense, ...updatedData, date: expense.date, id: expense.id, recurrenceId: expense.recurrenceId };
                        }
                    });
                    futureEntries.forEach((entry, index) => {
                         if (updateLogic(entry)) {
                            futureEntries[index] = { ...entry, ...updatedData, date: entry.date, id: entry.id, recurrenceId: entry.recurrenceId };
                        }
                    });
                }
                document.getElementById('edit-modal').classList.remove('visible');
                updateAllUI();
            });

            // Listeners para mostrar/esconder o campo de M√™s da Fatura
            document.getElementById('payment-type').addEventListener('change', () => toggleBillMonthField('form'));
            document.getElementById('edit-payment-type').addEventListener('change', () => toggleBillMonthField('edit'));

            cancelEditButton.addEventListener('click', () => document.getElementById('edit-modal').classList.remove('visible'));
            themeToggleButton.addEventListener('click', toggleTheme);
            geminiButton.addEventListener('click', callGeminiAPI);
            saveDataButton.addEventListener('click', saveDataToDrive);
            
            document.getElementById('is-recurring').addEventListener('change', (e) => { 
                document.getElementById('recurring-options').classList.toggle('hidden', !e.target.checked);
                document.getElementById('recurrence-end-date').required = e.target.checked;
            });

            // Corre√ß√£o: Chamar a fun√ß√£o para esconder o campo "M√™s Fatura" no carregamento inicial
            toggleBillMonthField('form');
            
        });
    </script>
</body>
</html>
