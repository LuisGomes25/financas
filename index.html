<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilha de Finanças Pessoais com IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Google API & Identity Services -->
    <script async defer src="https://apis.google.com/js/api.js" onload="window.gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="window.gisLoaded()"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        .card {
            background-color: #1f2937;
            border-radius: 0.75rem;
            border: 1px solid #374151;
            padding: 1.5rem;
        }
        h1, .text-gray-800, .text-gray-900 { color: #f9fafb !important; }
        h2, h3, .text-gray-700 { color: #e5e7eb !important; }

        p, label, .text-gray-600, .text-gray-500 { color: #d1d5db !important; }
        #auth-status { color: #9ca3af !important; }

        input, select {
            background-color: #374151 !important;
            border-color: #4b5563 !important;
            color: #f9fafb !important;
            color-scheme: dark;
        }
        input::placeholder {
            color: #9ca3af;
        }

        .table-header {
            background-color: #374151;
        }

        .responsive-table tbody, .responsive-table, .divide-y {
             border-color: #374151 !important;
        }
        
        #google-auth-button {
            background-color: #374151;
            border-color: #4b5563;
            color: #f9fafb;
        }
        #google-auth-button:hover {
            background-color: #4b5563;
        }

        #monthly-incomes-list .bg-gray-50 {
             background-color: #374151 !important;
        }
        
        .tab {
            color: #9ca3af;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        .tab.active {
            border-bottom-color: #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        .mb-8.border-b {
            border-color: #374151;
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        #gemini-button:disabled, #save-data-button:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .save-button {
            transition: all 0.3s ease;
        }

        /* --- Estilos para Tabelas Responsivas --- */
        @media (max-width: 767px) { /* md breakpoint from Tailwind */
            .responsive-table thead {
                display: none;
            }
            .responsive-table tbody tr {
                display: block;
                border-color: #374151;
                background-color: #1f2937;
                border-radius: 0.5rem;
                margin-bottom: 1rem;
                padding: 1rem;
                box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            }
            .responsive-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.75rem 0.25rem;
                text-align: right;
                border-bottom: 1px solid #374151;
            }
            .responsive-table td:last-child {
                border-bottom: none;
            }
            .responsive-table td::before {
                content: attr(data-label);
                font-weight: 600;
                color: #9ca3af;
                margin-right: 1rem;
                text-align: left;
            }
             .responsive-table td:last-child::before {
                content: "";
            }
             .responsive-table td:last-child {
                justify-content: flex-end;
            }
        }

    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-4 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Minhas Finanças</h1>
                <p class="text-gray-500 mt-1">Sua planilha e dashboard financeiro com salvamento no Google Drive.</p>
            </div>
            <div class="flex items-center gap-4 w-full sm:w-auto">
                 <div id="auth-status" class="text-sm text-gray-600 flex-grow"></div>
                 <button id="google-auth-button" class="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    Login
                </button>
                <button id="save-data-button" class="save-button py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 disabled:bg-gray-400">
                    Salvar
                </button>
            </div>
        </header>

        <!-- TABS -->
        <div class="mb-8 border-b border-gray-200">
            <nav class="-mb-px flex space-x-2 sm:space-x-4" aria-label="Tabs">
                <a id="tab-despesas" class="tab active">Despesas</a>
                <a id="tab-reservas" class="tab">Reservas</a>
            </nav>
        </div>

        <!-- VIEW: DESPESAS -->
        <div id="despesas-view">
            <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <!-- Coluna da Planilha -->
                <div class="lg:col-span-3 space-y-6">
                    <!-- Formulário de Adição -->
                    <div class="card">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Adicionar Nova Despesa</h2>
                        <form id="expense-form" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <label for="date" class="block text-sm font-medium text-gray-600">Data</label>
                                <input type="date" id="date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                            </div>
                            <div>
                                <label for="payment-type" class="block text-sm font-medium text-gray-600">Tipo de Pagamento</label>
                                <select id="payment-type" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                                    <option>Crédito</option>
                                    <option>Débito</option>
                                    <option>PIX</option>
                                </select>
                            </div>
                            <div>
                                <label for="category" class="block text-sm font-medium text-gray-600">Categoria</label>
                                <select id="category" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                                    <option>Moradia</option>
                                    <option>Alimentação</option>
                                    <option>Transporte</option>
                                    <option>Lazer</option>
                                    <option>Saúde</option>
                                    <option>Vestuário</option>
                                    <option>Educação</option>
                                    <option>Outros</option>
                                </select>
                            </div>
                            <div>
                                <label for="bank" class="block text-sm font-medium text-gray-600">Banco</label>
                                <select id="bank" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                                    <option>Nubank</option>
                                    <option>Itaú</option>
                                    <option>Bradesco</option>
                                    <option>Santander</option>
                                    <option>Banco do Brasil</option>
                                    <option>Caixa</option>
                                    <option>Inter</option>
                                    <option>Outro</option>
                                </select>
                            </div>
                            <div class="sm:col-span-2 md:col-span-3">
                                <label for="description" class="block text-sm font-medium text-gray-600">Onde foi (Descrição)</label>
                                <input type="text" id="description" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Ex: Supermercado Pão de Mel" required>
                            </div>
                            <div>
                                <label for="amount" class="block text-sm font-medium text-gray-600">Valor Total (R$)</label>
                                <input type="number" step="0.01" id="amount" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="150,50" required>
                            </div>
                            
                            <!-- Recurring Expense Section -->
                            <div class="sm:col-span-2 md:col-span-4 space-y-3 mt-2">
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="is-recurring" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <label for="is-recurring" class="text-sm font-medium text-gray-600">Despesa Recorrente?</label>
                                </div>
                                <div id="recurring-options" class="hidden">
                                    <label for="recurrence-end-date" class="block text-sm font-medium text-gray-600">Repetir mensalmente até:</label>
                                    <input type="date" id="recurrence-end-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                            </div>
    
                            <div class="sm:col-span-2 md:col-span-4">
                                 <button type="submit" class="w-full sm:w-auto mt-4 justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Adicionar Despesa</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Tabela de Despesas -->
                    <div class="card">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Histórico de Gastos</h2>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label for="filter-month" class="block text-sm font-medium text-gray-600">Filtrar por Mês</label>
                                <select id="filter-month" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                            </div>
                            <div>
                                <label for="filter-category" class="block text-sm font-medium text-gray-600">Filtrar por Categoria</label>
                                <select id="filter-category" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="all">Todas as Categorias</option>
                                    <option>Moradia</option> <option>Alimentação</option> <option>Transporte</option> <option>Lazer</option>
                                    <option>Saúde</option> <option>Vestuário</option> <option>Educação</option> <option>Outros</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-payment" class="block text-sm font-medium text-gray-600">Filtrar por Pagamento</label>
                                <select id="filter-payment" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="all">Todos os Tipos</option> <option>Crédito</option> <option>Débito</option> <option>PIX</option>
                                </select>
                            </div>
                        </div>
    
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 responsive-table">
                                <thead class="table-header">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descrição</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoria</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pagamento</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Valor (R$)</th>
                                        <th scope="col" class="relative px-6 py-3"><span class="sr-only">Ações</span></th>
                                    </tr>
                                </thead>
                                <tbody id="expense-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
    
                <!-- Coluna do Dashboard -->
                <div class="lg:col-span-2 space-y-6">
                     <div class="card">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Gerenciar Rendas Mensais</h3>
                        <form id="income-form" class="flex items-end gap-2 mb-4">
                            <div class="flex-grow">
                                <label for="income-month" class="block text-sm font-medium text-gray-600">Mês/Ano</label>
                                <input type="month" id="income-month" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                            </div>
                            <div>
                                <label for="income-amount" class="block text-sm font-medium text-gray-600">Renda (R$)</label>
                                <input type="number" step="0.01" id="income-amount" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required placeholder="6000,00">
                            </div>
                            <button type="submit" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Salvar</button>
                        </form>
                        <div id="monthly-incomes-list" class="text-sm space-y-1"></div>
                    </div>
    
                    <div class="card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-700">Visão Geral</h3>
                            <select id="dashboard-month-filter" class="block w-48 border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                            <div>
                                <h3 class="text-sm font-medium text-gray-500">Gasto Total</h3>
                                <p id="total-expenses" class="mt-1 text-2xl font-semibold text-red-600">R$ 0,00</p>
                            </div>
                            <div>
                                <h3 class="text-sm font-medium text-gray-500">Renda Comprometida</h3>
                                <p id="income-percentage" class="mt-1 text-2xl font-semibold text-yellow-600">0%</p>
                            </div>
                            <div>
                                <h3 class="text-sm font-medium text-gray-500">Saldo Restante</h3>
                                <p id="remaining-balance" class="mt-1 text-2xl font-semibold text-green-600">R$ 0,00</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="flex flex-wrap justify-between items-center gap-2 mb-4">
                            <h3 class="text-lg font-semibold text-gray-700">Gastos por Banco</h3>
                            <div class="flex gap-2">
                                <select id="bank-month-filter" class="block w-40 border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                                <select id="bank-payment-filter" class="block w-32 border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                   <option value="all">Todos</option> <option>Crédito</option> <option>Débito</option> <option>PIX</option>
                                </select>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full responsive-table">
                                <thead class="border-b-2 border-gray-200">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Banco</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pagamento</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Valor Gasto (R$)</th>
                                    </tr>
                                </thead>
                                <tbody id="bank-expenses-table-body" class="divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
    
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-700">Gastos Gerais por Categoria</h3>
                        <canvas id="category-chart" class="mt-4"></canvas>
                    </div>
    
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Análise Mês a Mês</h3>
                        <select id="month-select" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm mb-4"></select>
                        <canvas id="monthly-category-chart" class="mt-4"></canvas>
                        <div id="monthly-analysis-details" class="mt-4 text-sm space-y-1"></div>
                    </div>
    
                    <div class="card bg-indigo-50 border border-indigo-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-indigo-800">Análise Financeira</h3>
                            <button id="gemini-button" class="flex items-center justify-center py-2 px-3 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700">
                                ✨ Gerar Dicas com IA
                            </button>
                        </div>
                        <div id="analysis-text" class="text-indigo-700 text-sm space-y-2">
                            <p>Faça login para usar a IA e analisar seus dados salvos no Drive.</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- VIEW: RESERVAS -->
        <div id="reservas-view" class="hidden">
            <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <!-- Coluna Formulário e Tabela -->
                <div class="lg:col-span-3 space-y-6">
                    <div class="card">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Adicionar Nova Reserva</h2>
                        <form id="saving-form" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div>
                                <label for="saving-month" class="block text-sm font-medium text-gray-600">Mês/Ano</label>
                                <input type="month" id="saving-month" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required>
                            </div>
                            <div>
                                <label for="saving-type" class="block text-sm font-medium text-gray-600">Tipo de Reserva</label>
                                <select id="saving-type" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required>
                                    <option>Reserva de Emergência</option>
                                    <option>Investimentos</option>
                                    <option>Objetivos (Viagem, etc.)</option>
                                    <option>Outros</option>
                                </select>
                            </div>
                            <div>
                                <label for="saving-amount" class="block text-sm font-medium text-gray-600">Valor (R$)</label>
                                <input type="number" step="0.01" id="saving-amount" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required placeholder="500,00">
                            </div>
                            <div class="sm:col-span-3">
                                <button type="submit" class="w-full sm:w-auto mt-4 justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Adicionar Reserva</button>
                            </div>
                        </form>
                    </div>
                    <div class="card">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Histórico de Reservas</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 responsive-table">
                                <thead class="table-header">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mês</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Valor (R$)</th>
                                        <th scope="col" class="relative px-6 py-3"><span class="sr-only">Ações</span></th>
                                    </tr>
                                </thead>
                                <tbody id="savings-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Coluna Dashboard Reservas -->
                <div class="lg:col-span-2 space-y-6">
                    <div class="card text-center">
                        <h3 class="text-lg font-medium text-gray-500">Total Guardado</h3>
                        <p id="total-savings" class="mt-1 text-3xl sm:text-4xl font-bold text-green-600">R$ 0,00</p>
                    </div>
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-700">Reservas por Tipo</h3>
                        <canvas id="savings-by-type-chart" class="mt-4"></canvas>
                    </div>
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-700">Evolução das Reservas</h3>
                        <canvas id="savings-over-time-chart" class="mt-4"></canvas>
                    </div>
                </div>
            </main>
        </div>

    </div>

    <script>
        // --- DADOS GLOBAIS ---
        let expenses = [];
        let monthlyIncomes = {};
        let savings = [];
        
        // --- CONFIGURAÇÃO GOOGLE API ---
        const CLIENT_ID = '164577357008-o68h1qr3h69ik5ot1531f1fvvrl40umr.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyALVa2RTydoXDNsJP6NmtTV6b7zYhFixY0';
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const FILENAME = 'minhas_financas_dados.json';
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let driveFileId = null;

        // --- ELEMENTOS DOM ---
        const form = document.getElementById('expense-form');
        const incomeForm = document.getElementById('income-form');
        const savingForm = document.getElementById('saving-form');
        const geminiButton = document.getElementById('gemini-button');
        const saveDataButton = document.getElementById('save-data-button');
        const authButton = document.getElementById('google-auth-button');
        const authStatus = document.getElementById('auth-status');
        
        // --- FUNÇÕES DE FORMATAÇÃO ---
        const formatCurrency = (value) => `R$ ${value.toFixed(2).replace('.', ',')}`;
        const formatDate = (dateString) => { const [y, m, d] = dateString.split('-'); return `${d}/${m}/${y}`; };
        const formatMonthYear = (monthString) => {
            if (!monthString || !monthString.includes('-')) return '';
            const [year, month] = monthString.split('-');
            const date = new Date(year, parseInt(month) - 1);
            const formatted = date.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
            return formatted.charAt(0).toUpperCase() + formatted.slice(1);
        };

        // --- LÓGICA GOOGLE DRIVE & AUTH ---
        window.gapiLoaded = () => gapi.load('client', initializeGapiClient);
        window.gisLoaded = () => {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPES, callback: (tokenResponse) => {
                    if (tokenResponse.error) {
                      console.error("Authentication error:", tokenResponse);
                      authStatus.textContent = 'Falha na autenticação.';
                      return;
                    }
                    gapi.client.setToken(tokenResponse);
                    updateSigninStatus(true);
                },
            });
            gisInited = true; maybeEnableButtons();
        };

        async function initializeGapiClient() { 
            await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS }); 
            gapiInited = true; 
            maybeEnableButtons(); 
        }
        
        function maybeEnableButtons() { 
            if (gapiInited && gisInited) { 
                authButton.disabled = false; 
            } 
        }

        authButton.addEventListener('click', () => {
             if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                const token = gapi.client.getToken();
                if (token) {
                    google.accounts.oauth2.revoke(token.access_token, () => {
                        gapi.client.setToken(null);
                        updateSigninStatus(false);
                    });
                } else {
                    updateSigninStatus(false);
                }
            }
        });

        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                authStatus.textContent = 'Conectado';
                authButton.textContent = 'Sair';
                saveDataButton.disabled = false;
                geminiButton.disabled = false;
                loadDataFromDrive();
            } else {
                authStatus.textContent = 'Desconectado';
                authButton.textContent = 'Fazer Login';
                saveDataButton.disabled = true;
                geminiButton.disabled = true;
                driveFileId = null;
                loadDefaultData();
                updateAllUI();
            }
        }
        
        async function loadDataFromDrive() {
            try {
                authStatus.textContent = 'Buscando dados...';
                const response = await gapi.client.drive.files.list({
                    q: `name='${FILENAME}' and trashed=false`,
                    spaces: 'drive',
                    fields: 'files(id, name)'
                });
                
                if (response.result.files && response.result.files.length > 0) {
                    driveFileId = response.result.files[0].id;
                    const fileResponse = await gapi.client.drive.files.get({
                        fileId: driveFileId,
                        alt: 'media'
                    });
                    const data = JSON.parse(fileResponse.body);
                    expenses = data.expenses || [];
                    monthlyIncomes = data.monthlyIncomes || {};
                    savings = data.savings || [];
                    authStatus.textContent = 'Dados carregados!';
                } else {
                    driveFileId = null; 
                    loadDefaultData();
                     authStatus.textContent = 'Nenhum arquivo encontrado.';
                }
            } catch (err) {
                console.error("Erro ao carregar dados do Drive", err);
                authStatus.textContent = 'Erro ao carregar dados.';
                loadDefaultData();
            } finally {
                updateAllUI();
                 setTimeout(() => { if (gapi.client.getToken()) authStatus.textContent = 'Conectado'; }, 3000);
            }
        }

        async function saveDataToDrive() {
            saveDataButton.disabled = true;
            saveDataButton.textContent = 'Salvando...';
            const allData = { expenses, monthlyIncomes, savings, lastUpdated: new Date().toISOString() };
            const dataBlob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });

            const metadata = { name: FILENAME, mimeType: 'application/json' };
            
            try {
                let request;
                const form = new FormData();

                if (driveFileId) { 
                    form.append('metadata', new Blob([JSON.stringify({})], { type: 'application/json' }));
                    form.append('file', dataBlob);
                    request = gapi.client.request({
                        path: `/upload/drive/v3/files/${driveFileId}`,
                        method: 'PATCH',
                        params: { uploadType: 'multipart' },
                        body: form
                    });
                } else { 
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', dataBlob);
                    request = gapi.client.request({
                        path: '/upload/drive/v3/files',
                        method: 'POST',
                        params: { uploadType: 'multipart' },
                        body: form
                    });
                }
                
                const response = await request;
                driveFileId = response.result.id; 
                saveDataButton.textContent = 'Salvo!';
                saveDataButton.classList.replace('bg-green-600', 'bg-blue-500');
            } catch (err) {
                console.error("Erro ao salvar no Drive", err);
                saveDataButton.textContent = 'Erro ao Salvar';
                saveDataButton.classList.replace('bg-green-600', 'bg-red-500');
            } finally {
                setTimeout(() => {
                    saveDataButton.disabled = false;
                    saveDataButton.textContent = 'Salvar no Google Drive';
                    saveDataButton.classList.replace('bg-blue-500', 'bg-green-600');
                    saveDataButton.classList.replace('bg-red-500', 'bg-green-600');
                }, 3000);
            }
        }

        function loadDefaultData() {
            expenses = [{ id: 1, date: '2025-09-01', type: 'Débito', description: 'Supermercado (Exemplo)', amount: 350.45, category: 'Alimentação', bank: 'Nubank' }];
            monthlyIncomes = { '2025-09': 6000 };
            savings = [ { id: 1, month: '2025-09', type: 'Reserva de Emergência', amount: 500 } ];
        }

        // --- LÓGICA DE NAVEGAÇÃO (TABS) ---
        const tabDespesas = document.getElementById('tab-despesas');
        const tabReservas = document.getElementById('tab-reservas');
        const viewDespesas = document.getElementById('despesas-view');
        const viewReservas = document.getElementById('reservas-view');
        tabDespesas.addEventListener('click', () => { tabDespesas.classList.add('active'); tabReservas.classList.remove('active'); viewDespesas.classList.remove('hidden'); viewReservas.classList.add('hidden'); });
        tabReservas.addEventListener('click', () => { tabReservas.classList.add('active'); tabDespesas.classList.remove('active'); viewReservas.classList.remove('hidden'); viewDespesas.classList.add('hidden'); });

        // =================================================================
        // --- SEÇÃO DE DESPESAS (CÓDIGO SEM ALTERAÇÕES SIGNIFICATIVAS) ---
        // =================================================================
        const expenseTableBody = document.getElementById('expense-table-body');
        const filterMonthEl = document.getElementById('filter-month');
        const filterCategoryEl = document.getElementById('filter-category');
        const filterPaymentEl = document.getElementById('filter-payment');
        let categoryChart, monthlyCategoryChart;

        function renderExpenseTable(expensesToRender) {
            expenseTableBody.innerHTML = '';
            expensesToRender.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(expense => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Data" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(expense.date)}</td>
                    <td data-label="Descrição" class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${expense.description}</td>
                    <td data-label="Categoria" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${expense.category}</td>
                    <td data-label="Pagamento" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${expense.type}</td>
                    <td data-label="Valor" class="px-6 py-4 whitespace-nowrap text-sm text-red-500 text-right font-medium">${formatCurrency(expense.amount)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="deleteExpense(${expense.id})" class="text-red-600 hover:text-red-900">Excluir</button>
                    </td>
                `;
                expenseTableBody.appendChild(row);
            });
        }
        
        function applyFiltersAndRenderExpenses() {
            let filtered = [...expenses];
            if (filterMonthEl.value !== 'all') filtered = filtered.filter(e => e.date.startsWith(filterMonthEl.value));
            if (filterCategoryEl.value !== 'all') filtered = filtered.filter(e => e.category === filterCategoryEl.value);
            if (filterPaymentEl.value !== 'all') filtered = filtered.filter(e => e.type === filterPaymentEl.value);
            renderExpenseTable(filtered);
        }

        function updateExpensesDashboard() {
            const uniqueMonths = [...new Set(expenses.map(e => e.date.substring(0, 7)))].sort().reverse();
            const monthSelects = [document.getElementById('month-select'), document.getElementById('dashboard-month-filter'), document.getElementById('bank-month-filter'), filterMonthEl];
            
            monthSelects.forEach(select => {
                const currentVal = select.value;
                select.innerHTML = '<option value="all">Todos os Meses</option>';
                uniqueMonths.forEach(m => select.add(new Option(formatMonthYear(m), m)));
                select.value = uniqueMonths.includes(currentVal) ? currentVal : 'all';
            });
            
            const monthAnalysisSelect = document.getElementById('month-select');
            if (monthAnalysisSelect.options[0]?.value === 'all') monthAnalysisSelect.remove(0);
            if (!uniqueMonths.includes(monthAnalysisSelect.value)) monthAnalysisSelect.value = uniqueMonths[0] || '';
            
            updateSummaryCards();
            updateBankExpensesTable();
            updateExpenseCharts();
            updateMonthlyAnalysis();
        }
        
        function updateSummaryCards() {
            const filter = document.getElementById('dashboard-month-filter').value;
            const relevantExpenses = filter === 'all' ? expenses : expenses.filter(e => e.date.startsWith(filter));
            const relevantIncome = filter === 'all' ? Object.values(monthlyIncomes).reduce((s, i) => s + i, 0) : monthlyIncomes[filter] || 0;
            const total = relevantExpenses.reduce((s, e) => s + e.amount, 0);
            
            document.getElementById('total-expenses').textContent = formatCurrency(total);
            document.getElementById('income-percentage').textContent = `${(relevantIncome > 0 ? (total / relevantIncome) * 100 : 0).toFixed(1)}%`;
            document.getElementById('remaining-balance').textContent = formatCurrency(relevantIncome - total);
        }

        function updateBankExpensesTable() {
            const monthFilter = document.getElementById('bank-month-filter').value;
            const paymentFilter = document.getElementById('bank-payment-filter').value;
            const tableBody = document.getElementById('bank-expenses-table-body');
            
            let relevant = expenses.filter(e => monthFilter === 'all' || e.date.startsWith(monthFilter));
            if (paymentFilter !== 'all') relevant = relevant.filter(e => e.type === paymentFilter);

            tableBody.innerHTML = '';
            if (relevant.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="3" class="px-4 py-3 text-center text-sm text-gray-500">Nenhum gasto.</td></tr>`;
                return;
            }

            const bankData = relevant.reduce((acc, exp) => {
                const key = `${exp.bank}|${exp.type}`;
                acc[key] = (acc[key] || 0) + exp.amount;
                return acc;
            }, {});
            Object.entries(bankData).sort(([k1], [k2]) => k1.localeCompare(k2)).forEach(([key, amount]) => {
                const [bank, type] = key.split('|');
                const row = tableBody.insertRow();
                row.innerHTML = `<td data-label="Banco" class="px-4 py-3 text-sm font-medium text-gray-800">${bank}</td><td data-label="Pagamento" class="px-4 py-3 text-sm text-gray-500">${type}</td><td data-label="Valor" class="px-4 py-3 text-sm text-right font-semibold">${formatCurrency(amount)}</td>`;
            });
        }

        function updateExpenseCharts() {
            const filter = document.getElementById('dashboard-month-filter').value;
            const relevant = expenses.filter(e => filter === 'all' || e.date.startsWith(filter));
            const categoryData = relevant.reduce((acc, {category, amount}) => ({...acc, [category]: (acc[category] || 0) + amount}), {});
            
            if (categoryChart) categoryChart.destroy();
            const canvas = document.getElementById('category-chart');
            const selectedText = document.getElementById('dashboard-month-filter').selectedOptions[0] ? document.getElementById('dashboard-month-filter').selectedOptions[0].text : 'Todos os Meses';
            canvas.parentElement.querySelector('h3').textContent = `Gastos por Categoria (${selectedText})`;
            categoryChart = new Chart(canvas, {
                type: 'doughnut',
                data: { labels: Object.keys(categoryData), datasets: [{ data: Object.values(categoryData), backgroundColor: ['#4f46e5', '#ec4899', '#f59e0b', '#10b981', '#ef4444', '#3b82f6', '#8b5cf6'], borderWidth: 2 }] },
                options: { responsive: true, plugins: { legend: { position: 'top' } } }
            });
        }

        function updateMonthlyAnalysis() {
            const select = document.getElementById('month-select');
            if (!select.value) {
                document.getElementById('monthly-category-chart').style.display = 'none';
                document.getElementById('monthly-analysis-details').innerHTML = '<p>Nenhuma despesa para analisar.</p>';
                if(monthlyCategoryChart) monthlyCategoryChart.destroy();
                return;
            }
            document.getElementById('monthly-category-chart').style.display = 'block';
            const monthly = expenses.filter(e => e.date.startsWith(select.value));
            const categoryData = monthly.reduce((acc, {category, amount}) => ({...acc, [category]: (acc[category] || 0) + amount}), {});
            
            let detailsHtml = `<strong>Resumo de ${formatMonthYear(select.value)}:</strong><ul class="list-disc ml-4 mt-2">`;
            Object.entries(categoryData).sort(([,a],[,b]) => b-a).forEach(([cat, amt]) => detailsHtml += `<li>${cat}: <strong>${formatCurrency(amt)}</strong></li>`);
            document.getElementById('monthly-analysis-details').innerHTML = detailsHtml + '</ul>';

            if (monthlyCategoryChart) monthlyCategoryChart.destroy();
            monthlyCategoryChart = new Chart(document.getElementById('monthly-category-chart'), {
                type: 'pie', data: { labels: Object.keys(categoryData), datasets: [{ data: Object.values(categoryData), backgroundColor: ['#4f46e5', '#ec4899', '#f59e0b', '#10b981', '#ef4444', '#3b82f6', '#8b5cf6'], borderWidth: 2 }] },
                options: { responsive: true, plugins: { legend: { position: 'top' } } }
            });
        }
        
        // =================================================================
        // --- SEÇÃO DE RESERVAS ---
        // =================================================================
        const savingsTableBody = document.getElementById('savings-table-body');
        let savingsByTypeChart, savingsOverTimeChart;
        
        function renderSavingsTable() {
            savingsTableBody.innerHTML = '';
            savings.sort((a, b) => b.month.localeCompare(a.month)).forEach(saving => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Mês" class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${formatMonthYear(saving.month)}</td>
                    <td data-label="Tipo" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${saving.type}</td>
                    <td data-label="Valor" class="px-6 py-4 whitespace-nowrap text-sm text-green-600 text-right font-semibold">${formatCurrency(saving.amount)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="deleteSaving(${saving.id})" class="text-red-600 hover:text-red-900">Excluir</button>
                    </td>
                `;
                savingsTableBody.appendChild(row);
            });
        }

        function updateSavingsDashboard() {
            const total = savings.reduce((sum, s) => sum + s.amount, 0);
            document.getElementById('total-savings').textContent = formatCurrency(total);

            // Chart 1: Savings by Type
            const byTypeData = savings.reduce((acc, {type, amount}) => ({...acc, [type]: (acc[type] || 0) + amount}), {});
            if (savingsByTypeChart) savingsByTypeChart.destroy();
            savingsByTypeChart = new Chart(document.getElementById('savings-by-type-chart'), {
                type: 'pie',
                data: { labels: Object.keys(byTypeData), datasets: [{ data: Object.values(byTypeData), backgroundColor: ['#10b981', '#f59e0b', '#3b82f6', '#8b5cf6'], borderWidth: 2 }] },
                options: { responsive: true, plugins: { legend: { position: 'top' } } }
            });

            // Chart 2: Savings over time
            const byTimeData = savings.reduce((acc, {month, amount}) => ({...acc, [month]: (acc[month] || 0) + amount}), {});
            const sortedMonths = Object.keys(byTimeData).sort();
            if (savingsOverTimeChart) savingsOverTimeChart.destroy();
            savingsOverTimeChart = new Chart(document.getElementById('savings-over-time-chart'), {
                type: 'bar',
                data: { 
                    labels: sortedMonths.map(formatMonthYear), 
                    datasets: [{ label: 'Valor Guardado', data: sortedMonths.map(m => byTimeData[m]), backgroundColor: '#10b981' }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
            });
        }

        // --- ATUALIZAÇÃO GERAL DA UI ---
        function updateAllUI() {
            renderMonthlyIncomes();
            // Despesas
            applyFiltersAndRenderExpenses();
            updateExpensesDashboard();
            // Reservas
            renderSavingsTable();
            updateSavingsDashboard();
        }

        // --- HANDLERS DE EVENTOS E AÇÕES ---
        window.deleteExpense = (id) => { expenses = expenses.filter(e => e.id !== id); updateAllUI(); };
        window.deleteIncome = (month) => { delete monthlyIncomes[month]; updateAllUI(); };
        window.deleteSaving = (id) => { savings = savings.filter(s => s.id !== id); updateAllUI(); };
        
        function renderMonthlyIncomes() {
            const listEl = document.getElementById('monthly-incomes-list');
            listEl.innerHTML = '';
            Object.keys(monthlyIncomes).sort().reverse().forEach(month => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-gray-50 p-2 rounded';
                div.innerHTML = `<span>${formatMonthYear(month)}: <strong>${formatCurrency(monthlyIncomes[month])}</strong></span> <button onclick="deleteIncome('${month}')" class="text-red-500 hover:text-red-700 text-xs font-semibold">Excluir</button>`;
                listEl.appendChild(div);
            });
        }

        // --- INICIALIZAÇÃO E LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            Chart.defaults.color = '#d1d5db';
            updateSigninStatus(false);
            document.getElementById('date').valueAsDate = new Date();
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            document.getElementById('saving-month').value = `${year}-${month}`;

            // Listeners Despesas
            form.addEventListener('submit', e => {
                e.preventDefault();
                const isRecurring = document.getElementById('is-recurring').checked;
                if (isRecurring) {
                    const startDate = new Date(document.getElementById('date').value + 'T00:00:00'); 
                    const endDate = new Date(document.getElementById('recurrence-end-date').value + 'T00:00:00');
                    if (!document.getElementById('recurrence-end-date').value || startDate > endDate) return;
                    let currentDate = startDate;
                    while (currentDate <= endDate) {
                        expenses.push({ id: Date.now() + currentDate.getTime(), date: currentDate.toISOString().split('T')[0], type: document.getElementById('payment-type').value, description: document.getElementById('description').value, amount: parseFloat(document.getElementById('amount').value), category: document.getElementById('category').value, bank: document.getElementById('bank').value });
                        currentDate.setMonth(currentDate.getMonth() + 1);
                    }
                } else { 
                    expenses.push({ id: Date.now(), date: document.getElementById('date').value, type: document.getElementById('payment-type').value, description: document.getElementById('description').value, amount: parseFloat(document.getElementById('amount').value), category: document.getElementById('category').value, bank: document.getElementById('bank').value }); 
                }
                updateAllUI(); 
                form.reset(); 
                document.getElementById('is-recurring').checked = false;
                document.getElementById('recurring-options').classList.add('hidden');
                document.getElementById('date').valueAsDate = new Date();
            });
            incomeForm.addEventListener('submit', e => { e.preventDefault(); const m = document.getElementById('income-month').value; const a = parseFloat(document.getElementById('income-amount').value); if(m && a >= 0) { monthlyIncomes[m] = a; updateAllUI(); incomeForm.reset(); } });
            [filterMonthEl, filterCategoryEl, filterPaymentEl].forEach(el => el.addEventListener('change', applyFiltersAndRenderExpenses));
            [document.getElementById('dashboard-month-filter'), document.getElementById('bank-month-filter'), document.getElementById('bank-payment-filter'), document.getElementById('month-select')].forEach(el => el.addEventListener('change', updateExpensesDashboard));
            document.getElementById('is-recurring').addEventListener('change', (e) => { document.getElementById('recurring-options').classList.toggle('hidden', !e.target.checked); document.getElementById('recurrence-end-date').required = e.target.checked; });


            // Listeners Reservas
            savingForm.addEventListener('submit', e => {
                e.preventDefault();
                savings.push({ id: Date.now(), month: document.getElementById('saving-month').value, type: document.getElementById('saving-type').value, amount: parseFloat(document.getElementById('saving-amount').value) });
                updateAllUI();
                savingForm.reset();
                document.getElementById('saving-month').value = `${year}-${month}`;
            });

            // Listeners Gerais
            saveDataButton.addEventListener('click', saveDataToDrive);
        });
    </script>
</body>
</html>

