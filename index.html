<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilha de Finanças Pessoais com IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script async defer src="https://apis.google.com/js/api.js" onload="window.gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="window.gisLoaded()"></script>
    <style>
        /* Estilos Gerais (incluindo Temas) */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; transition: background-color 0.3s, color 0.3s; }
        .card { background-color: white; border-radius: 0.75rem; border: 1px solid #e5e7eb; padding: 1.5rem; transition: background-color 0.3s, border-color 0.3s; }
        h1, .text-gray-800, .text-gray-900 { color: #111827 !important; }
        h2, h3, .text-gray-700 { color: #1f2937 !important; }
        p, label, .text-gray-600, .text-gray-500 { color: #4b5563 !important; }
        #auth-status { color: #6b7280 !important; }
        input, select { background-color: #f9fafb !important; border-color: #d1d5db !important; color: #111827 !important; color-scheme: light; }
        input::placeholder { color: #9ca3af; }
        .table-header { background-color: #f9fafb; }
        .responsive-table tbody, .responsive-table, .divide-y { border-color: #e5e7eb !important; }
        #google-auth-button, .export-button { background-color: #ffffff; border-color: #d1d5db; color: #374151; }
        #google-auth-button:hover, .export-button:hover { background-color: #f9fafb; }
        #monthly-incomes-list .bg-gray-50 { background-color: #f9fafb !important; }
        .tab { color: #6b7280; cursor: pointer; padding: 0.5rem 0.25rem; border-bottom: 2px solid transparent; }
        .tab.active { border-bottom-color: #4f46e5; color: #4f46e5; font-weight: 600; }
        .mb-8.border-b { border-color: #e5e7eb; }
        body.dark { background-color: #111827; color: #d1d5db; }
        body.dark .card { background-color: #1f2937; border: 1px solid #374151; }
        body.dark h1, body.dark .text-gray-800, body.dark .text-gray-900 { color: #f9fafb !important; }
        body.dark h2, body.dark h3, body.dark .text-gray-700 { color: #e5e7eb !important; }
        body.dark p, body.dark label, body.dark .text-gray-600, body.dark .text-gray-500 { color: #d1d5db !important; }
        body.dark #auth-status { color: #9ca3af !important; }
        body.dark input, body.dark select { background-color: #374151 !important; border-color: #4b5563 !important; color: #f9fafb !important; color-scheme: dark; }
        body.dark input::placeholder { color: #9ca3af; }
        body.dark .table-header { background-color: #374151; }
        body.dark .responsive-table tbody, body.dark .responsive-table, body.dark .divide-y { border-color: #374151 !important; }
        body.dark #google-auth-button, body.dark .export-button { background-color: #374151; border-color: #4b5563; color: #f9fafb; }
        body.dark #google-auth-button:hover, body.dark .export-button:hover { background-color: #4b5563; }
        body.dark #monthly-incomes-list .bg-gray-50 { background-color: #374151 !important; }
        #gemini-button:disabled, #save-data-button:disabled { cursor: not-allowed; opacity: 0.7; }

        /* Estilos do Modal de Edição */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all .3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { max-height: 90vh; overflow-y: auto; width: 90%; max-width: 600px; transform: translateY(-20px); transition: all .3s; }
        .modal-overlay.visible .modal-content { transform: translateY(0); }

        /* Estilos das Mini Dicas */
        .mini-tip { display: none; position: relative; background-color: #eef2ff; border-left: 4px solid #4f46e5; padding: 1rem; border-radius: 0.25rem; margin-top: 1.5rem; }
        body.dark .mini-tip { background-color: #312e81; border-color: #818cf8; }
        .mini-tip-close { position: absolute; top: 0.5rem; right: 0.5rem; background: none; border: none; font-size: 1.2rem; cursor: pointer; }
        
        /* Estilos da Barra de Progresso */
        .progress-bg { background-color: #e5e7eb; border-radius: 9999px; height: 0.75rem; overflow: hidden; }
        body.dark .progress-bg { background-color: #374151; }
        .progress-fill { height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out; }
        .progress-fill.budget { background-color: #4f46e5; }
        .progress-fill.budget.yellow { background-color: #f59e0b; }
        .progress-fill.budget.red { background-color: #ef4444; }
        .progress-fill.goal { background-color: #10b981; }


        /* Estilos Responsivos */
        @media (max-width: 767px) {
            .responsive-table thead { display: none; }
            .responsive-table tbody tr { display: block; border-radius: 0.5rem; margin-bottom: 1rem; padding: 1rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
            body.light .responsive-table tbody tr { border: 1px solid #e5e7eb; background-color: white;}
            body.dark .responsive-table tbody tr { border-color: #374151; background-color: #1f2937;}
            .responsive-table td { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0.25rem; text-align: right; }
            body.light .responsive-table td { border-bottom: 1px solid #f3f4f6; } body.dark .responsive-table td { border-bottom: 1px solid #374151; }
            .responsive-table td:last-child { border-bottom: none; }
            .responsive-table td::before { content: attr(data-label); font-weight: 600; margin-right: 1rem; text-align: left; }
            .responsive-table td .actions-cell { display: flex; gap: 1rem; justify-content: flex-end; align-items: center; width: 100%; height: 100%; }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-4 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Minhas Finanças</h1>
                <p class="text-gray-500 mt-1">Sua planilha e dashboard financeiro com salvamento no Google Drive.</p>
            </div>
            <div class="flex items-center gap-4 w-full sm:w-auto">
                 <div id="auth-status" class="text-sm text-gray-600 flex-grow"></div>
                 <button id="theme-toggle-button" class="p-2 rounded-md">
                     <svg id="theme-icon-sun" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                     <svg id="theme-icon-moon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                 </button>
                 <button id="google-auth-button" class="py-2 px-4 border rounded-md shadow-sm text-sm font-medium">Login</button>
                 <button id="save-data-button" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">Salvar</button>
            </div>
        </header>

        <div class="mb-8 border-b">
            <nav class="-mb-px flex space-x-2 sm:space-x-4" aria-label="Tabs">
                <a id="tab-despesas" class="tab active">Despesas</a>
                <a id="tab-reservas" class="tab">Reservas</a>
                <a id="tab-orcamentos" class="tab">Orçamentos</a>
                <a id="tab-metas" class="tab">Metas</a>
            </nav>
        </div>

        <div id="despesas-view">
            <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <div class="lg:col-span-3 space-y-6">
                    <div class="card">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Adicionar Nova Despesa</h2>
                        <form id="expense-form" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                            <div><label for="date" class="block text-sm font-medium">Data</label><input type="date" id="date" class="mt-1 block w-full rounded-md shadow-sm" required></div>
                            <div><label for="cost-type" class="block text-sm font-medium">Tipo</label><select id="cost-type" class="mt-1 block w-full rounded-md shadow-sm" required><option>Variável</option><option>Fixo</option></select></div>
                            <div><label for="category" class="block text-sm font-medium">Categoria</label><select id="category" class="mt-1 block w-full rounded-md shadow-sm" required><option>Moradia</option><option>Alimentação</option><option>Transporte</option><option>Lazer</option><option>Saúde</option><option>Vestuário</option><option>Educação</option><option>Outros</option></select></div>
                            <div><label for="payment-type" class="block text-sm font-medium">Pagamento</label><select id="payment-type" class="mt-1 block w-full rounded-md shadow-sm" required><option>Crédito</option><option>Débito</option><option>PIX</option></select></div>
                            <div class="sm:col-span-2 md:col-span-2"><label for="description" class="block text-sm font-medium">Onde foi (Descrição)</label><input type="text" id="description" class="mt-1 block w-full rounded-md shadow-sm" placeholder="Ex: Supermercado" required></div>
                            <div><label for="bank" class="block text-sm font-medium">Banco</label><select id="bank" class="mt-1 block w-full rounded-md shadow-sm" required><option>Nubank</option><option>Itaú</option><option>Bradesco</option><option>Santander</option><option>Banco do Brasil</option><option>Caixa</option><option>Inter</option><option>Outro</option></select></div>
                            <div><label for="amount" class="block text-sm font-medium">Valor (R$)</label><input type="number" step="0.01" id="amount" class="mt-1 block w-full rounded-md shadow-sm" placeholder="150,50" required></div>
                            <div class="sm:col-span-2 md:col-span-4 space-y-3 mt-2"><div class="flex items-center space-x-2"><input type="checkbox" id="is-recurring" class="h-4 w-4 text-indigo-600 border-gray-300 rounded"><label for="is-recurring" class="text-sm font-medium">Despesa Recorrente?</label></div><div id="recurring-options" class="hidden"><label for="recurrence-end-date" class="block text-sm font-medium">Repetir mensalmente até:</label><input type="date" id="recurrence-end-date" class="mt-1 block w-full rounded-md shadow-sm"></div></div>
                            <div class="sm:col-span-2 md:col-span-4"><button type="submit" class="w-full sm:w-auto mt-4 justify-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Adicionar Despesa</button></div>
                        </form>
                        <div id="tip-recurring" class="mini-tip">💡 <b>Dica:</b> Marque "Despesa Recorrente" para contas como aluguel ou assinaturas e defina uma data final. O app adicionará os gastos futuros automaticamente!<button onclick="dismissTip('tip-recurring')" class="mini-tip-close">&times;</button></div>
                    </div>
                    
                    <div class="card">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-gray-700">Histórico de Gastos</h2>
                            <button onclick="exportToCsv('expenses')" class="py-1 px-3 border rounded-md shadow-sm text-sm font-medium export-button">Exportar CSV</button>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                            <div><label for="filter-month" class="block text-sm font-medium">Filtrar por Mês</label><select id="filter-month" class="mt-1 block w-full rounded-md shadow-sm"></select></div>
                            <div><label for="filter-category" class="block text-sm font-medium">Filtrar por Categoria</label><select id="filter-category" class="mt-1 block w-full rounded-md shadow-sm"><option value="all">Todas</option><option>Moradia</option><option>Alimentação</option><option>Transporte</option><option>Lazer</option><option>Saúde</option><option>Vestuário</option><option>Educação</option><option>Outros</option></select></div>
                            <div><label for="filter-payment" class="block text-sm font-medium">Filtrar por Pagamento</label><select id="filter-payment" class="mt-1 block w-full rounded-md shadow-sm"><option value="all">Todos</option><option>Crédito</option><option>Débito</option><option>PIX</option></select></div>
                        </div>
                        <div class="overflow-x-auto"><table class="min-w-full responsive-table"><thead class="table-header"><tr><th class="px-6 py-3 text-left text-xs font-medium uppercase">Data</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Descrição</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Categoria</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Tipo</th><th class="px-6 py-3 text-right text-xs font-medium uppercase">Valor</th><th class="px-6 py-3 text-right text-xs font-medium uppercase">Ações</th></tr></thead><tbody id="expense-table-body"></tbody></table></div>
                    </div>
                </div>
    
                <div class="lg:col-span-2 space-y-6">
                    <div class="card"><h3 class="text-lg font-semibold text-gray-700 mb-4">Gerenciar Rendas Mensais</h3><form id="income-form" class="flex items-end gap-2 mb-4"><div class="flex-grow"><label for="income-month" class="block text-sm font-medium">Mês/Ano</label><input type="month" id="income-month" class="mt-1 block w-full rounded-md shadow-sm" required></div><div><label for="income-amount" class="block text-sm font-medium">Renda (R$)</label><input type="number" step="0.01" id="income-amount" class="mt-1 block w-full rounded-md shadow-sm" required placeholder="6000,00"></div><button type="submit" class="py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Salvar</button></form><div id="monthly-incomes-list" class="text-sm space-y-1"></div></div>
                    <div class="card"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold text-gray-700">Visão Geral</h3></div><div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center"><div><h3 class="text-sm font-medium text-gray-500">Gasto Total</h3><p id="total-expenses" class="mt-1 text-2xl font-semibold text-red-500">R$ 0,00</p></div><div><h3 class="text-sm font-medium text-gray-500">Renda Comprometida</h3><p id="income-percentage" class="mt-1 text-2xl font-semibold text-yellow-500">0%</p></div><div><h3 class="text-sm font-medium text-gray-500">Saldo Restante</h3><p id="remaining-balance" class="mt-1 text-2xl font-semibold text-green-500">R$ 0,00</p></div></div></div>
                    <div class="card"><h3 class="text-lg font-semibold text-gray-700">Fixos vs. Variáveis</h3><canvas id="cost-type-chart" class="mt-4"></canvas></div>
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-700">Renda Comprometida por Pagamento</h3>
                        <canvas id="payment-commitment-chart" class="mt-4"></canvas>
                    </div>
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Progresso do Orçamento</h3>
                        <div id="budget-progress-container" class="space-y-4"></div>
                    </div>
                    <div class="card"><h3 class="text-lg font-semibold text-gray-700 mb-4">Gastos por Categoria</h3><canvas id="monthly-category-chart" class="mt-4"></canvas><div id="monthly-analysis-details" class="mt-4 text-sm space-y-1"></div></div>
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-700">Comparação de Gastos Mensais</h3>
                        <canvas id="monthly-comparison-chart" class="mt-4"></canvas>
                    </div>
                    <div class="card"><h3 class="text-lg font-semibold text-gray-700 mb-4">Análise com IA</h3><button id="gemini-button" class="w-full flex items-center justify-center py-2 px-3 border rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700">✨ Gerar Dicas com IA</button><div id="analysis-text" class="text-sm space-y-2 mt-4"><p>Faça login e salve seus dados para usar a IA.</p></div><div id="tip-ia" class="mini-tip">💡 <b>Dica:</b> Após adicionar alguns gastos, clique aqui para receber uma análise financeira personalizada e dicas para economizar!<button onclick="dismissTip('tip-ia')" class="mini-tip-close">&times;</button></div></div>
                </div>
            </main>
        </div>

        <div id="reservas-view" class="hidden">
            <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <div class="lg:col-span-3 space-y-6">
                    <div class="card"><h2 class="text-xl font-semibold text-gray-700 mb-4">Adicionar Nova Reserva</h2>
                        <form id="saving-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div><label for="saving-month" class="block text-sm font-medium">Mês/Ano</label><input type="month" id="saving-month" class="mt-1 block w-full rounded-md shadow-sm" required></div>
                            <div><label for="saving-type" class="block text-sm font-medium">Tipo</label><select id="saving-type" class="mt-1 block w-full rounded-md shadow-sm" required><option>Reserva de Emergência</option><option>Investimentos</option><option>Outros</option></select></div>
                            <div class="sm:col-span-2"><label for="saving-goal-link" class="block text-sm font-medium">Associar a uma Meta (Opcional)</label><select id="saving-goal-link" class="mt-1 block w-full rounded-md shadow-sm"><option value="none">Nenhuma</option></select></div>
                            <div class="sm:col-span-2"><label for="saving-amount" class="block text-sm font-medium">Valor (R$)</label><input type="number" step="0.01" id="saving-amount" class="mt-1 block w-full rounded-md shadow-sm" required placeholder="500,00"></div>
                            <div class="sm:col-span-2"><button type="submit" class="w-full sm:w-auto mt-4 justify-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Adicionar Reserva</button></div>
                        </form>
                    </div>
                    <div class="card">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-gray-700">Histórico de Reservas</h2>
                            <button onclick="exportToCsv('savings')" class="py-1 px-3 border rounded-md shadow-sm text-sm font-medium export-button">Exportar CSV</button>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="filter-saving-month" class="block text-sm font-medium text-gray-600">Filtrar por Mês</label>
                                <select id="filter-saving-month" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm"></select>
                            </div>
                            <div>
                                <label for="filter-saving-type" class="block text-sm font-medium text-gray-600">Filtrar por Tipo</label>
                                <select id="filter-saving-type" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                    <option value="all">Todos os Tipos</option>
                                    <option>Reserva de Emergência</option>
                                    <option>Investimentos</option>
                                    <option>Outros</option>
                                </select>
                            </div>
                        </div>
                        <div class="overflow-x-auto"><table class="min-w-full responsive-table"><thead class="table-header"><tr><th class="px-6 py-3 text-left text-xs font-medium uppercase">Mês</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Tipo</th><th class="px-6 py-3 text-right text-xs font-medium uppercase">Valor (R$)</th><th class="px-6 py-3"><span class="sr-only">Ações</span></th></tr></thead><tbody id="savings-table-body"></tbody></table></div>
                    </div>
                </div>
                <div class="lg:col-span-2 space-y-6">
                    <div class="card text-center"><h3 class="text-lg font-medium text-gray-500">Total Guardado</h3><p id="total-savings" class="mt-1 text-3xl sm:text-4xl font-bold text-green-500">R$ 0,00</p></div>
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-700">Progresso das Metas</h3>
                        <div id="goal-progress-container" class="space-y-4"></div>
                    </div>
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-700">Total por Tipo de Reserva</h3>
                        <canvas id="savings-by-type-chart" class="mt-4"></canvas>
                    </div>
                </div>
            </main>
        </div>
        
        <div id="orcamentos-view" class="hidden">
            <div class="card max-w-2xl mx-auto">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Gerir Orçamentos Mensais</h2>
                <p class="text-gray-500 mb-6">Defina o seu limite de gastos para cada categoria no mês selecionado.</p>
                <div class="mb-4">
                    <label for="budget-month" class="block text-sm font-medium mb-1">Selecione o Mês</label>
                    <input type="month" id="budget-month" class="block w-full sm:w-64 rounded-md shadow-sm">
                </div>
                <div id="budget-inputs-container" class="space-y-3 mt-6"></div>
                <button id="save-budget-button" class="w-full sm:w-auto mt-6 justify-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Salvar Orçamento</button>
            </div>
        </div>

        <div id="metas-view" class="hidden">
             <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Criar Nova Meta de Poupança</h2>
                    <p class="text-gray-500 mb-6">Dê um nome e um valor alvo para o seu objetivo.</p>
                    <form id="goal-form" class="space-y-4">
                        <div>
                             <label for="goal-name" class="block text-sm font-medium">Nome da Meta</label>
                             <input type="text" id="goal-name" class="mt-1 block w-full rounded-md shadow-sm" placeholder="Ex: Férias no Japão" required>
                        </div>
                        <div>
                             <label for="goal-target" class="block text-sm font-medium">Valor Alvo (R$)</label>
                             <input type="number" step="0.01" id="goal-target" class="mt-1 block w-full rounded-md shadow-sm" placeholder="15000,00" required>
                        </div>
                        <button type="submit" class="w-full sm:w-auto justify-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Criar Meta</button>
                    </form>
                </div>
                 <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Minhas Metas</h2>
                    <div id="goals-list-container" class="space-y-4"></div>
                 </div>
             </main>
        </div>
    </div>

    <div id="edit-modal" class="modal-overlay">
        <div class="card modal-content">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Editar Despesa</h2>
            <form id="edit-expense-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <input type="hidden" id="edit-expense-id">
                <div><label for="edit-date" class="block text-sm font-medium">Data</label><input type="date" id="edit-date" class="mt-1 block w-full rounded-md shadow-sm" required></div>
                <div><label for="edit-cost-type" class="block text-sm font-medium">Tipo</label><select id="edit-cost-type" class="mt-1 block w-full rounded-md shadow-sm" required><option>Variável</option><option>Fixo</option></select></div>
                <div><label for="edit-category" class="block text-sm font-medium">Categoria</label><select id="edit-category" class="mt-1 block w-full rounded-md shadow-sm" required><option>Moradia</option><option>Alimentação</option><option>Transporte</option><option>Lazer</option><option>Saúde</option><option>Vestuário</option><option>Educação</option><option>Outros</option></select></div>
                <div><label for="edit-payment-type" class="block text-sm font-medium">Pagamento</label><select id="edit-payment-type" class="mt-1 block w-full rounded-md shadow-sm" required><option>Crédito</option><option>Débito</option><option>PIX</option></select></div>
                <div class="sm:col-span-2"><label for="edit-description" class="block text-sm font-medium">Descrição</label><input type="text" id="edit-description" class="mt-1 block w-full rounded-md shadow-sm" required></div>
                <div><label for="edit-bank" class="block text-sm font-medium">Banco</label><select id="edit-bank" class="mt-1 block w-full rounded-md shadow-sm" required><option>Nubank</option><option>Itaú</option><option>Bradesco</option><option>Santander</option><option>Banco do Brasil</option><option>Caixa</option><option>Inter</option><option>Outro</option></select></div>
                <div><label for="edit-amount" class="block text-sm font-medium">Valor (R$)</label><input type="number" step="0.01" id="edit-amount" class="mt-1 block w-full rounded-md shadow-sm" required></div>
                <div id="edit-recurring-options" class="sm:col-span-2 hidden">
                    <label for="edit-recurrence-scope" class="block text-sm font-medium">Aplicar alteração a:</label>
                    <select id="edit-recurrence-scope" class="mt-1 block w-full rounded-md shadow-sm">
                        <option value="single">Apenas esta despesa</option>
                        <option value="future">Esta e as futuras</option>
                        <option value="all">Todas as despesas da série</option>
                    </select>
                </div>
                <div class="sm:col-span-2 flex justify-end gap-4 mt-4">
                    <button type="button" id="cancel-edit-button" class="py-2 px-4 border rounded-md shadow-sm text-sm font-medium">Cancelar</button>
                    <button type="submit" class="py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- DADOS GLOBAIS ---
        let expenses = [];
        let monthlyIncomes = {};
        let savings = [];
        let budgets = {};
        let savingsGoals = [];
        
        // --- GRÁFICOS (instâncias) ---
        let monthlyCategoryChart, costTypeChart, savingsByTypeChart, monthlyComparisonChart, paymentCommitmentChart;
        
        // --- CONFIGURAÇÃO GOOGLE API ---
        const CLIENT_ID = '164577357008-o68h1qr3h69ik5ot1531f1fvvrl40umr.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyALVa2RTydoXDNsJP6NmtTV6b7zYhFixY0';
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const FILENAME = 'minhas_financas_dados.json';
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let driveFileId = null;

        // --- FUNÇÕES DE FORMATAÇÃO ---
        const formatCurrency = (value) => `R$ ${typeof value === 'number' ? value.toFixed(2).replace('.', ',') : '0,00'}`;
        const formatDate = (dateString) => { const [y, m, d] = dateString.split('-'); return `${d}/${m}/${y}`; };
        const formatMonthYear = (monthString) => {
            if (!monthString || !monthString.includes('-')) return '';
            const [year, month] = monthString.split('-');
            const date = new Date(year, parseInt(month) - 1);
            const formatted = date.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
            return formatted.charAt(0).toUpperCase() + formatted.slice(1);
        };
        
        // --- FUNÇÕES DE DADOS (CARREGAR/SALVAR) ---
        function loadDefaultData() {
            expenses = []; monthlyIncomes = {}; savings = []; budgets = {}; savingsGoals = [];
        }

        async function saveDataToDrive() {
            const saveDataButton = document.getElementById('save-data-button');
            saveDataButton.disabled = true;
            saveDataButton.textContent = 'Salvando...';
            const allData = { expenses, monthlyIncomes, savings, budgets, savingsGoals, lastUpdated: new Date().toISOString() };
            const dataBlob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
            try {
                const formData = new FormData();
                let method, path;
                if (driveFileId) {
                    path = `/upload/drive/v3/files/${driveFileId}?uploadType=multipart`;
                    method = 'PATCH';
                    formData.append('metadata', new Blob([JSON.stringify({})], { type: 'application/json' }));
                } else {
                    path = '/upload/drive/v3/files?uploadType=multipart';
                    method = 'POST';
                    const metadata = { name: FILENAME, mimeType: 'application/json' };
                    formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                }
                formData.append('file', dataBlob);
                const response = await fetch(`https://www.googleapis.com${path}`, {
                    method: method,
                    headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}` },
                    body: formData
                });
                if (!response.ok) throw await response.json();
                const result = await response.json();
                driveFileId = result.id; 
                saveDataButton.textContent = 'Salvo!';
            } catch (err) {
                console.error("Erro ao salvar no Drive", err);
                saveDataButton.textContent = 'Erro ao Salvar';
            } finally {
                setTimeout(() => {
                    const currentSaveButton = document.getElementById('save-data-button');
                    if(currentSaveButton && !currentSaveButton.disabled){
                       currentSaveButton.textContent = 'Salvar';
                    }
                }, 3000);
            }
        }
        
        async function loadDataFromDrive() {
            const authStatus = document.getElementById('auth-status');
            try {
                authStatus.textContent = 'Buscando dados...';
                const response = await gapi.client.drive.files.list({ q: `name='${FILENAME}' and trashed=false`, spaces: 'drive', fields: 'files(id, name)' });
                if (response.result.files && response.result.files.length > 0) {
                    driveFileId = response.result.files[0].id;
                    const fileResponse = await gapi.client.drive.files.get({ fileId: driveFileId, alt: 'media' });
                    const data = JSON.parse(fileResponse.body);
                    expenses = data.expenses || [];
                    monthlyIncomes = data.monthlyIncomes || {};
                    savings = data.savings || [];
                    budgets = data.budgets || {};
                    savingsGoals = data.savingsGoals || [];
                    authStatus.textContent = 'Dados carregados!';
                } else {
                    driveFileId = null; 
                    loadDefaultData();
                    authStatus.textContent = 'Nenhum arquivo encontrado.';
                }
            } catch (err) {
                authStatus.textContent = 'Erro ao carregar dados.';
                loadDefaultData();
            } finally {
                updateAllUI();
                setTimeout(() => { if (gapi.client.getToken()) authStatus.textContent = 'Conectado'; }, 3000);
            }
        }

        // --- LÓGICA DE LOGIN (PERSISTENTE E AUTH) ---
        function checkPersistentLogin() {
            const sessionData = localStorage.getItem('googleSession');
            if (!sessionData) return;
            const session = JSON.parse(sessionData);
            const now = new Date().getTime();
            const fifteenDaysInMillis = 15 * 24 * 60 * 60 * 1000;
            if (now - session.lastSeen > fifteenDaysInMillis) {
                localStorage.removeItem('googleSession');
                return;
            }
            session.lastSeen = now;
            localStorage.setItem('googleSession', JSON.stringify(session));
            gapi.client.setToken({ access_token: session.token });
            updateSigninStatus(true);
        }

        function updateSigninStatus(isSignedIn) {
            const authStatus = document.getElementById('auth-status');
            const authButton = document.getElementById('google-auth-button');
            const saveDataButton = document.getElementById('save-data-button');
            const geminiButton = document.getElementById('gemini-button');
            const shouldLoadData = isSignedIn && expenses.length === 0 && savings.length === 0;
            if (isSignedIn) {
                authStatus.textContent = 'Conectado';
                authButton.textContent = 'Sair';
                saveDataButton.disabled = false;
                geminiButton.disabled = false;
                if (shouldLoadData) {
                    loadDataFromDrive();
                }
            } else {
                authStatus.textContent = 'Desconectado';
                authButton.textContent = 'Fazer Login';
                saveDataButton.disabled = true;
                geminiButton.disabled = true;
                driveFileId = null;
                loadDefaultData();
                updateAllUI();
            }
        }

        window.gapiLoaded = () => { gapi.load('client', initializeGapiClient); };
        window.gisLoaded = () => {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPES, callback: (tokenResponse) => {
                    if (tokenResponse.error) { return; }
                    const session = { token: tokenResponse.access_token, lastSeen: new Date().getTime() };
                    localStorage.setItem('googleSession', JSON.stringify(session));
                    gapi.client.setToken(tokenResponse);
                    updateSigninStatus(true);
                },
            });
            gisInited = true; 
            maybeEnableButtons();
        };
        async function initializeGapiClient() { 
            await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS }); 
            gapiInited = true; 
            maybeEnableButtons(); 
        }
        function maybeEnableButtons() { 
            const authButton = document.getElementById('google-auth-button');
            if (gapiInited && gisInited) { 
                authButton.disabled = false; 
                checkPersistentLogin();
            } 
        }

        // --- LÓGICA MODAL DE EDIÇÃO ---
        window.openEditModal = (id) => {
            const expense = expenses.find(e => e.id === id);
            if (!expense) return;
            document.getElementById('edit-expense-id').value = expense.id;
            document.getElementById('edit-date').value = expense.date;
            document.getElementById('edit-cost-type').value = expense.costType;
            document.getElementById('edit-category').value = expense.category;
            document.getElementById('edit-payment-type').value = expense.type;
            document.getElementById('edit-description').value = expense.description;
            document.getElementById('edit-bank').value = expense.bank;
            document.getElementById('edit-amount').value = expense.amount;
            const recurringOptions = document.getElementById('edit-recurring-options');
            if (expense.recurrenceId) {
                recurringOptions.classList.remove('hidden');
            } else {
                recurringOptions.classList.add('hidden');
            }
            document.getElementById('edit-modal').classList.add('visible');
        }

        // --- LÓGICA DE ORÇAMENTOS ---
        function renderBudgetInputs(month) {
            const container = document.getElementById('budget-inputs-container');
            if (!container) return;
            container.innerHTML = '';
            const categories = ["Moradia", "Alimentação", "Transporte", "Lazer", "Saúde", "Vestuário", "Educação", "Outros"];
            const monthBudgets = budgets[month] || {};
            categories.forEach(category => {
                const value = monthBudgets[category] || '';
                const inputGroup = document.createElement('div');
                inputGroup.className = 'grid grid-cols-3 gap-4 items-center';
                inputGroup.innerHTML = `
                    <label for="budget-${category}" class="col-span-1 text-sm font-medium">${category}</label>
                    <div class="col-span-2 relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500 sm:text-sm">R$</span>
                        <input type="number" step="0.01" id="budget-${category}" data-category="${category}" value="${value}" class="pl-10 block w-full rounded-md shadow-sm" placeholder="0,00">
                    </div>
                `;
                container.appendChild(inputGroup);
            });
        }

        function saveBudgets() {
            const month = document.getElementById('budget-month').value;
            if (!month) {
                alert("Por favor, selecione um mês.");
                return;
            }
            budgets[month] = budgets[month] || {};
            document.querySelectorAll('#budget-inputs-container input').forEach(input => {
                const category = input.dataset.category;
                const amount = parseFloat(input.value);
                if (amount > 0) {
                    budgets[month][category] = amount;
                } else {
                    delete budgets[month][category];
                }
            });
            alert(`Orçamento para ${formatMonthYear(month)} salvo com sucesso!`);
            updateAllUI();
        }
        
        // --- LÓGICA DE METAS DE POUPANÇA ---
        function renderGoalsList() {
            const container = document.getElementById('goals-list-container');
            if (!container) return;
            container.innerHTML = '';
            if (savingsGoals.length === 0) {
                container.innerHTML = `<p class="text-sm text-gray-500">Nenhuma meta criada ainda. Crie a sua primeira ao lado!</p>`;
                return;
            }
            savingsGoals.forEach(goal => {
                const savedAmount = savings.filter(s => s.goalId === goal.id).reduce((sum, s) => sum + s.amount, 0);
                const percentage = goal.targetAmount > 0 ? Math.min((savedAmount / goal.targetAmount) * 100, 100) : 0;
                const goalElement = document.createElement('div');
                goalElement.className = 'p-3 border rounded-md';
                goalElement.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold">${goal.name}</span>
                        <button onclick="deleteGoal(${goal.id})" class="text-red-500 hover:text-red-700 text-xs font-semibold">Excluir</button>
                    </div>
                    <div class="flex justify-between text-sm mb-1">
                        <span>Alcançado: ${formatCurrency(savedAmount)}</span>
                        <span>Meta: ${formatCurrency(goal.targetAmount)}</span>
                    </div>
                    <div class="progress-bg">
                        <div class="progress-fill goal" style="width: ${percentage}%;"></div>
                    </div>
                `;
                container.appendChild(goalElement);
            });
        }

        function populateGoalsDropdown() {
            const select = document.getElementById('saving-goal-link');
            if (!select) return;
            const currentValue = select.value;
            select.innerHTML = '<option value="none">Nenhuma</option>';
            savingsGoals.forEach(goal => {
                const option = new Option(`${goal.name} (${formatCurrency(goal.targetAmount)})`, goal.id);
                select.add(option);
            });
            select.value = currentValue;
        }
        
        // --- FUNÇÕES DE ATUALIZAÇÃO E RENDERIZAÇÃO ---
        function updateAllUI() {
            populateExpenseMonthFilter();
            syncDespesasView();
            renderMonthlyIncomes();
            updateSavingsDashboard();
            applySavingsFiltersAndRender();
            updateMonthlyComparisonChart();
            updateGoalProgress();
            populateGoalsDropdown();
            renderGoalsList();
        }

        function syncDespesasView() {
            const month = document.getElementById('filter-month').value;
            const category = document.getElementById('filter-category').value;
            const payment = document.getElementById('filter-payment').value;
            
            let filteredData = (month === 'all')
                ? [...expenses]
                : expenses.filter(e => e.date.startsWith(month));

            if (category !== 'all') {
                filteredData = filteredData.filter(e => e.category === category);
            }
            if (payment !== 'all') {
                filteredData = filteredData.filter(e => e.type === payment);
            }

            const tableShouldBeEmpty = month === 'all' && category === 'all' && payment === 'all';
            renderExpenseTable(tableShouldBeEmpty ? [] : filteredData);
            updateSummaryCards(filteredData, month);
            updateCostTypeAnalysis(filteredData);
            updateMonthlyAnalysis(filteredData);
            updateBudgetProgress(filteredData, month);
            updatePaymentTypeCommitmentChart(filteredData, month);
        }

        function populateExpenseMonthFilter() {
            const uniqueMonths = [...new Set(expenses.map(e => e.date.substring(0, 7)))].sort().reverse();
            const monthSelect = document.getElementById('filter-month');
            const currentVal = monthSelect.value;
            monthSelect.innerHTML = '<option value="all">Todos os Meses</option>';
            uniqueMonths.forEach(m => monthSelect.add(new Option(formatMonthYear(m), m)));
            monthSelect.value = uniqueMonths.includes(currentVal) ? currentVal : 'all';
        }

        function renderMonthlyIncomes() {
             const listEl = document.getElementById('monthly-incomes-list');
            listEl.innerHTML = '';
            Object.keys(monthlyIncomes).sort().reverse().forEach(month => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-gray-50 p-2 rounded';
                div.innerHTML = `<span>${formatMonthYear(month)}: <strong>${formatCurrency(monthlyIncomes[month])}</strong></span> <button onclick="deleteIncome('${month}')" class="text-red-500 hover:text-red-700 text-xs font-semibold">Excluir</button>`;
                listEl.appendChild(div);
            });
        }
        
        function updateSummaryCards(filteredData, month) {
            const relevantIncome = (month === 'all')
                ? Object.values(monthlyIncomes).reduce((s, i) => s + i, 0)
                : monthlyIncomes[month] || 0;
            const total = filteredData.reduce((s, e) => s + e.amount, 0);
            document.getElementById('total-expenses').textContent = formatCurrency(total);
            document.getElementById('income-percentage').textContent = `${(relevantIncome > 0 ? (total / relevantIncome) * 100 : 0).toFixed(1)}%`;
            document.getElementById('remaining-balance').textContent = formatCurrency(relevantIncome - total);
        }

        function updateMonthlyAnalysis(filteredData) {
            const chartCanvas = document.getElementById('monthly-category-chart');
            const detailsContainer = document.getElementById('monthly-analysis-details');
            if (monthlyCategoryChart) monthlyCategoryChart.destroy();
            
            if (filteredData.length === 0) {
                detailsContainer.innerHTML = '';
                chartCanvas.style.display = 'none';
                return;
            }
            chartCanvas.style.display = 'block';
            const categoryData = filteredData.reduce((acc, {category, amount}) => ({...acc, [category]: (acc[category] || 0) + amount}), {});
            let detailsHtml = `<strong>Resumo dos Filtros:</strong><ul class="list-disc ml-4 mt-2">`;
            Object.entries(categoryData).sort(([,a],[,b]) => b-a).forEach(([cat, amt]) => detailsHtml += `<li>${cat}: <strong>${formatCurrency(amt)}</strong></li>`);
            detailsContainer.innerHTML = detailsHtml + '</ul>';
            
            monthlyCategoryChart = new Chart(chartCanvas, {
                type: 'pie', data: { labels: Object.keys(categoryData), datasets: [{ data: Object.values(categoryData), backgroundColor: ['#4f46e5', '#ec4899', '#f59e0b', '#10b981', '#ef4444', '#3b82f6', '#8b5cf6'] }] },
                options: { responsive: true, plugins: { legend: { position: 'top' } } }
            });
        }
        
        function updateCostTypeAnalysis(filteredData) {
            if (costTypeChart) costTypeChart.destroy();
            const costData = filteredData.reduce((acc, {costType, amount}) => {
                acc[costType] = (acc[costType] || 0) + amount;
                return acc;
            }, { 'Fixo': 0, 'Variável': 0 });
            costTypeChart = new Chart(document.getElementById('cost-type-chart'), {
                type: 'pie',
                data: { labels: Object.keys(costData), datasets: [{ data: Object.values(costData), backgroundColor: ['#3b82f6', '#f59e0b'] }] },
                options: { responsive: true, plugins: { legend: { position: 'top' } } }
            });
        }
        
        function applySavingsFiltersAndRender() {
            const monthFilter = document.getElementById('filter-saving-month').value;
            const typeFilter = document.getElementById('filter-saving-type').value;
            if (monthFilter === 'all' && typeFilter === 'all') {
                renderSavingsTable([]);
                return;
            }
            let filteredSavings = [...savings];
            if (monthFilter !== 'all') {
                filteredSavings = filteredSavings.filter(s => s.month === monthFilter);
            }
            if (typeFilter !== 'all') {
                filteredSavings = filteredSavings.filter(s => s.type === typeFilter);
            }
            renderSavingsTable(filteredSavings);
        }

        function renderSavingsTable(savingsToRender) {
            const savingsTableBody = document.getElementById('savings-table-body');
            savingsTableBody.innerHTML = '';
            if (savingsToRender.length === 0) {
                const message = "Use os filtros acima para ver o histórico de reservas.";
                savingsTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-10 text-gray-500">${message}</td></tr>`;
                return;
            }
            savingsToRender.sort((a, b) => b.month.localeCompare(a.month)).forEach(saving => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Mês" class="px-6 py-4 whitespace-nowrap text-sm font-medium">${formatMonthYear(saving.month)}</td>
                    <td data-label="Tipo" class="px-6 py-4 whitespace-nowrap text-sm">${saving.type}</td>
                    <td data-label="Valor" class="px-6 py-4 whitespace-nowrap text-sm text-green-500 text-right font-semibold">${formatCurrency(saving.amount)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium actions-cell">
                        <button onclick="deleteSaving(${saving.id})" class="text-red-600 hover:text-red-900">Excluir</button>
                    </td>
                `;
                savingsTableBody.appendChild(row);
            });
        }

        function updateSavingsDashboard() {
            const total = savings.reduce((sum, s) => sum + s.amount, 0);
            document.getElementById('total-savings').textContent = formatCurrency(total);
            const uniqueMonths = [...new Set(savings.map(s => s.month))].sort().reverse();
            const monthFilterEl = document.getElementById('filter-saving-month');
            const currentMonthVal = monthFilterEl.value;
            monthFilterEl.innerHTML = '<option value="all">Todos os Meses</option>';
            uniqueMonths.forEach(m => monthFilterEl.add(new Option(formatMonthYear(m), m)));
            monthFilterEl.value = currentMonthVal;
            const byTypeData = savings.reduce((acc, {type, amount}) => {
                const key = type;
                acc[key] = (acc[key] || 0) + amount;
                return acc;
            }, {});
            if (savingsByTypeChart) savingsByTypeChart.destroy();
            savingsByTypeChart = new Chart(document.getElementById('savings-by-type-chart'), {
                type: 'bar',
                data: { 
                    labels: Object.keys(byTypeData), 
                    datasets: [{ 
                        label: 'Total Guardado',
                        data: Object.values(byTypeData), 
                        backgroundColor: ['#10b981', '#f59e0b', '#3b82f6', '#8b5cf6']
                    }] 
                },
                options: { 
                    responsive: true,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        function renderExpenseTable(expensesToRender) {
             const expenseTableBody = document.getElementById('expense-table-body');
            expenseTableBody.innerHTML = '';
            if (expensesToRender.length === 0) {
                 const isFiltered = document.getElementById('filter-month').value !== 'all' || document.getElementById('filter-category').value !== 'all' || document.getElementById('filter-payment').value !== 'all';
                 const message = isFiltered ? "Nenhum resultado para os filtros." : "Use os filtros para ver o histórico.";
                 expenseTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-gray-500">${message}</td></tr>`;
                 return;
             }
            expensesToRender.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(expense => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Data">${formatDate(expense.date)}</td>
                    <td data-label="Descrição">${expense.description}</td>
                    <td data-label="Categoria">${expense.category}</td>
                    <td data-label="Tipo">${expense.costType}</td>
                    <td data-label="Valor" class="text-red-500 font-medium">${formatCurrency(expense.amount)}</td>
                    <td data-label="Ações" class="actions-cell">
                        <button onclick="openEditModal(${expense.id})" class="text-blue-600 hover:text-blue-900">Editar</button>
                        <button onclick="deleteExpense(${expense.id})" class="text-red-600 hover:text-red-900">Excluir</button>
                    </td>
                `;
                expenseTableBody.appendChild(row);
            });
        }
        
        function updateGoalProgress() {
            const container = document.getElementById('goal-progress-container');
            if (!container) return;
            container.innerHTML = '';
            if (savingsGoals.length === 0) {
                 container.innerHTML = `<p class="text-sm text-gray-500">Crie uma meta na aba 'Metas' para ver o progresso aqui.</p>`;
                 return;
            }
            savingsGoals.forEach(goal => {
                 const savedAmount = savings.filter(s => s.goalId === goal.id).reduce((sum, s) => sum + s.amount, 0);
                 const percentage = goal.targetAmount > 0 ? Math.min((savedAmount / goal.targetAmount) * 100, 100) : 0;
                 const progressElement = document.createElement('div');
                 progressElement.innerHTML = `
                    <div class="flex justify-between text-sm mb-1">
                        <span class="font-medium">${goal.name}</span>
                        <span>${percentage.toFixed(1)}%</span>
                    </div>
                    <div class="progress-bg">
                        <div class="progress-fill goal" style="width: ${percentage}%;"></div>
                    </div>
                 `;
                 container.appendChild(progressElement);
            });
        }
        
        // --- TEMA E DICAS ---
        function applyTheme(theme) {
            const sunIcon = document.getElementById('theme-icon-sun');
            const moonIcon = document.getElementById('theme-icon-moon');
            if (theme === 'dark') {
                document.body.classList.add('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                document.body.classList.remove('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
            updateChartTheme();
            // A chamada para updateAllUI foi movida para o final da updateChartTheme para garantir que as cores sejam aplicadas primeiro
        }

        function toggleTheme() {
            const newTheme = document.body.classList.contains('dark') ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        }

        function updateChartTheme() {
            const isDark = document.body.classList.contains('dark');
            const textColor = isDark ? '#d1d5db' : '#374151';
            Chart.defaults.color = textColor;
            // CORREÇÃO: A chamada para updateAllUI() foi removida daqui para quebrar o loop.
            // A atualização visual agora é garantida pela chamada na função applyTheme.
        }

        function initializeTips() {
            const dismissedTips = JSON.parse(localStorage.getItem('dismissedTips')) || [];
            document.querySelectorAll('.mini-tip').forEach(tip => {
                if (!dismissedTips.includes(tip.id)) {
                    tip.style.display = 'block';
                } else {
                    tip.style.display = 'none';
                }
            });
        }
        window.dismissTip = (tipId) => {
            const dismissedTips = JSON.parse(localStorage.getItem('dismissedTips')) || [];
            if (!dismissedTips.includes(tipId)) {
                dismissedTips.push(tipId);
                localStorage.setItem('dismissedTips', JSON.stringify(dismissedTips));
            }
            document.getElementById(tipId).style.display = 'none';
        }

        // --- FUNÇÕES DE EXPORTAÇÃO E GRÁFICOS ---
        function exportToCsv(dataType) {
            const data = dataType === 'expenses' ? expenses : savings;
            if (data.length === 0) {
                alert(`Não há ${dataType === 'expenses' ? 'despesas' : 'reservas'} para exportar.`);
                return;
            }
            const headers = Object.keys(data[0]);
            const csvRows = [headers.join(',')];
            data.forEach(item => {
                const values = headers.map(header => {
                    let value = item[header];
                    if (typeof value === 'string' && value.includes(',')) {
                        value = `"${value}"`;
                    }
                    return value;
                });
                csvRows.push(values.join(','));
            });
            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `${dataType}_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function updateMonthlyComparisonChart() {
            if (monthlyComparisonChart) {
                monthlyComparisonChart.destroy();
            }
            const monthlyData = expenses.reduce((acc, exp) => {
                const month = exp.date.substring(0, 7);
                acc[month] = (acc[month] || 0) + exp.amount;
                return acc;
            }, {});
            const sortedMonths = Object.keys(monthlyData).sort().slice(-6);
            monthlyComparisonChart = new Chart(document.getElementById('monthly-comparison-chart'), {
                type: 'line',
                data: {
                    labels: sortedMonths.map(formatMonthYear),
                    datasets: [{
                        label: 'Total de Gastos',
                        data: sortedMonths.map(month => monthlyData[month]),
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updatePaymentTypeCommitmentChart(filteredData, month) {
            if (paymentCommitmentChart) paymentCommitmentChart.destroy();
            const container = document.getElementById('payment-commitment-chart');
            if(!container) return;
            
            const relevantIncome = (month === 'all')
                ? Object.values(monthlyIncomes).reduce((sum, income) => sum + income, 0)
                : monthlyIncomes[month] || 0;

            if (relevantIncome === 0 || filteredData.length === 0) {
                container.style.display = 'none';
                return;
            }
            container.style.display = 'block';

            const paymentData = filteredData.reduce((acc, {type, amount}) => {
                acc[type] = (acc[type] || 0) + amount;
                return acc;
            }, {});

            const labels = Object.keys(paymentData);
            const dataValues = labels.map(label => ((paymentData[label] / relevantIncome) * 100).toFixed(2) );
            paymentCommitmentChart = new Chart(container.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ data: dataValues, backgroundColor: ['#3b82f6', '#ec4899', '#f59e0b'] }]
                },
                options: {
                    indexAxis: 'y', responsive: true, scales: { x: { beginAtZero: true, ticks: { callback: (value) => value + '%' } } },
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: (context) => ` ${context.raw}% da renda` } } }
                }
            });
        }
        
        // --- FUNÇÃO GEMINI API ---
        async function callGeminiAPI() { /* Implementação completa... */ }
        
        // --- FUNÇÕES DE AÇÃO (DELETE) ---
        window.deleteExpense = (id) => { 
            const expenseToDelete = expenses.find(e => e.id === id);
            if (!expenseToDelete) return;
            if (expenseToDelete.recurrenceId) {
                if (confirm("Esta despesa é recorrente. Deseja apagar também as futuras?")) {
                    expenses = expenses.filter(e => !(e.recurrenceId === expenseToDelete.recurrenceId && new Date(e.date) >= new Date(expenseToDelete.date)));
                } else {
                    expenses = expenses.filter(e => e.id !== id);
                }
            } else {
                expenses = expenses.filter(e => e.id !== id);
            }
            updateAllUI(); 
        };
        window.deleteIncome = (month) => { delete monthlyIncomes[month]; updateAllUI(); };
        window.deleteSaving = (id) => { savings = savings.filter(s => s.id !== id); updateAllUI(); };
        window.deleteGoal = (id) => {
            savingsGoals = savingsGoals.filter(g => g.id !== id);
            savings.forEach(s => {
                if (s.goalId === id) { s.goalId = null; }
            });
            updateAllUI();
        };
        
        // --- INICIALIZAÇÃO E LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            const expenseForm = document.getElementById('expense-form');
            const incomeForm = document.getElementById('income-form');
            const savingForm = document.getElementById('saving-form');
            const goalForm = document.getElementById('goal-form');
            const editForm = document.getElementById('edit-expense-form');
            const cancelEditButton = document.getElementById('cancel-edit-button');
            const themeToggleButton = document.getElementById('theme-toggle-button');
            const geminiButton = document.getElementById('gemini-button');
            const authButton = document.getElementById('google-auth-button');
            const saveDataButton = document.getElementById('save-data-button');
            const tabDespesas = document.getElementById('tab-despesas');
            const tabReservas = document.getElementById('tab-reservas');
            const tabOrcamentos = document.getElementById('tab-orcamentos');
            const tabMetas = document.getElementById('tab-metas');
            const budgetMonthInput = document.getElementById('budget-month');
            const saveBudgetButton = document.getElementById('save-budget-button');
            const filters = [document.getElementById('filter-month'), document.getElementById('filter-category'), document.getElementById('filter-payment')];
            const savingFilters = [document.getElementById('filter-saving-month'), document.getElementById('filter-saving-type')];

            const savedTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(savedTheme);
            updateSigninStatus(false);
            
            authButton.addEventListener('click', () => {
                 if (gapi.client.getToken() === null) {
                     tokenClient.requestAccessToken({prompt: 'consent'});
                } else {
                    const token = gapi.client.getToken();
                    if (token) {
                        google.accounts.oauth2.revoke(token.access_token, () => {
                            gapi.client.setToken(null);
                            localStorage.removeItem('googleSession');
                            updateSigninStatus(false);
                        });
                    } else {
                        localStorage.removeItem('googleSession');
                        updateSigninStatus(false);
                    }
                }
            });

            const tabs = [
                { button: tabDespesas, view: document.getElementById('despesas-view') },
                { button: tabReservas, view: document.getElementById('reservas-view') },
                { button: tabOrcamentos, view: document.getElementById('orcamentos-view') },
                { button: tabMetas, view: document.getElementById('metas-view') }
            ];
            tabs.forEach(tab => {
                tab.button.addEventListener('click', () => {
                    tabs.forEach(t => {
                        t.button.classList.remove('active');
                        t.view.classList.add('hidden');
                    });
                    tab.button.classList.add('active');
                    tab.view.classList.remove('hidden');
                    if (tab.button.id === 'tab-reservas') { populateGoalsDropdown(); }
                    if (tab.button.id === 'tab-orcamentos') {
                        if (!budgetMonthInput.value) {
                            const now = new Date();
                            const year = now.getFullYear();
                            const month = (now.getMonth() + 1).toString().padStart(2, '0');
                            budgetMonthInput.value = `${year}-${month}`;
                        }
                        renderBudgetInputs(budgetMonthInput.value);
                    }
                    if (tab.button.id === 'tab-metas') { renderGoalsList(); }
                });
            });

            budgetMonthInput.addEventListener('change', () => { renderBudgetInputs(budgetMonthInput.value); });
            saveBudgetButton.addEventListener('click', saveBudgets);

            goalForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('goal-name').value;
                const target = parseFloat(document.getElementById('goal-target').value);
                if (name && target > 0) {
                    savingsGoals.push({ id: Date.now(), name: name, targetAmount: target });
                    updateAllUI();
                    goalForm.reset();
                }
            });

            expenseForm.addEventListener('submit', e => {
                e.preventDefault();
                const isRecurring = document.getElementById('is-recurring').checked;
                const recurrenceId = isRecurring ? Date.now() : null;
                const baseExpense = {
                    costType: document.getElementById('cost-type').value, type: document.getElementById('payment-type').value,
                    description: document.getElementById('description').value, amount: parseFloat(document.getElementById('amount').value),
                    category: document.getElementById('category').value, bank: document.getElementById('bank').value, recurrenceId: recurrenceId
                };
                if (isRecurring) {
                    const startDate = new Date(document.getElementById('date').value + 'T00:00:00');
                    const endDate = new Date(document.getElementById('recurrence-end-date').value + 'T00:00:00');
                    if (!document.getElementById('recurrence-end-date').value || startDate > endDate) return;
                    let currentDate = new Date(startDate.getTime());
                    while (currentDate <= endDate) {
                        expenses.push({ ...baseExpense, id: Date.now() + currentDate.getTime(), date: currentDate.toISOString().split('T')[0] });
                        currentDate.setMonth(currentDate.getMonth() + 1);
                    }
                } else {
                    expenses.push({ ...baseExpense, id: Date.now(), date: document.getElementById('date').value });
                }
                updateAllUI();
                expenseForm.reset();
                document.getElementById('date').valueAsDate = new Date();
                document.getElementById('is-recurring').checked = false;
                document.getElementById('recurring-options').classList.add('hidden');
            });

            incomeForm.addEventListener('submit', e => { 
                e.preventDefault(); 
                const m = document.getElementById('income-month').value; 
                const a = parseFloat(document.getElementById('income-amount').value); 
                if(m && a >= 0) { monthlyIncomes[m] = a; updateAllUI(); incomeForm.reset(); } 
            });
            
            savingForm.addEventListener('submit', e => {
                e.preventDefault();
                const goalId = document.getElementById('saving-goal-link').value;
                savings.push({ 
                    id: Date.now(), 
                    month: document.getElementById('saving-month').value, 
                    type: document.getElementById('saving-type').value, 
                    amount: parseFloat(document.getElementById('saving-amount').value),
                    goalId: goalId !== 'none' ? parseInt(goalId) : null
                });
                updateAllUI();
                savingForm.reset();
            });
            
            editForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = parseInt(document.getElementById('edit-expense-id').value);
                const scope = document.getElementById('edit-recurrence-scope').value;
                const updatedData = {
                    date: document.getElementById('edit-date').value, costType: document.getElementById('edit-cost-type').value,
                    category: document.getElementById('edit-category').value, type: document.getElementById('edit-payment-type').value,
                    description: document.getElementById('edit-description').value, bank: document.getElementById('edit-bank').value,
                    amount: parseFloat(document.getElementById('edit-amount').value)
                };
                const originalExpense = expenses.find(e => e.id === id);
                if (scope === 'single' || !originalExpense.recurrenceId) {
                    const index = expenses.findIndex(e => e.id === id);
                    expenses[index] = { ...expenses[index], ...updatedData };
                } else {
                    expenses.forEach((expense, index) => {
                        let shouldUpdate = false;
                        if (expense.recurrenceId === originalExpense.recurrenceId) {
                            if (scope === 'all') shouldUpdate = true;
                            if (scope === 'future' && new Date(expense.date) >= new Date(originalExpense.date)) shouldUpdate = true;
                        }
                        if (shouldUpdate) {
                            expenses[index] = { ...expense, ...updatedData, date: expense.date, id: expense.id, recurrenceId: expense.recurrenceId };
                        }
                    });
                }
                document.getElementById('edit-modal').classList.remove('visible');
                updateAllUI();
            });

            cancelEditButton.addEventListener('click', () => document.getElementById('edit-modal').classList.remove('visible'));
            themeToggleButton.addEventListener('click', toggleTheme);
            geminiButton.addEventListener('click', callGeminiAPI);
            saveDataButton.addEventListener('click', saveDataToDrive);
            filters.forEach(el => el.addEventListener('change', syncDespesasView));
            savingFilters.forEach(el => el.addEventListener('change', applySavingsFiltersAndRender));
            document.getElementById('is-recurring').addEventListener('change', (e) => { 
                document.getElementById('recurring-options').classList.toggle('hidden', !e.target.checked);
                document.getElementById('recurrence-end-date').required = e.target.checked;
            });
        });
    </script>
</body>
</html>
