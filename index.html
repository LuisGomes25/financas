<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilha de Finan√ßas Pessoais com IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <style>
        /* Estilos Gerais (incluindo Temas) */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; transition: background-color 0.3s, color 0.3s; }
        .card { background-color: white; border-radius: 0.75rem; border: 1px solid #e5e7eb; padding: 1.5rem; transition: background-color 0.3s, border-color 0.3s; }
        h1, .text-gray-800, .text-gray-900 { color: #111827 !important; }
        h2, h3, .text-gray-700 { color: #1f2937 !important; }
        p, label, .text-gray-600, .text-gray-500 { color: #4b5563 !important; }
        #auth-status { color: #6b7280 !important; }
        input, select { background-color: #f9fafb !important; border-color: #d1d5db !important; color: #111827 !important; color-scheme: light; }
        input::placeholder { color: #9ca3af; }
        .table-header { background-color: #f9fafb; }
        .responsive-table tbody, .responsive-table, .divide-y { border-color: #e5e7eb !important; }
        #google-auth-button, .export-button { background-color: #ffffff; border-color: #d1d5db; color: #374151; }
        #google-auth-button:hover, .export-button:hover { background-color: #f9fafb; }
        #monthly-incomes-list .bg-gray-50 { background-color: #f9fafb !important; }
        .tab { color: #6b7280; cursor: pointer; padding: 0.5rem 0.25rem; border-bottom: 2px solid transparent; }
        .tab.active { border-bottom-color: #4f46e5; color: #4f46e5; font-weight: 600; }
        .mb-8.border-b { border-color: #e5e7eb; }
        body.dark { background-color: #111827; color: #d1d5db; }
        body.dark .card { background-color: #1f2937; border: 1px solid #374151; }
        body.dark h1, body.dark .text-gray-800, body.dark .text-gray-900 { color: #f9fafb !important; }
        body.dark h2, body.dark h3, body.dark .text-gray-700 { color: #e5e7eb !important; }
        body.dark p, body.dark label, body.dark .text-gray-600, body.dark .text-gray-500 { color: #d1d5db !important; }
        body.dark #auth-status { color: #9ca3af !important; }
        body.dark input, body.dark select { background-color: #374151 !important; border-color: #4b5563 !important; color: #f9fafb !important; color-scheme: dark; }
        body.dark input::placeholder { color: #9ca3af; }
        body.dark .table-header { background-color: #374151; }
        body.dark .responsive-table tbody, body.dark .responsive-table, body.dark .divide-y { border-color: #374151 !important; }
        body.dark #google-auth-button, body.dark .export-button { background-color: #374151; border-color: #4b5563; color: #f9fafb; }
        body.dark #google-auth-button:hover, body.dark .export-button:hover { background-color: #4b5563; }
        body.dark #monthly-incomes-list .bg-gray-50 { background-color: #374151 !important; }
        #gemini-button:disabled, #save-data-button:disabled { cursor: not-allowed; opacity: 0.7; }

        /* Estilos do Modal de Edi√ß√£o */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all .3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { max-height: 90vh; overflow-y: auto; width: 90%; max-width: 600px; transform: translateY(-20px); transition: all .3s; }
        .modal-overlay.visible .modal-content { transform: translateY(0); }

        /* Estilos das Mini Dicas */
        .mini-tip { display: none; position: relative; background-color: #eef2ff; border-left: 4px solid #4f46e5; padding: 1rem; border-radius: 0.25rem; margin-top: 1.5rem; }
        body.dark .mini-tip { background-color: #312e81; border-color: #818cf8; }
        .mini-tip-close { position: absolute; top: 0.5rem; right: 0.5rem; background: none; border: none; font-size: 1.2rem; cursor: pointer; }
        
        /* Estilos da Barra de Progresso */
        .progress-bg { background-color: #e5e7eb; border-radius: 9999px; height: 0.75rem; overflow: hidden; }
        body.dark .progress-bg { background-color: #374151; }
        .progress-fill { height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out; }
        .progress-fill.budget { background-color: #4f46e5; }
        .progress-fill.budget.yellow { background-color: #f59e0b; }
        .progress-fill.budget.red { background-color: #ef4444; }
        .progress-fill.goal { background-color: #10b981; }


        /* Estilos Responsivos */
        @media (max-width: 767px) {
            .responsive-table thead { display: none; }
            .responsive-table tbody tr { display: block; border-radius: 0.5rem; margin-bottom: 1rem; padding: 1rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
            body.light .responsive-table tbody tr { border: 1px solid #e5e7eb; background-color: white;}
            body.dark .responsive-table tbody tr { border-color: #374151; background-color: #1f2937;}
            .responsive-table td { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0.25rem; text-align: right; }
            body.light .responsive-table td { border-bottom: 1px solid #f3f4f6; } body.dark .responsive-table td { border-bottom: 1px solid #374151; }
            .responsive-table td:last-child { border-bottom: none; }
            .responsive-table td::before { content: attr(data-label); font-weight: 600; margin-right: 1rem; text-align: left; }
            .responsive-table td .actions-cell { display: flex; gap: 1rem; justify-content: flex-end; align-items: center; width: 100%; height: 100%; }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-4 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Minhas Finan√ßas</h1>
                <p class="text-gray-500 mt-1">Sua planilha e dashboard financeiro com salvamento no Google Drive.</p>
            </div>
            <div class="flex items-center gap-4 w-full sm:w-auto">
                 <div id="auth-status" class="text-sm text-gray-600 flex-grow"></div>
                 <button id="theme-toggle-button" class="p-2 rounded-md">
                     <svg id="theme-icon-sun" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                     <svg id="theme-icon-moon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                 </button>
                 <button id="google-auth-button" class="py-2 px-4 border rounded-md shadow-sm text-sm font-medium">Login</button>
                 <button id="save-data-button" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">Salvar</button>
            </div>
        </header>

        <div class="mb-8 border-b">
            <nav class="-mb-px flex space-x-2 sm:space-x-4" aria-label="Tabs">
                <a id="tab-despesas" class="tab active">Despesas</a>
                <a id="tab-reservas" class="tab">Reservas</a>
                <a id="tab-orcamentos" class="tab">Or√ßamentos</a>
                <a id="tab-metas" class="tab">Metas</a>
            </nav>
        </div>

        <div id="despesas-view">
            <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <div class="lg:col-span-3 space-y-6">
                    <div class="card">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Adicionar Nova Despesa</h2>
                        <form id="expense-form" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                            <div><label for="date" class="block text-sm font-medium">Data</label><input type="date" id="date" class="mt-1 block w-full rounded-md shadow-sm" required></div>
                            <div><label for="cost-type" class="block text-sm font-medium">Tipo</label><select id="cost-type" class="mt-1 block w-full rounded-md shadow-sm" required><option>Vari√°vel</option><option>Fixo</option></select></div>
                            <div><label for="category" class="block text-sm font-medium">Categoria</label><select id="category" class="mt-1 block w-full rounded-md shadow-sm" required><option>Moradia</option><option>Alimenta√ß√£o</option><option>Transporte</option><option>Lazer</option><option>Sa√∫de</option><option>Vestu√°rio</option><option>Educa√ß√£o</option><option>Outros</option></select></div>
                            <div><label for="payment-type" class="block text-sm font-medium">Pagamento</label><select id="payment-type" class="mt-1 block w-full rounded-md shadow-sm" required><option>Cr√©dito</option><option>D√©bito</option><option>PIX</option></select></div>
                            <div class="sm:col-span-2 md:col-span-2"><label for="description" class="block text-sm font-medium">Onde foi (Descri√ß√£o)</label><input type="text" id="description" class="mt-1 block w-full rounded-md shadow-sm" placeholder="Ex: Supermercado" required></div>
                            <div><label for="bank" class="block text-sm font-medium">Banco</label><select id="bank" class="mt-1 block w-full rounded-md shadow-sm" required><option>Nubank</option><option>Ita√∫</option><option>Bradesco</option><option>Santander</option><option>Banco do Brasil</option><option>Caixa</option><option>Inter</option><option>Outro</option></select></div>
                            <div><label for="amount" class="block text-sm font-medium">Valor (R$)</label><input type="number" step="0.01" id="amount" class="mt-1 block w-full rounded-md shadow-sm" placeholder="150,50" required></div>
                            <div class="sm:col-span-2 md:col-span-4 space-y-3 mt-2"><div class="flex items-center space-x-2"><input type="checkbox" id="is-recurring" class="h-4 w-4 text-indigo-600 border-gray-300 rounded"><label for="is-recurring" class="text-sm font-medium">Despesa Recorrente?</label></div><div id="recurring-options" class="hidden"><label for="recurrence-end-date" class="block text-sm font-medium">Repetir mensalmente at√©:</label><input type="date" id="recurrence-end-date" class="mt-1 block w-full rounded-md shadow-sm"></div></div>
                            <div class="sm:col-span-2 md:col-span-4"><button type="submit" class="w-full sm:w-auto mt-4 justify-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Adicionar Despesa</button></div>
                        </form>
                        <div id="tip-recurring" class="mini-tip">üí° <b>Dica:</b> Marque "Despesa Recorrente" para contas como aluguel ou assinaturas e defina uma data final. O app adicionar√° os gastos futuros automaticamente!<button onclick="dismissTip('tip-recurring')" class="mini-tip-close">&times;</button></div>
                    </div>
                    
                    <div class="card">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-gray-700">Hist√≥rico de Gastos</h2>
                            <button onclick="exportToCsv('expenses')" class="py-1 px-3 border rounded-md shadow-sm text-sm font-medium export-button">Exportar CSV</button>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                            <div><label for="filter-month" class="block text-sm font-medium">Filtrar por M√™s</label><select id="filter-month" class="mt-1 block w-full rounded-md shadow-sm"></select></div>
                            <div><label for="filter-category" class="block text-sm font-medium">Filtrar por Categoria</label><select id="filter-category" class="mt-1 block w-full rounded-md shadow-sm"><option value="all">Todas</option><option>Moradia</option><option>Alimenta√ß√£o</option><option>Transporte</option><option>Lazer</option><option>Sa√∫de</option><option>Vestu√°rio</option><option>Educa√ß√£o</option><option>Outros</option></select></div>
                            <div><label for="filter-payment" class="block text-sm font-medium">Filtrar por Pagamento</label><select id="filter-payment" class="mt-1 block w-full rounded-md shadow-sm"><option value="all">Todos</option><option>Cr√©dito</option><option>D√©bito</option><option>PIX</option></select></div>
                        </div>
                        <div class="overflow-x-auto"><table class="min-w-full responsive-table"><thead class="table-header"><tr><th class="px-6 py-3 text-left text-xs font-medium uppercase">Data</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Descri√ß√£o</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Categoria</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Tipo</th><th class="px-6 py-3 text-right text-xs font-medium uppercase">Valor</th><th class="px-6 py-3 text-right text-xs font-medium uppercase">A√ß√µes</th></tr></thead><tbody id="expense-table-body"></tbody></table></div>
                    </div>
                </div>
    
                <div class="lg:col-span-2 space-y-6">
                    <div class="card"><h3 class="text-lg font-semibold text-gray-700 mb-4">Gerenciar Rendas Mensais</h3><form id="income-form" class="flex items-end gap-2 mb-4"><div class="flex-grow"><label for="income-month" class="block text-sm font-medium">M√™s/Ano</label><input type="month" id="income-month" class="mt-1 block w-full rounded-md shadow-sm" required></div><div><label for="income-amount" class="block text-sm font-medium">Renda (R$)</label><input type="number" step="0.01" id="income-amount" class="mt-1 block w-full rounded-md shadow-sm" required placeholder="6000,00"></div><button type="submit" class="py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Salvar</button></form><div id="monthly-incomes-list" class="text-sm space-y-1"></div></div>
                    <div class="card"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold text-gray-700">Vis√£o Geral</h3><select id="dashboard-month-filter" class="block w-48 rounded-md shadow-sm"></select></div><div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center"><div><h3 class="text-sm font-medium text-gray-500">Gasto Total</h3><p id="total-expenses" class="mt-1 text-2xl font-semibold text-red-500">R$ 0,00</p></div><div><h3 class="text-sm font-medium text-gray-500">Renda Comprometida</h3><p id="income-percentage" class="mt-1 text-2xl font-semibold text-yellow-500">0%</p></div><div><h3 class="text-sm font-medium text-gray-500">Saldo Restante</h3><p id="remaining-balance" class="mt-1 text-2xl font-semibold text-green-500">R$ 0,00</p></div></div></div>
                    <div class="card"><h3 class="text-lg font-semibold text-gray-700">Fixos vs. Vari√°veis</h3><canvas id="cost-type-chart" class="mt-4"></canvas></div>
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Progresso do Or√ßamento</h3>
                        <div id="budget-progress-container" class="space-y-4"></div>
                    </div>
                    <div class="card"><h3 class="text-lg font-semibold text-gray-700 mb-4">Gastos por Categoria</h3><select id="month-select" class="block w-full rounded-md shadow-sm mb-4"></select><canvas id="monthly-category-chart" class="mt-4"></canvas><div id="monthly-analysis-details" class="mt-4 text-sm space-y-1"></div></div>
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-700">Compara√ß√£o de Gastos Mensais</h3>
                        <canvas id="monthly-comparison-chart" class="mt-4"></canvas>
                    </div>
                    <div class="card"><h3 class="text-lg font-semibold text-gray-700 mb-4">An√°lise com IA</h3><button id="gemini-button" class="w-full flex items-center justify-center py-2 px-3 border rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700">‚ú® Gerar Dicas com IA</button><div id="analysis-text" class="text-sm space-y-2 mt-4"><p>Fa√ßa login e salve seus dados para usar a IA.</p></div><div id="tip-ia" class="mini-tip">üí° <b>Dica:</b> Ap√≥s adicionar alguns gastos, clique aqui para receber uma an√°lise financeira personalizada e dicas para economizar!<button onclick="dismissTip('tip-ia')" class="mini-tip-close">&times;</button></div></div>
                </div>
            </main>
        </div>

        <div id="reservas-view" class="hidden">
            <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <div class="lg:col-span-3 space-y-6">
                    <div class="card"><h2 class="text-xl font-semibold text-gray-700 mb-4">Adicionar Nova Reserva</h2>
                        <form id="saving-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div><label for="saving-month" class="block text-sm font-medium">M√™s/Ano</label><input type="month" id="saving-month" class="mt-1 block w-full rounded-md shadow-sm" required></div>
                            <div><label for="saving-type" class="block text-sm font-medium">Tipo</label><select id="saving-type" class="mt-1 block w-full rounded-md shadow-sm" required><option>Reserva de Emerg√™ncia</option><option>Investimentos</option><option>Outros</option></select></div>
                            <div class="sm:col-span-2"><label for="saving-goal-link" class="block text-sm font-medium">Associar a uma Meta (Opcional)</label><select id="saving-goal-link" class="mt-1 block w-full rounded-md shadow-sm"><option value="none">Nenhuma</option></select></div>
                            <div class="sm:col-span-2"><label for="saving-amount" class="block text-sm font-medium">Valor (R$)</label><input type="number" step="0.01" id="saving-amount" class="mt-1 block w-full rounded-md shadow-sm" required placeholder="500,00"></div>
                            <div class="sm:col-span-2"><button type="submit" class="w-full sm:w-auto mt-4 justify-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Adicionar Reserva</button></div>
                        </form>
                    </div>
                    <div class="card">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-gray-700">Hist√≥rico de Reservas</h2>
                            <button onclick="exportToCsv('savings')" class="py-1 px-3 border rounded-md shadow-sm text-sm font-medium export-button">Exportar CSV</button>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="filter-saving-month" class="block text-sm font-medium text-gray-600">Filtrar por M√™s</label>
                                <select id="filter-saving-month" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm"></select>
                            </div>
                            <div>
                                <label for="filter-saving-type" class="block text-sm font-medium text-gray-600">Filtrar por Tipo</label>
                                <select id="filter-saving-type" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                    <option value="all">Todos os Tipos</option>
                                    <option>Reserva de Emerg√™ncia</option>
                                    <option>Investimentos</option>
                                    <option>Outros</option>
                                </select>
                            </div>
                        </div>
                        <div class="overflow-x-auto"><table class="min-w-full responsive-table"><thead class="table-header"><tr><th class="px-6 py-3 text-left text-xs font-medium uppercase">M√™s</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Tipo</th><th class="px-6 py-3 text-right text-xs font-medium uppercase">Valor (R$)</th><th class="px-6 py-3"><span class="sr-only">A√ß√µes</span></th></tr></thead><tbody id="savings-table-body"></tbody></table></div>
                    </div>
                </div>
                <div class="lg:col-span-2 space-y-6">
                    <div class="card text-center"><h3 class="text-lg font-medium text-gray-500">Total Guardado</h3><p id="total-savings" class="mt-1 text-3xl sm:text-4xl font-bold text-green-500">R$ 0,00</p></div>
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-700">Progresso das Metas</h3>
                        <div id="goal-progress-container" class="space-y-4"></div>
                    </div>
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-700">Total por Tipo de Reserva</h3>
                        <canvas id="savings-by-type-chart" class="mt-4"></canvas>
                    </div>
                </div>
            </main>
        </div>
        
        <div id="orcamentos-view" class="hidden">
            <div class="card max-w-2xl mx-auto">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Gerir Or√ßamentos Mensais</h2>
                <p class="text-gray-500 mb-6">Defina o seu limite de gastos para cada categoria no m√™s selecionado.</p>
                <div class="mb-4">
                    <label for="budget-month" class="block text-sm font-medium mb-1">Selecione o M√™s</label>
                    <input type="month" id="budget-month" class="block w-full sm:w-64 rounded-md shadow-sm">
                </div>
                <div id="budget-inputs-container" class="space-y-3 mt-6"></div>
                <button id="save-budget-button" class="w-full sm:w-auto mt-6 justify-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Salvar Or√ßamento</button>
            </div>
        </div>

        <div id="metas-view" class="hidden">
             <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Criar Nova Meta de Poupan√ßa</h2>
                    <p class="text-gray-500 mb-6">D√™ um nome e um valor alvo para o seu objetivo.</p>
                    <form id="goal-form" class="space-y-4">
                        <div>
                             <label for="goal-name" class="block text-sm font-medium">Nome da Meta</label>
                             <input type="text" id="goal-name" class="mt-1 block w-full rounded-md shadow-sm" placeholder="Ex: F√©rias no Jap√£o" required>
                        </div>
                        <div>
                             <label for="goal-target" class="block text-sm font-medium">Valor Alvo (R$)</label>
                             <input type="number" step="0.01" id="goal-target" class="mt-1 block w-full rounded-md shadow-sm" placeholder="15000,00" required>
                        </div>
                        <button type="submit" class="w-full sm:w-auto justify-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Criar Meta</button>
                    </form>
                </div>
                 <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Minhas Metas</h2>
                    <div id="goals-list-container" class="space-y-4"></div>
                 </div>
             </main>
        </div>
    </div>

    <div id="edit-modal" class="modal-overlay">
        <div class="card modal-content">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Editar Despesa</h2>
            <form id="edit-expense-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <input type="hidden" id="edit-expense-id">
                <div><label for="edit-date" class="block text-sm font-medium">Data</label><input type="date" id="edit-date" class="mt-1 block w-full rounded-md shadow-sm" required></div>
                <div><label for="edit-cost-type" class="block text-sm font-medium">Tipo</label><select id="edit-cost-type" class="mt-1 block w-full rounded-md shadow-sm" required><option>Vari√°vel</option><option>Fixo</option></select></div>
                <div><label for="edit-category" class="block text-sm font-medium">Categoria</label><select id="edit-category" class="mt-1 block w-full rounded-md shadow-sm" required><option>Moradia</option><option>Alimenta√ß√£o</option><option>Transporte</option><option>Lazer</option><option>Sa√∫de</option><option>Vestu√°rio</option><option>Educa√ß√£o</option><option>Outros</option></select></div>
                <div><label for="edit-payment-type" class="block text-sm font-medium">Pagamento</label><select id="edit-payment-type" class="mt-1 block w-full rounded-md shadow-sm" required><option>Cr√©dito</option><option>D√©bito</option><option>PIX</option></select></div>
                <div class="sm:col-span-2"><label for="edit-description" class="block text-sm font-medium">Descri√ß√£o</label><input type="text" id="edit-description" class="mt-1 block w-full rounded-md shadow-sm" required></div>
                <div><label for="edit-bank" class="block text-sm font-medium">Banco</label><select id="edit-bank" class="mt-1 block w-full rounded-md shadow-sm" required><option>Nubank</option><option>Ita√∫</option><option>Bradesco</option><option>Santander</option><option>Banco do Brasil</option><option>Caixa</option><option>Inter</option><option>Outro</option></select></div>
                <div><label for="edit-amount" class="block text-sm font-medium">Valor (R$)</label><input type="number" step="0.01" id="edit-amount" class="mt-1 block w-full rounded-md shadow-sm" required></div>
                <div id="edit-recurring-options" class="sm:col-span-2 hidden">
                    <label for="edit-recurrence-scope" class="block text-sm font-medium">Aplicar altera√ß√£o a:</label>
                    <select id="edit-recurrence-scope" class="mt-1 block w-full rounded-md shadow-sm">
                        <option value="single">Apenas esta despesa</option>
                        <option value="future">Esta e as futuras</option>
                        <option value="all">Todas as despesas da s√©rie</option>
                    </select>
                </div>
                <div class="sm:col-span-2 flex justify-end gap-4 mt-4">
                    <button type="button" id="cancel-edit-button" class="py-2 px-4 border rounded-md shadow-sm text-sm font-medium">Cancelar</button>
                    <button type="submit" class="py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- DADOS GLOBAIS ---
        let expenses = [];
        let monthlyIncomes = {};
        let savings = [];
        let budgets = {};
        let savingsGoals = [];
        
        // --- GR√ÅFICOS (inst√¢ncias) ---
        let monthlyCategoryChart, costTypeChart, savingsByTypeChart, monthlyComparisonChart;
        
        // --- CONFIGURA√á√ÉO GOOGLE API ---
        const CLIENT_ID = '164577357008-o68h1qr3h69ik5ot1531f1fvvrl40umr.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyALVa2RTydoXDNsJP6NmtTV6b7zYhFixY0';
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const FILENAME = 'minhas_financas_dados.json';
        
        // ADICIONE SUA API KEY DO GEMINI AQUI
        const GEMINI_API_KEY = 'YOUR_GEMINI_API_KEY_HERE'; // Substitua pela sua API key
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let driveFileId = null;

        // --- FUN√á√ïES DE FORMATA√á√ÉO ---
        const formatCurrency = (value) => `R$ ${typeof value === 'number' ? value.toFixed(2).replace('.', ',') : '0,00'}`;
        const formatDate = (dateString) => { 
            if (!dateString) return '';
            const [y, m, d] = dateString.split('-'); 
            return `${d}/${m}/${y}`; 
        };
        const formatMonthYear = (monthString) => {
            if (!monthString || !monthString.includes('-')) return '';
            const [year, month] = monthString.split('-');
            const date = new Date(year, parseInt(month) - 1);
            const formatted = date.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
            return formatted.charAt(0).toUpperCase() + formatted.slice(1);
        };
        
        // --- FUN√á√ïES DE DADOS (CARREGAR/SALVAR) ---
        function loadDefaultData() {
            expenses = []; 
            monthlyIncomes = {}; 
            savings = []; 
            budgets = {}; 
            savingsGoals = [];
        }

        async function saveDataToDrive() {
            const saveDataButton = document.getElementById('save-data-button');
            if (!saveDataButton) return;
            
            saveDataButton.disabled = true;
            saveDataButton.textContent = 'Salvando...';
            
            const allData = { 
                expenses, 
                monthlyIncomes, 
                savings, 
                budgets, 
                savingsGoals, 
                lastUpdated: new Date().toISOString() 
            };
            
            const dataBlob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
            
            try {
                const formData = new FormData();
                let method, path;
                
                if (driveFileId) {
                    path = `/upload/drive/v3/files/${driveFileId}?uploadType=multipart`;
                    method = 'PATCH';
                    formData.append('metadata', new Blob([JSON.stringify({})], { type: 'application/json' }));
                } else {
                    path = '/upload/drive/v3/files?uploadType=multipart';
                    method = 'POST';
                    const metadata = { name: FILENAME, mimeType: 'application/json' };
                    formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                }
                
                formData.append('file', dataBlob);
                
                const response = await fetch(`https://www.googleapis.com${path}`, {
                    method: method,
                    headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}` },
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw error;
                }
                
                const result = await response.json();
                driveFileId = result.id; 
                saveDataButton.textContent = 'Salvo!';
            } catch (err) {
                console.error("Erro ao salvar no Drive", err);
                saveDataButton.textContent = 'Erro ao Salvar';
                alert('Erro ao salvar dados no Google Drive. Verifique o console para mais detalhes.');
            } finally {
                setTimeout(() => {
                    const currentSaveButton = document.getElementById('save-data-button');
                    if(currentSaveButton) {
                       currentSaveButton.disabled = false;
                       currentSaveButton.textContent = 'Salvar';
                    }
                }, 3000);
            }
        }
        
        async function loadDataFromDrive() {
            const authStatus = document.getElementById('auth-status');
            if (!authStatus) return;
            
            try {
                authStatus.textContent = 'Buscando dados...';
                
                const response = await gapi.client.drive.files.list({ 
                    q: `name='${FILENAME}' and trashed=false`, 
                    spaces: 'drive', 
                    fields: 'files(id, name)' 
                });
                
                if (response.result.files && response.result.files.length > 0) {
                    driveFileId = response.result.files[0].id;
                    
                    const fileResponse = await gapi.client.drive.files.get({ 
                        fileId: driveFileId, 
                        alt: 'media' 
                    });
                    
                    const data = JSON.parse(fileResponse.body);
                    expenses = data.expenses || [];
                    monthlyIncomes = data.monthlyIncomes || {};
                    savings = data.savings || [];
                    budgets = data.budgets || {};
                    savingsGoals = data.savingsGoals || [];
                    authStatus.textContent = 'Dados carregados!';
                } else {
                    driveFileId = null; 
                    loadDefaultData();
                    authStatus.textContent = 'Nenhum arquivo encontrado.';
                }
            } catch (err) {
                console.error('Erro ao carregar dados:', err);
                authStatus.textContent = 'Erro ao carregar dados.';
                loadDefaultData();
            } finally {
                updateAllUI();
                setTimeout(() => { 
                    if (gapi.client.getToken()) {
                        const status = document.getElementById('auth-status');
                        if (status) status.textContent = 'Conectado'; 
                    }
                }, 3000);
            }
        }

        // --- L√ìGICA DE LOGIN (PERSISTENTE E AUTH) ---
        function checkPersistentLogin() {
            const sessionData = localStorage.getItem('googleSession');
            if (!sessionData) return;
            
            const session = JSON.parse(sessionData);
            const now = new Date().getTime();
            const fifteenDaysInMillis = 15 * 24 * 60 * 60 * 1000;
            
            if (now - session.lastSeen > fifteenDaysInMillis) {
                localStorage.removeItem('googleSession');
                return;
            }
            
            session.lastSeen = now;
            localStorage.setItem('googleSession', JSON.stringify(session));
            gapi.client.setToken({ access_token: session.token });
            updateSigninStatus(true);
        }

        function updateSigninStatus(isSignedIn) {
            const authStatus = document.getElementById('auth-status');
            const authButton = document.getElementById('google-auth-button');
            const saveDataButton = document.getElementById('save-data-button');
            const geminiButton = document.getElementById('gemini-button');
            
            if (!authStatus || !authButton || !saveDataButton || !geminiButton) return;
            
            const shouldLoadData = isSignedIn && expenses.length === 0;
            
            if (isSignedIn) {
                authStatus.textContent = 'Conectado';
                authButton.textContent = 'Sair';
                saveDataButton.disabled = false;
                geminiButton.disabled = false;
                
                if (shouldLoadData) {
                    loadDataFromDrive();
                }
            } else {
                authStatus.textContent = 'Desconectado';
                authButton.textContent = 'Fazer Login';
                saveDataButton.disabled = true;
                geminiButton.disabled = true;
                driveFileId = null;
                loadDefaultData();
                updateAllUI();
            }
        }

        function gapiLoaded() { 
            gapi.load('client', initializeGapiClient); 
        }
        
        function gisLoaded() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID, 
                    scope: SCOPES, 
                    callback: (tokenResponse) => {
                        if (tokenResponse.error) { 
                            console.error('Erro no token:', tokenResponse.error);
                            return; 
                        }
                        
                        const session = { 
                            token: tokenResponse.access_token, 
                            lastSeen: new Date().getTime() 
                        };
                        localStorage.setItem('googleSession', JSON.stringify(session));
                        gapi.client.setToken(tokenResponse);
                        updateSigninStatus(true);
                    },
                });
                gisInited = true; 
                maybeEnableButtons();
            } catch(error) {
                console.error('Erro ao inicializar GIS:', error);
            }
        }
        
        async function initializeGapiClient() { 
            try {
                await gapi.client.init({ 
                    apiKey: API_KEY, 
                    discoveryDocs: DISCOVERY_DOCS 
                }); 
                gapiInited = true; 
                maybeEnableButtons();
            } catch(error) {
                console.error('Erro ao inicializar GAPI:', error);
            }
        }
        
        function maybeEnableButtons() { 
            const authButton = document.getElementById('google-auth-button');
            if (!authButton) return;
            
            if (gapiInited && gisInited) { 
                authButton.disabled = false; 
                checkPersistentLogin();
            } 
        }

        // --- L√ìGICA MODAL DE EDI√á√ÉO ---
        window.openEditModal = (id) => {
            const expense = expenses.find(e => e.id === id);
            if (!expense) return;
            
            document.getElementById('edit-expense-id').value = expense.id;
            document.getElementById('edit-date').value = expense.date;
            document.getElementById('edit-cost-type').value = expense.costType;
            document.getElementById('edit-category').value = expense.category;
            document.getElementById('edit-payment-type').value = expense.type;
            document.getElementById('edit-description').value = expense.description;
            document.getElementById('edit-bank').value = expense.bank;
            document.getElementById('edit-amount').value = expense.amount;
            
            const recurringOptions = document.getElementById('edit-recurring-options');
            if (expense.recurrenceId) {
                recurringOptions.classList.remove('hidden');
            } else {
                recurringOptions.classList.add('hidden');
            }
            
            document.getElementById('edit-modal').classList.add('visible');
        }

        // --- L√ìGICA DE OR√áAMENTOS ---
        function renderBudgetInputs(month) {
            const container = document.getElementById('budget-inputs-container');
            if (!container) return;
            
            container.innerHTML = '';
            const categories = ["Moradia", "Alimenta√ß√£o", "Transporte", "Lazer", "Sa√∫de", "Vestu√°rio", "Educa√ß√£o", "Outros"];
            const monthBudgets = budgets[month] || {};
            
            categories.forEach(category => {
                const value = monthBudgets[category] || '';
                const inputGroup = document.createElement('div');
                inputGroup.className = 'grid grid-cols-3 gap-4 items-center';
                inputGroup.innerHTML = `
                    <label for="budget-${category}" class="col-span-1 text-sm font-medium">${category}</label>
                    <div class="col-span-2 relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500 sm:text-sm">R$</span>
                        <input type="number" step="0.01" id="budget-${category}" data-category="${category}" value="${value}" class="pl-10 block w-full rounded-md shadow-sm" placeholder="0,00">
                    </div>
                `;
                container.appendChild(inputGroup);
            });
        }

        function saveBudgets() {
            const month = document.getElementById('budget-month').value;
            if (!month) {
                alert("Por favor, selecione um m√™s.");
                return;
            }
            
            budgets[month] = budgets[month] || {};
            
            document.querySelectorAll('#budget-inputs-container input').forEach(input => {
                const category = input.dataset.category;
                const amount = parseFloat(input.value);
                
                if (amount > 0) {
                    budgets[month][category] = amount;
                } else {
                    delete budgets[month][category];
                }
            });
            
            alert(`Or√ßamento para ${formatMonthYear(month)} salvo com sucesso!`);
            updateAllUI();
        }

        function updateBudgetProgress() {
            const container = document.getElementById('budget-progress-container');
            if (!container) return;
            
            const selectedMonth = document.getElementById('dashboard-month-filter').value;
            
            if (selectedMonth === 'all' || !budgets[selectedMonth] || Object.keys(budgets[selectedMonth]).length === 0) {
                container.innerHTML = `<p class="text-sm text-gray-500">Crie um or√ßamento na aba 'Or√ßamentos' para ver o progresso.</p>`;
                return;
            }
            
            const monthBudgets = budgets[selectedMonth];
            const monthExpenses = expenses.filter(e => e.date.startsWith(selectedMonth));
            
            container.innerHTML = '';
            let contentRendered = false;
            
            Object.keys(monthBudgets).sort().forEach(category => {
                contentRendered = true;
                const budgetAmount = monthBudgets[category];
                const spentAmount = monthExpenses.filter(e => e.category === category).reduce((sum, e) => sum + e.amount, 0);
                const percentage = Math.min((spentAmount / budgetAmount) * 100, 100);
                
                let colorClass = 'budget';
                if (percentage > 75) colorClass += ' yellow';
                if (percentage >= 100) colorClass += ' red';
                
                const progressElement = document.createElement('div');
                progressElement.innerHTML = `
                    <div class="flex justify-between text-sm mb-1">
                        <span class="font-medium">${category}</span>
                        <span>${formatCurrency(spentAmount)} / ${formatCurrency(budgetAmount)}</span>
                    </div>
                    <div class="progress-bg">
                        <div class="progress-fill ${colorClass}" style="width: ${percentage}%;"></div>
                    </div>
                `;
                container.appendChild(progressElement);
            });
            
            if (!contentRendered) {
                 container.innerHTML = `<p class="text-sm text-gray-500">Nenhum or√ßamento definido para ${formatMonthYear(selectedMonth)}.</p>`;
            }
        }
        
        // --- L√ìGICA DE METAS DE POUPAN√áA ---
        function renderGoalsList() {
            const container = document.getElementById('goals-list-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (savingsGoals.length === 0) {
                container.innerHTML = `<p class="text-sm text-gray-500">Nenhuma meta criada ainda. Crie a sua primeira ao lado!</p>`;
                return;
            }
            
            savingsGoals.forEach(goal => {
                const savedAmount = savings.filter(s => s.goalId === goal.id).reduce((sum, s) => sum + s.amount, 0);
                const percentage = goal.targetAmount > 0 ? Math.min((savedAmount / goal.targetAmount) * 100, 100) : 0;
                
                const goalElement = document.createElement('div');
                goalElement.className = 'p-3 border rounded-md';
                goalElement.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold">${goal.name}</span>
                        <button onclick="deleteGoal(${goal.id})" class="text-red-500 hover:text-red-700 text-xs font-semibold">Excluir</button>
                    </div>
                    <div class="flex justify-between text-sm mb-1">
                        <span>Alcan√ßado: ${formatCurrency(savedAmount)}</span>
                        <span>Meta: ${formatCurrency(goal.targetAmount)}</span>
                    </div>
                    <div class="progress-bg">
                        <div class="progress-fill goal" style="width: ${percentage}%;"></div>
                    </div>
                `;
                container.appendChild(goalElement);
            });
        }

        function populateGoalsDropdown() {
            const select = document.getElementById('saving-goal-link');
            if (!select) return;
            
            select.innerHTML = '<option value="none">Nenhuma</option>';
            savingsGoals.forEach(goal => {
                const option = new Option(`${goal.name} (${formatCurrency(goal.targetAmount)})`, goal.id);
                select.add(option);
            });
        }
        
        function updateGoalProgress() {
            const container = document.getElementById('goal-progress-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (savingsGoals.length === 0) {
                 container.innerHTML = `<p class="text-sm text-gray-500">Crie uma meta na aba 'Metas' para ver o progresso aqui.</p>`;
                 return;
            }
            
            savingsGoals.forEach(goal => {
                 const savedAmount = savings.filter(s => s.goalId === goal.id).reduce((sum, s) => sum + s.amount, 0);
                 const percentage = goal.targetAmount > 0 ? Math.min((savedAmount / goal.targetAmount) * 100, 100) : 0;
                 
                 const progressElement = document.createElement('div');
                 progressElement.innerHTML = `
                    <div class="flex justify-between text-sm mb-1">
                        <span class="font-medium">${goal.name}</span>
                        <span>${percentage.toFixed(1)}%</span>
                    </div>
                    <div class="progress-bg">
                        <div class="progress-fill goal" style="width: ${percentage}%;"></div>
                    </div>
                 `;
                 container.appendChild(progressElement);
            });
        }
        
        // --- L√ìGICA DE ATUALIZA√á√ÉO DA INTERFACE (UI) ---
        function updateAllUI() {
            renderMonthlyIncomes();
            applyFiltersAndRenderExpenses();
            updateExpensesDashboard();
            updateSavingsDashboard();
            applySavingsFiltersAndRender();
            updateMonthlyComparisonChart();
            updateBudgetProgress();
            updateGoalProgress();
        }

        function renderMonthlyIncomes() {
            const listEl = document.getElementById('monthly-incomes-list');
            if (!listEl) return;
            
            listEl.innerHTML = '';
            Object.keys(monthlyIncomes).sort().reverse().forEach(month => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-gray-50 p-2 rounded';
                div.innerHTML = `<span>${formatMonthYear(month)}: <strong>${formatCurrency(monthlyIncomes[month])}</strong></span> <button onclick="deleteIncome('${month}')" class="text-red-500 hover:text-red-700 text-xs font-semibold">Excluir</button>`;
                listEl.appendChild(div);
            });
        }
        
        function updateExpensesDashboard() {
            const uniqueMonths = [...new Set(expenses.map(e => e.date.substring(0, 7)))].sort().reverse();
            const monthSelects = [
                document.getElementById('month-select'), 
                document.getElementById('dashboard-month-filter'), 
                document.getElementById('filter-month')
            ];
            
            monthSelects.forEach(select => {
                if (!select) return;
                
                const currentVal = select.value;
                select.innerHTML = '<option value="all">Todos os Meses</option>';
                uniqueMonths.forEach(m => select.add(new Option(formatMonthYear(m), m)));
                select.value = uniqueMonths.includes(currentVal) ? currentVal : (select.id === 'filter-month' ? 'all' : uniqueMonths[0] || 'all');
            });
            
            const monthAnalysisSelect = document.getElementById('month-select');
            if (monthAnalysisSelect && monthAnalysisSelect.options.length > 0 && monthAnalysisSelect.options[0]?.value === 'all') {
                 monthAnalysisSelect.remove(0);
            }
            
            if (monthAnalysisSelect && !uniqueMonths.includes(monthAnalysisSelect.value)) {
                monthAnalysisSelect.value = uniqueMonths[0] || '';
            }
            
            updateSummaryCards();
            updateMonthlyAnalysis();
            updateCostTypeAnalysis();
        }

        function updateSummaryCards() {
            const filter = document.getElementById('dashboard-month-filter')?.value || 'all';
            const relevantExpenses = filter === 'all' ? expenses : expenses.filter(e => e.date.startsWith(filter));
            const relevantIncome = filter === 'all' ? Object.values(monthlyIncomes).reduce((s, i) => s + i, 0) : monthlyIncomes[filter] || 0;
            const total = relevantExpenses.reduce((s, e) => s + e.amount, 0);
            
            const totalExpensesEl = document.getElementById('total-expenses');
            const incomePercentageEl = document.getElementById('income-percentage');
            const remainingBalanceEl = document.getElementById('remaining-balance');
            
            if (totalExpensesEl) totalExpensesEl.textContent = formatCurrency(total);
            if (incomePercentageEl) incomePercentageEl.textContent = `${(relevantIncome > 0 ? (total / relevantIncome) * 100 : 0).toFixed(1)}%`;
            if (remainingBalanceEl) remainingBalanceEl.textContent = formatCurrency(relevantIncome - total);
        }

        function updateMonthlyAnalysis() {
            const select = document.getElementById('month-select');
            const detailsEl = document.getElementById('monthly-analysis-details');
            
            if (!select || !detailsEl) return;
            
            if (!select.value) {
                if(monthlyCategoryChart) monthlyCategoryChart.destroy();
                detailsEl.innerHTML = '';
                return;
            }
            
            const monthly = expenses.filter(e => e.date.startsWith(select.value));
            const categoryData = monthly.reduce((acc, {category, amount}) => ({...acc, [category]: (acc[category] || 0) + amount}), {});
            
            let detailsHtml = `<strong>Resumo de ${formatMonthYear(select.value)}:</strong><ul class="list-disc ml-4 mt-2">`;
            Object.entries(categoryData).sort(([,a],[,b]) => b-a).forEach(([cat, amt]) => detailsHtml += `<li>${cat}: <strong>${formatCurrency(amt)}</strong></li>`);
            detailsEl.innerHTML = detailsHtml + '</ul>';
            
            if (monthlyCategoryChart) monthlyCategoryChart.destroy();
            
            const canvas = document.getElementById('monthly-category-chart');
            if (canvas) {
                monthlyCategoryChart = new Chart(canvas, {
                    type: 'pie', 
                    data: { 
                        labels: Object.keys(categoryData), 
                        datasets: [{ 
                            data: Object.values(categoryData), 
                            backgroundColor: ['#4f46e5', '#ec4899', '#f59e0b', '#10b981', '#ef4444', '#3b82f6', '#8b5cf6'] 
                        }] 
                    },
                    options: { 
                        responsive: true, 
                        plugins: { 
                            legend: { position: 'top' } 
                        } 
                    }
                });
            }
        }
        
        function updateCostTypeAnalysis() {
            const filter = document.getElementById('dashboard-month-filter')?.value || 'all';
            const relevantExpenses = filter === 'all' ? expenses : expenses.filter(e => e.date.startsWith(filter));
            const costData = relevantExpenses.reduce((acc, {costType, amount}) => {
                acc[costType] = (acc[costType] || 0) + amount;
                return acc;
            }, { 'Fixo': 0, 'Vari√°vel': 0 });
            
            if (costTypeChart) costTypeChart.destroy();
            
            const canvas = document.getElementById('cost-type-chart');
            if (canvas) {
                costTypeChart = new Chart(canvas, {
                    type: 'pie',
                    data: { 
                        labels: Object.keys(costData), 
                        datasets: [{ 
                            data: Object.values(costData), 
                            backgroundColor: ['#3b82f6', '#f59e0b'] 
                        }] 
                    },
                    options: { 
                        responsive: true, 
                        plugins: { 
                            legend: { position: 'top' } 
                        } 
                    }
                });
            }
        }
        
        function applySavingsFiltersAndRender() {
            const monthFilterEl = document.getElementById('filter-saving-month');
            const typeFilterEl = document.getElementById('filter-saving-type');
            
            if (!monthFilterEl || !typeFilterEl) return;
            
            const monthFilter = monthFilterEl.value;
            const typeFilter = typeFilterEl.value;
            
            if (monthFilter === 'all' && typeFilter === 'all') {
                renderSavingsTable([]);
                return;
            }
            
            let filteredSavings = [...savings];
            
            if (monthFilter !== 'all') {
                filteredSavings = filteredSavings.filter(s => s.month === monthFilter);
            }
            
            if (typeFilter !== 'all') {
                filteredSavings = filteredSavings.filter(s => s.type === typeFilter);
            }
            
            renderSavingsTable(filteredSavings);
        }

        function renderSavingsTable(savingsToRender) {
            const savingsTableBody = document.getElementById('savings-table-body');
            if (!savingsTableBody) return;
            
            savingsTableBody.innerHTML = '';
            
            if (savingsToRender.length === 0) {
                const message = "Use os filtros acima para ver o hist√≥rico de reservas.";
                savingsTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-10 text-gray-500">${message}</td></tr>`;
                return;
            }
            
            savingsToRender.sort((a, b) => b.month.localeCompare(a.month)).forEach(saving => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="M√™s" class="px-6 py-4 whitespace-nowrap text-sm font-medium">${formatMonthYear(saving.month)}</td>
                    <td data-label="Tipo" class="px-6 py-4 whitespace-nowrap text-sm">${saving.type}</td>
                    <td data-label="Valor" class="px-6 py-4 whitespace-nowrap text-sm text-green-500 text-right font-semibold">${formatCurrency(saving.amount)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium actions-cell">
                        <button onclick="deleteSaving(${saving.id})" class="text-red-600 hover:text-red-900">Excluir</button>
                    </td>
                `;
                savingsTableBody.appendChild(row);
            });
        }

        function updateSavingsDashboard() {
            const total = savings.reduce((sum, s) => sum + s.amount, 0);
            const totalSavingsEl = document.getElementById('total-savings');
            if (totalSavingsEl) totalSavingsEl.textContent = formatCurrency(total);
            
            const uniqueMonths = [...new Set(savings.map(s => s.month))].sort().reverse();
            const monthFilterEl = document.getElementById('filter-saving-month');
            
            if (monthFilterEl) {
                const currentMonthVal = monthFilterEl.value;
                monthFilterEl.innerHTML = '<option value="all">Todos os Meses</option>';
                uniqueMonths.forEach(m => monthFilterEl.add(new Option(formatMonthYear(m), m)));
                monthFilterEl.value = currentMonthVal;
            }
            
            const byTypeData = savings.reduce((acc, {type, amount}) => ({...acc, [type]: (acc[type] || 0) + amount}), {});
            
            if (savingsByTypeChart) savingsByTypeChart.destroy();
            
            const canvas = document.getElementById('savings-by-type-chart');
            if (canvas) {
                savingsByTypeChart = new Chart(canvas, {
                    type: 'bar',
                    data: { 
                        labels: Object.keys(byTypeData), 
                        datasets: [{ 
                            label: 'Total Guardado',
                            data: Object.values(byTypeData), 
                            backgroundColor: ['#10b981', '#f59e0b', '#3b82f6', '#8b5cf6']
                        }] 
                    },
                    options: { 
                        responsive: true,
                        scales: { y: { beginAtZero: true } },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }
        
        function renderExpenseTable(expensesToRender) {
            const expenseTableBody = document.getElementById('expense-table-body');
            if (!expenseTableBody) return;
            
            expenseTableBody.innerHTML = '';
            
            if (expensesToRender.length === 0) {
                const filterMonth = document.getElementById('filter-month')?.value;
                const filterCategory = document.getElementById('filter-category')?.value;
                const filterPayment = document.getElementById('filter-payment')?.value;
                
                const isFiltered = filterMonth !== 'all' || filterCategory !== 'all' || filterPayment !== 'all';
                const message = isFiltered ? "Nenhum resultado para os filtros." : "Use os filtros para ver o hist√≥rico.";
                expenseTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-gray-500">${message}</td></tr>`;
                return;
            }
            
            expensesToRender.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(expense => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Data">${formatDate(expense.date)}</td>
                    <td data-label="Descri√ß√£o">${expense.description}</td>
                    <td data-label="Categoria">${expense.category}</td>
                    <td data-label="Tipo">${expense.costType}</td>
                    <td data-label="Valor" class="text-red-500 font-medium">${formatCurrency(expense.amount)}</td>
                    <td data-label="A√ß√µes" class="actions-cell">
                        <button onclick="openEditModal(${expense.id})" class="text-blue-600 hover:text-blue-900">Editar</button>
                        <button onclick="deleteExpense(${expense.id})" class="text-red-600 hover:text-red-900">Excluir</button>
                    </td>
                `;
                expenseTableBody.appendChild(row);
            });
        }
        
        function applyFiltersAndRenderExpenses() {
            const filterMonthEl = document.getElementById('filter-month');
            const filterCategoryEl = document.getElementById('filter-category');
            const filterPaymentEl = document.getElementById('filter-payment');
            
            if (!filterMonthEl || !filterCategoryEl || !filterPaymentEl) return;
            
            const selectedMonth = filterMonthEl.value;
            const selectedCategory = filterCategoryEl.value;
            const selectedPayment = filterPaymentEl.value;
            
            if (selectedMonth === 'all' && selectedCategory === 'all' && selectedPayment === 'all') {
                renderExpenseTable([]);
                return;
            }
            
            let filtered = [...expenses];
            
            if (selectedMonth !== 'all') filtered = filtered.filter(e => e.date.startsWith(selectedMonth));
            if (selectedCategory !== 'all') filtered = filtered.filter(e => e.category === selectedCategory);
            if (selectedPayment !== 'all') filtered = filtered.filter(e => e.type === selectedPayment);
            
            renderExpenseTable(filtered);
        }

        // --- TEMA E DICAS ---
        function applyTheme(theme) {
            const sunIcon = document.getElementById('theme-icon-sun');
            const moonIcon = document.getElementById('theme-icon-moon');
            
            if (!sunIcon || !moonIcon) return;
            
            if (theme === 'dark') {
                document.body.classList.add('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                document.body.classList.remove('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
            
            updateChartTheme();
        }
        
        function toggleTheme() {
            const newTheme = document.body.classList.contains('dark') ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
  <response clipped><NOTE>To save on context only part of this file has been shown to you. You should retry this tool after you have searched inside the file with `grep -n` in order to find the line numbers of what you are looking for.</NOTE>

